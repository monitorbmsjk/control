<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JK BMS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 20%, rgba(120,119,198,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,119,198,0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(120,219,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5em; /* match user3 scale */
            font-weight: 800;
            margin-bottom: 12px;
            background: linear-gradient(45deg, #ffffff, #a8dadc, #457b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(168, 218, 220, 0.3);
            animation: titlePulse 3s ease-in-out infinite alternate;
        }

        @keyframes titlePulse {
            0% { filter: drop-shadow(0 0 20px rgba(168, 218, 220, 0.3)); }
            100% { filter: drop-shadow(0 0 40px rgba(168, 218, 220, 0.6)); }
        }

        .status-bar {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .status-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .status-info {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item.online {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .status-item.offline {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .status-item.charging {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .status-item.discharging {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        .status-item.balancing {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
            color: #8b5cf6;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .device-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .device-name {
            font-size: 14px;
            color: #a78bfa;
            font-weight: 600;
            background: rgba(167, 139, 250, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            border: 1px solid rgba(167, 139, 250, 0.2);
        }

        /* Responsive design for status bar */
        @media (max-width: 768px) {
            .status-bar {
                grid-template-columns: 1fr;
                gap: 16px;
                text-align: center;
            }
            
            .device-info {
                align-items: center;
                justify-content: center;
            }
            
            .status-info {
                justify-content: center;
            }
            
            .status-item {
                font-size: 13px;
                padding: 5px 10px;
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #667eea;
            padding-bottom: 10px;
        }

        .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .unit {
            font-size: 0.8em;
            color: #666;
        }

        .info-section {
            margin-bottom: 15px;
        }
        
        .value {
            padding-bottom: 4px;
            margin-bottom: 0;
        }
        
        .unit {
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .unit:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Monitor (user3-inspired) */
        .monitor-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Left content wider for cell lists */
            grid-template-rows: auto auto auto;
            gap: 25px;
            margin-bottom: 30px;
        }

        #monitor-tab .card {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        #monitor-tab .card h3 {
            color: #e5e7eb;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        /* Professional card headings (secondary) */
        .card h4 {
            margin: 10px 0 12px 0;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: .02em;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .main-metrics { grid-column: 1 / 3; grid-row: 1; }
        .cell-voltages { grid-column: 1; grid-row: 2; }
        .cell-resistances { grid-column: 1; grid-row: 3; }
        .temperature-panel { grid-column: 2; grid-row: 2; }
        .capacity-info { grid-column: 2; grid-row: 3; }
        .status-indicators { grid-column: 2; grid-row: 4; }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        /* Force 2 columns for main metrics to avoid odd layout */
        .main-metrics .metric-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Force two columns for cell statistics when space allows */
        .capacity-info .metric-grid {
            grid-template-columns: repeat(2, minmax(160px, 1fr));
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-item::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .metric-item:hover::before { left: 100%; }

        .metric-item:hover {
            transform: translateY(-3px);
            border-color: rgba(168, 218, 220, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .metric-label {
            font-size: 0.95em; /* closer to user3 */
            color: #94a3b8;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .metric-value {
            font-size: 2.4em; /* closer to user3 emphasis */
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .metric-unit {
            font-size: 0.8em;
            color: #a3b3c6;
            font-weight: 500;
        }

        /* Cell tiles tweaked to user3 look while keeping classes from user1 */
        .cell-voltages .cell-grid,
        .cell-resistances .cell-grid {
            max-height: 420px;
            overflow-y: auto;
            padding-right: 6px; /* room for scrollbar */
        }
        #monitor-tab .cell-grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        #monitor-tab .cell {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #fff;
        }

        #monitor-tab .cell::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #64748b, #475569);
            border-radius: 12px 12px 0 0;
        }

        #monitor-tab .cell:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        #monitor-tab .cell.active {
            border-color: rgba(34, 197, 94, 0.3);
        }

        #monitor-tab .cell.active::before {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        #monitor-tab .cell.voltage-high {
            border-color: rgba(239, 68, 68, 0.5);
            animation: voltageWarning 1s ease-in-out infinite alternate;
        }

        #monitor-tab .cell.voltage-high::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        #monitor-tab .cell.voltage-low {
            border-color: rgba(245, 158, 11, 0.5);
            animation: voltageWarning 1.2s ease-in-out infinite alternate;
        }

        #monitor-tab .cell.voltage-low::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        @keyframes voltageWarning { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }

        #monitor-tab .cell-value { color: #fff; font-size: 1.05em; }
        #monitor-tab .cell-number { color: #94a3b8; }

        /* Responsive */
        @media (max-width: 1200px) {
            .monitor-grid { grid-template-columns: 1fr; }
            .main-metrics { grid-column: 1; }
            .cell-voltages { grid-column: 1; }
            .cell-resistances { grid-column: 1; }
            .temperature-panel { grid-column: 1; }
            .capacity-info { grid-column: 1; }
            .status-indicators { grid-column: 1; }
            .capacity-info .metric-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .monitor-grid { grid-template-columns: 1fr; }
        }
        .separator {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 0;
            border-radius: 1px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }

        .status.online { background: #4CAF50; color: white; }
        .status.offline { background: #f44336; color: white; }
        .status.charging { background: #2196F3; color: white; }
        .status.discharging { background: #FF9800; color: white; }
        .status.balancing { background: #9C27B0; color: white; }

        .cell-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .cell {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid transparent;
        }

        .cell.active {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .cell.voltage-high {
            border-color: #f44336;
            background: #ffebee;
        }

        .cell.voltage-low {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .cell-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        .cell-number {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 18px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
            backdrop-filter: blur(8px);
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(99,102,241,.2), rgba(59,130,246,.2));
            color: #e5e7eb;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(99,102,241,.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(239,68,68,.25), rgba(220,38,38,.25));
            color: #fee2e2;
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(239,68,68,.3);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(16,185,129,.25), rgba(5,150,105,.25));
            color: #d1fae5;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16,185,129,.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, rgba(245,158,11,.25), rgba(234,88,12,.25));
            color: #fff7ed;
        }

        .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(245,158,11,.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: linear-gradient(135deg, rgba(14,165,233,.25), rgba(59,130,246,.25));
            color: #e0f2fe;
        }

        .btn-info:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(14,165,233,.3);
        }

        /* Control sections layout */
        .control-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }
        .control-section {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
        }
        .control-section h4 {
            text-align: center;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
        }
        .control-section .controls { flex-wrap: wrap; gap: 10px; }
        @media (max-width: 900px) { .control-sections { grid-template-columns: 1fr; } }

        /* Settings Tab Redesign */
        .settings-form {
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .settings-section {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px; /* smaller padding to match compact content */
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
        }
        
        .settings-section h3 {
            color: #e5e7eb;
            font-size: 18px; /* phóng to tiêu đề card settings */
            font-weight: 800;
            margin-bottom: 14px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        /* Hide titles for control switch sections to reduce visual noise */
        #power-control-title,
        #battery-management-title,
        #system-settings-title,
        #safety-emergency-title { display: none; }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        /* Keep switch rows in one line: label left, switch right (handled by switch-pairs) */
        /* .form-group:has(.switch-container) { display: block; } - DISABLED to allow grid layout */
        
        .form-group label {
            color: #d1d5db;
            font-size: 15px; /* slightly larger content text */
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* Switch pairs: 2 columns per row inside switch sections */
        .settings-section.switch-pairs .form-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto; /* 4 columns: label1, switch1, label2, switch2 */
            column-gap: 8px; /* small gap between label and switch */
            row-gap: 12px;
            align-items: center;
            padding: 0 16px; /* add horizontal padding to push content away from edges */
        }
        /* Each form-group now spans only one column */
        .settings-section.switch-pairs .form-group {
            display: contents; /* let grid handle the layout */
        }
        
        /* Ensure single-item rows align with multi-item rows */
        .settings-section.switch-pairs .form-row:has(.form-group:only-child) {
            grid-template-columns: 1fr auto 1fr auto; /* same as multi-item rows */
        }
        
        .settings-section.switch-pairs .form-row:has(.form-group:only-child) .form-group:first-child {
            grid-column: 1 / 3; /* span first two columns for label and switch */
        }
        .settings-section.switch-pairs .switch-container { 
            margin-left: 0 !important; 
            margin-right: 0 !important;
            padding: 0 !important;
        }
        /* Alignments per column within each switch row */
        .settings-section.switch-pairs .form-row > .form-group:first-child .switch-container {
            justify-content: flex-start; /* left switch closer to its label */
        }
        .settings-section.switch-pairs .form-row > .form-group:last-child label {
            text-align: right;               /* right label closer to its switch */
            padding-right: 8px;
        }
        
        /* Compact two-card switch list layout */
        .switch-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 18px;
        }
        .switch-card h3 { margin: 0 0 14px 0; }
        .switch-list { display: flex; flex-direction: column; gap: 12px; }
        .switch-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px; border-radius: 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .switch-item .label { font-weight: 600; color: #e5e7eb; }
        .switch-item .switch-container { padding: 0; margin: 0; }

        /* Two-column layout for switch cards */
        .switch-cards-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: 16px;
            align-items: start;
        }
        @media (max-width: 1000px) { .switch-cards-grid { grid-template-columns: 1fr; } }
        .single-card-center { max-width: 860px; margin: 0 auto; }

        /* Emphasis styles */
        .switch-card.emergency {
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255,107,107,0.15);
        }
        .switch-card.emergency h3 { color: #ff6b6b; }

        /* Vibrant ON state for switches */
        .switch input:checked + .slider {
            background: linear-gradient(135deg, #6ee7b7 0%, #10b981 100%);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
        }
        .switch:hover input:checked + .slider {
            box-shadow: 0 0 0 4px rgba(16,185,129,0.28);
        }

        /* OK button states */
        .input-with-button .btn-ok,
        .input-with-button button { opacity: 0.95; }
        .input-with-button .btn-ok:hover,
        .input-with-button button:hover {
            opacity: 1;
            transform: translateY(-1px);
        }

        /* Switch colors by column in Settings: left = purple, right = green */
        .settings-section.switch-pairs .form-row > .form-group:first-child .switch input:checked + .slider {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            box-shadow: 0 0 0 3px rgba(124,58,237,0.28);
        }
        .settings-section.switch-pairs .form-row > .form-group:first-child .switch:hover input:checked + .slider {
            box-shadow: 0 0 0 4px rgba(124,58,237,0.38);
        }
        .settings-section.switch-pairs .form-row > .form-group:last-child .switch input:checked + .slider {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 0 0 3px rgba(34,197,94,0.28);
        }
        .settings-section.switch-pairs .form-row > .form-group:last-child .switch:hover input:checked + .slider {
            box-shadow: 0 0 0 4px rgba(34,197,94,0.38);
        }

        /* Card-based coloring for switch cards: left card = purple, right card = green */
        .switch-cards-grid > .switch-card:nth-child(1) .switch input:checked + .slider {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            box-shadow: 0 0 0 3px rgba(124,58,237,0.28);
        }
        .switch-cards-grid > .switch-card:nth-child(1) .switch:hover input:checked + .slider {
            box-shadow: 0 0 0 4px rgba(124,58,237,0.38);
        }
        .switch-cards-grid > .switch-card:nth-child(2) .switch input:checked + .slider {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 0 0 3px rgba(34,197,94,0.28);
        }
        .switch-cards-grid > .switch-card:nth-child(2) .switch:hover input:checked + .slider {
            box-shadow: 0 0 0 4px rgba(34,197,94,0.38);
        }

        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-with-button input {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 9px 12px; /* slightly tighter */
            color: #e5e7eb;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-with-button input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
            background: rgba(255,255,255,0.12);
        }
        
        .btn-ok {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }
        
        .btn-ok:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }
        
        .stepper {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .input-with-button:hover .stepper,
        .input-with-button:focus-within .stepper {
            opacity: 1;
            pointer-events: all;
        }
        
        .stepper button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #e5e7eb;
            width: 20px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stepper button:first-child {
            border-radius: 4px 4px 0 0;
            border-bottom: none;
        }
        
        .stepper button:last-child {
            border-radius: 0 0 4px 4px;
        }
        
        .stepper button:hover {
            background: rgba(255,255,255,0.2);
            color: #3b82f6;
        }
        
        /* Modern Switch Design */
        .switch {
            position: relative;
            display: inline-block;
            width: 56px; /* match grid column */
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #374151, #1f2937);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 32px;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 2px 8px rgba(0,0,0,0.2);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                0 0 0 2px rgba(255,255,255,0.1);
        }
        
        .slider:after {
            position: absolute;
            content: "OFF";
            color: #9ca3af;
            font-size: 8px;
            font-weight: 600;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.3s ease;
            opacity: 1;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 2px 8px rgba(16,185,129,0.3),
                0 0 0 4px rgba(16,185,129,0.1);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.2),
                0 0 0 2px rgba(16,185,129,0.2);
        }
        
        input:checked + .slider:after {
            content: "ON";
            color: #ffffff;
            left: 8px;
            right: auto;
            opacity: 1;
        }
        
        /* Hover effects */
        .switch:hover .slider {
            transform: scale(1.05);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 4px 12px rgba(0,0,0,0.3);
        }
        
        .switch:hover input:checked + .slider {
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 4px 12px rgba(16,185,129,0.4),
                0 0 0 4px rgba(16,185,129,0.15);
        }
        
        /* Active state */
        .switch:active .slider {
            transform: scale(0.98);
        }
        
        /* Focus state */
        .switch input:focus + .slider {
            outline: none;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 2px 8px rgba(0,0,0,0.2),
                0 0 0 3px rgba(59,130,246,0.3);
        }
        
        .switch input:focus:checked + .slider {
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 2px 8px rgba(16,185,129,0.3),
                0 0 0 3px rgba(59,130,246,0.3);
        }
        
        .switch-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 4px;
            position: relative;
        }
        
        /* Switch label styling */
        .form-group label {
            position: relative;
            padding-right: 0px; /* remove all extra padding near switch */
        }
        
        /* Special switch variants for different functions */
        .switch.power-switch input:checked + .slider {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #f59e0b;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 2px 8px rgba(245,158,11,0.3),
                0 0 0 4px rgba(245,158,11,0.1);
        }
        
        .switch.power-switch:hover input:checked + .slider {
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 4px 12px rgba(245,158,11,0.4),
                0 0 0 4px rgba(245,158,11,0.15);
        }
        
        .switch.safety-switch input:checked + .slider {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 2px 8px rgba(239,68,68,0.3),
                0 0 0 4px rgba(239,68,68,0.1);
        }
        
        .switch.safety-switch:hover input:checked + .slider {
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 4px 12px rgba(239,68,68,0.4),
                0 0 0 4px rgba(239,68,68,0.15);
        }
        
        .switch.system-switch input:checked + .slider {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-color: #8b5cf6;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 2px 8px rgba(139,92,246,0.3),
                0 0 0 4px rgba(139,92,246,0.1);
        }
        
        .switch.system-switch:hover input:checked + .slider {
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.2),
                0 4px 12px rgba(139,92,246,0.4),
                0 0 0 4px rgba(139,92,246,0.15);
        }
        /* ---- Force card-based switch colors (override per-card) ---- */
        /* Left card (1): purple for all types */
        .switch-cards-grid > .switch-card:nth-child(1) .switch.power-switch input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(1) .switch.system-switch input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(1) .switch.active-pulse input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(1) .switch input:checked + .slider {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 2px 8px rgba(124,58,237,0.3), 0 0 0 3px rgba(124,58,237,0.28);
            border-color: #7c3aed;
        }
        .switch-cards-grid > .switch-card:nth-child(1) .switch:hover input:checked + .slider {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 4px 12px rgba(124,58,237,0.4), 0 0 0 4px rgba(124,58,237,0.38);
        }
        /* Right card (2): green for all types */
        .switch-cards-grid > .switch-card:nth-child(2) .switch.power-switch input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(2) .switch.system-switch input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(2) .switch.active-pulse input:checked + .slider,
        .switch-cards-grid > .switch-card:nth-child(2) .switch input:checked + .slider {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 2px 8px rgba(34,197,94,0.3), 0 0 0 3px rgba(34,197,94,0.28);
            border-color: #16a34a;
        }
        .switch-cards-grid > .switch-card:nth-child(2) .switch:hover input:checked + .slider {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 4px 12px rgba(34,197,94,0.4), 0 0 0 4px rgba(34,197,94,0.38);
        }
        
        /* Pulse animation for active switches */
        @keyframes switchPulse {
            0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
            70% { box-shadow: 0 0 0 8px rgba(16,185,129,0); }
            100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
        }
        
        .switch.active-pulse input:checked + .slider {
            animation: switchPulse 2s infinite;
        }
        
        /* Ripple effect on click */
        .switch {
            overflow: hidden;
        }
        
        .switch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: 1;
        }
        
        .switch:active::before {
            width: 100px;
            height: 100px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .settings-section.switch-pairs .form-row { grid-template-columns: 1fr 1fr; }
            
            .settings-section {
                padding: 16px;
            }
            
            .stepper {
                right: 55px;
            }
        }

        .alerts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .alert {
            color: #856404;
            margin: 5px 0;
        }

        /* Device name styling */
        .device-name {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }

        .device-label {
            color: #E0E0E0;
            font-weight: 500;
            font-size: 14px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .device-name { font-size: 14px; }
            .device-label { font-size: 13px; }
            .form-row { grid-template-columns: 1fr; }
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Settings Form */
        .settings-form {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        /* Settings layout grid to mirror monitor */
        .settings-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }
        .settings-left .settings-section,
        .settings-right .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        @media (max-width: 1200px) { .settings-grid { grid-template-columns: 1fr; } }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e5e7eb; /* readable on dark */
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.04);
            color: #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s, background 0.2s;
        }
        /* Hide default number spinners and restyle for consistency */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }

        /* Optional custom steppers */
        .input-with-button { position: relative; }
        .input-with-button input { padding-right: 12px; }
        .input-with-button .stepper {
            position: absolute;
            right: 90px; /* tinh chỉnh để nằm đúng khoảng trống trước nút OK */
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column; 
            gap: 4px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }
        .input-with-button .stepper button {
            width: 22px;
            height: 18px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.08);
            color: #e5e7eb;
            border-radius: 4px;
            line-height: 16px;
            cursor: pointer;
        }
        .input-with-button .stepper button:hover { background: rgba(255,255,255,0.14); }
        .input-with-button:hover .stepper,
        .input-with-button:focus-within .stepper { opacity: 1; pointer-events: auto; }
        @media (max-width: 768px) { .input-with-button .stepper { right: 72px; } }
        .form-group input::placeholder, .form-group select::placeholder { color: #9aa4b2; }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(168, 218, 220, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(260px, 1fr));
            gap: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: #e5e7eb;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.12);
        }

        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn-ok {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            white-space: nowrap;
        }

        .btn-ok:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-ok:active {
            transform: translateY(0);
        }

        .btn-save {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .btn-reset {
            background: #f44336;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .btn-reset:hover {
            background: #d32f2f;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings lock modal */
        .settings-lock-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .settings-lock-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #6366f1;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 92%;
            box-shadow: 0 20px 40px rgba(99,102,241,0.3);
        }

        .settings-lock-title {
            margin-bottom: 16px;
            color: #6366f1;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
        }

        .settings-lock-desc {
            color: #e5e7eb;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .settings-lock-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(99,102,241,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #e5e7eb;
            font-size: 16px;
            margin-bottom: 16px;
            transition: border-color 0.3s ease;
        }

        .settings-lock-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }

        .settings-lock-input::placeholder {
            color: rgba(229,231,235,0.6);
        }

        .settings-lock-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .settings-lock-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .settings-lock-btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }

        .settings-lock-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(99,102,241,0.3);
        }

        .settings-lock-btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e5e7eb;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .settings-lock-btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .settings-lock-error {
            margin-top: 12px;
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }

        /* Toggle switch (unified with modern design above to avoid overrides) */
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #374151, #1f2937);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 32px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 24px; width: 24px;
            left: 2px; bottom: 2px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
        }
        input:checked + .slider { background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Language selector styles */
        .lang-selector {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000; /* always on top */
        }
        .lang-flag {
            width: 22px;
            height: 16px;
            display: inline-block;
            border-radius: 2px;
            overflow: hidden;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .lang-flag svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .lang-select {
            min-width: 140px;
            background: transparent;
            color: #fff;
            border: none;
            outline: none;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            z-index: 1001;
        }
        .lang-select option {
            background: rgba(255,255,255,0.95);
            color: #333;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .cell-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-content">
        <div class="header">
            <div style="position: relative;">
                <div style="position: absolute; top: 0; right: 0;">
                    <div class="lang-selector">
                        <span id="lang-flag" class="lang-flag" aria-hidden="true"></span>
                        <select id="language-selector" class="lang-select">
                            <option value="vi">Tiếng Việt</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                <h1>JK BMS </h1>
                <p id="header-subtitle">Hệ thống giám sát và điều khiển BMS</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('monitor')"> Thông số pin </button>
            <button class="tab-btn" onclick="showTab('settings')">Cài đặt </button>
            <button class="tab-btn" onclick="showTab('notifications')">Thông báo</button>
        </div>

        <div class="status-bar">
            <div class="status-info">
                <div class="status-item" id="connection-status">Đang kết nối...</div>
                <div class="status-item" id="charge-status">Không sạc</div>
                <div class="status-item" id="balance-status">Không cân bằng</div>
                <div class="status-item" id="ip-address">IP: --</div>
            </div>
            <div class="device-info">
                <div class="device-label" id="device-label">Thiết bị</div>
                <div id="device-name-display" class="device-name">--</div>
            </div>
        </div>

        <!-- Monitor Tab Content -->
        <div id="monitor-tab" class="tab-content active">
            <div class="monitor-grid">
                <!-- Main Metrics -->
                <div class="card main-metrics">
                    <h3>Thông số chính</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Điện áp pin (V)</div>
                            <div class="metric-value" id="battery-voltage">--</div>
                </div>
                        <div class="metric-item">
                            <div class="metric-label">Dòng điện (A)</div>
                            <div class="metric-value" id="current">--</div>
                </div>
                        <div class="metric-item">
                            <div class="metric-label">Mức pin (%)</div>
                            <div class="metric-value" id="soc">--</div>
                </div>
                        <div class="metric-item">
                            <div class="metric-label">Công suất (W)</div>
                            <div class="metric-value" id="power">--</div>
            </div>
                        <div class="metric-item">
                            <div class="metric-label">Dung lượng hiện tại (Ah)</div>
                            <div class="metric-value" id="current-capacity">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Dung lượng tối đa (Ah)</div>
                            <div class="metric-value" id="total-capacity">--</div>
                        </div>
                    </div>
            </div>

                <!-- Temperature Panel -->
                <div class="card temperature-panel">
                    <h3>Nhiệt độ</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Cảm biến 1 (°C)</div>
                            <div class="metric-value" id="temp1">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Cảm biến 2 (°C)</div>
                            <div class="metric-value" id="temp2">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">MOS (°C)</div>
                            <div class="metric-value" id="temp-mos">--</div>
                        </div>
                    </div>
            </div>

                <!-- Cell Info -->
                <div class="card capacity-info">
                    <h3>Thông tin Cell</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Điện áp thấp nhất (V)</div>
                            <div class="metric-value" id="min-voltage">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Điện áp cao nhất (V)</div>
                            <div class="metric-value" id="max-voltage">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Điện áp trung bình (V)</div>
                            <div class="metric-value" id="avg-voltage">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Chênh lệch điện áp (V)</div>
                            <div class="metric-value" id="delta-voltage">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Điện trở thấp nhất (mΩ)</div>
                            <div class="metric-value" id="min-resistance">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Điện trở cao nhất (mΩ)</div>
                            <div class="metric-value" id="max-resistance">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Điện trở trung bình (mΩ)</div>
                            <div class="metric-value" id="avg-resistance">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Chênh lệch điện trở (mΩ)</div>
                            <div class="metric-value" id="delta-resistance">--</div>
                        </div>
                    </div>
        </div>

        <!-- Cell Voltages -->
                <div class="card cell-voltages">
                    <h3>Điện áp Cell</h3>
                    <div class="cell-grid" id="cell-grid"></div>
        </div>

        <!-- Cell Resistances -->
                <div class="card cell-resistances">
                    <h3>Điện trở Cell</h3>
                    <div class="cell-grid" id="res-grid"></div>
        </div>

                <!-- Controls -->
                <div class="card status-indicators">
                    <h3>Điều khiển mô-đun cầu nối BMS</h3>
                    <div class="control-sections">
                        <div class="control-section">
                            <h4 id="safety-title">An toàn hệ thống</h4>
            <div class="controls">
                                <button id="btn-emergency" class="btn btn-danger" onclick="openEmergencyConfirm()"><span id="emergency-text">Dừng khẩn cấp</span></button>
                                <button id="btn-recover" class="btn btn-success" style="display:none;" onclick="openRecoverConfirm()"><span id="recover-text">Khởi động lại BMS</span></button>
                            </div>
                        </div>
                        <div class="control-section">
                            <h4 id="system-title">Hoạt động của hệ thống</h4>
                            <div class="controls" style="justify-content:center; gap:12px;">
                                <button class="btn btn-warning" onclick="enterSetupMode()"><span id="setup-text">Chế độ thiết lập</span></button>
                                <button class="btn btn-info" onclick="powerCycleDevice()"><span id="power-cycle-text">Khởi động lại nguồn (5s)</span></button>
                            </div>
                        </div>
            </div>
                </div>

        </div>

        <!-- Emergency confirm modal -->
        <div id="modal-emergency" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #ff4757; border-radius:16px; padding:24px; max-width:480px; width:92%; box-shadow: 0 20px 40px rgba(255,71,87,0.3);">
                <h3 style="margin-bottom:16px; color:#ff4757; font-size:20px; font-weight:600; text-align:center;" id="emergency-modal-title">Xác nhận dừng khẩn cấp</h3>
                <p style="color:#e5e7eb; line-height:1.6; margin-bottom:20px; text-align:center;" id="emergency-modal-desc">Hệ thống sẽ tắt sạc, xả, cân bằng, sưởi và bật chế độ khẩn cấp để đảm bảo an toàn.</p>
                <div style="display:flex; gap:12px; justify-content:center;">
                    <button class="btn btn-secondary" onclick="closeEmergencyConfirm()" style="padding:10px 20px; border-radius:8px;" id="emergency-cancel-btn">Hủy</button>
                    <button class="btn btn-danger" onclick="confirmEmergency()" style="padding:10px 20px; border-radius:8px; background:linear-gradient(135deg, #ff4757, #ff3742);" id="emergency-confirm-btn">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Recover confirm modal -->
        <div id="modal-recover" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #10b981; border-radius:16px; padding:24px; max-width:580px; width:92%; box-shadow: 0 20px 40px rgba(16,185,129,0.3);">
                <h3 style="margin-bottom:16px; color:#10b981; font-size:20px; font-weight:600; text-align:center;" id="recover-modal-title">Khởi động lại BMS</h3>
                <p style="color:#e5e7eb; line-height:1.6; margin-bottom:20px; text-align:center;" id="recover-modal-desc">Chọn trạng thái cần phục hồi. Mặc định khôi phục theo trước khi dừng khẩn cấp.</p>
                <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <label>MOSFET sạc
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-charge" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>MOSFET xả
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-discharge" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>Bộ cân bằng
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-balancer" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>Sưởi ấm
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-heating" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div style="margin-top:20px; display:flex; gap:12px; justify-content:center;">
                    <button class="btn btn-secondary" onclick="closeRecoverConfirm()" style="padding:10px 20px; border-radius:8px;" id="recover-cancel-btn">Hủy</button>
                    <button class="btn btn-success" onclick="confirmRecover()" style="padding:10px 20px; border-radius:8px; background:linear-gradient(135deg, #10b981, #059669);" id="recover-confirm-btn">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Setup Mode confirm modal -->
        <div id="modal-setup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #f59e0b; border-radius:16px; padding:24px; max-width:480px; width:92%; box-shadow: 0 20px 40px rgba(245,158,11,0.3);">
                <h3 style="margin-bottom:16px; color:#f59e0b; font-size:20px; font-weight:600; text-align:center;" id="setup-modal-title">Chế độ thiết lập</h3>
                <p style="color:#e5e7eb; line-height:1.6; margin-bottom:20px; text-align:center;" id="setup-modal-desc">ESP32 sẽ khởi động lại và tạo WiFi "ESP32-BMS-Setup" để cấu hình.</p>
                <div style="display:flex; gap:12px; justify-content:center;">
                    <button class="btn btn-secondary" onclick="closeSetupConfirm()" style="padding:10px 20px; border-radius:8px;" id="setup-cancel-btn">Hủy</button>
                    <button class="btn btn-warning" onclick="confirmSetup()" style="padding:10px 20px; border-radius:8px; background:linear-gradient(135deg, #f59e0b, #d97706);" id="setup-confirm-btn">Xác nhận</button>
            </div>
        </div>
        </div>

        <!-- Power Cycle confirm modal -->
        <div id="modal-power-cycle" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #14b8a6; border-radius:16px; padding:24px; max-width:480px; width:92%; box-shadow: 0 20px 40px rgba(20,184,166,0.3);">
                <h3 style="margin-bottom:16px; color:#14b8a6; font-size:20px; font-weight:600; text-align:center;" id="power-cycle-modal-title">Khởi động lại nguồn</h3>
                <p style="color:#e5e7eb; line-height:1.6; margin-bottom:20px; text-align:center;" id="power-cycle-modal-desc">Thiết bị sẽ tạm ngắt nguồn 5 giây rồi bật lại để khởi động lại hoàn toàn.</p>
                <div style="display:flex; gap:12px; justify-content:center;">
                    <button class="btn btn-secondary" onclick="closePowerCycleConfirm()" style="padding:10px 20px; border-radius:8px;" id="power-cycle-cancel-btn">Hủy</button>
                    <button class="btn btn-info" onclick="confirmPowerCycle()" style="padding:10px 20px; border-radius:8px; background:linear-gradient(135deg, #14b8a6, #0d9488);" id="power-cycle-confirm-btn">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Recover Success modal -->
        <div id="modal-recover-success" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #10b981; border-radius:16px; padding:24px; max-width:480px; width:92%; box-shadow: 0 20px 40px rgba(16,185,129,0.3);">
                <h3 style="margin-bottom:16px; color:#10b981; font-size:20px; font-weight:600; text-align:center;" id="recover-success-title">✅ Khôi phục thành công</h3>
                <p style="color:#e5e7eb; line-height:1.6; margin-bottom:20px; text-align:center;" id="recover-success-desc">Đã gửi lệnh khôi phục BMS qua MQTT. Hệ thống sẽ khôi phục các chức năng đã chọn.</p>
                <div style="display:flex; gap:12px; justify-content:center;">
                    <button class="btn btn-success" onclick="closeRecoverSuccess()" style="padding:12px 24px; border-radius:8px; background:linear-gradient(135deg, #10b981, #059669); font-size:16px; font-weight:600;" id="recover-success-btn">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Alerts block moved to Notifications tab (kept here intentionally empty) -->
        </div>

        <!-- Settings Password Modal -->
        <div id="settings-lock-modal" class="settings-lock-modal" style="display:none;">
            <div class="settings-lock-content">
                <h3 class="settings-lock-title" id="settings-lock-title">🔒 Mở khóa cài đặt</h3>
                <p class="settings-lock-desc" id="settings-lock-desc">Vui lòng nhập mật khẩu để truy cập vào phần cài đặt hệ thống.</p>
                <input type="password" id="settings-password" class="settings-lock-input" placeholder="Nhập mật khẩu" onkeypress="if(event.key==='Enter') unlockSettings()" />
                <div class="settings-lock-buttons">
                    <button class="settings-lock-btn settings-lock-btn-secondary" onclick="closeSettingsLock()" id="settings-lock-cancel">Hủy</button>
                    <button class="settings-lock-btn settings-lock-btn-primary" onclick="unlockSettings()" id="settings-lock-unlock">Mở khóa</button>
                </div>
                <div id="settings-lock-error" class="settings-lock-error"></div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings-tab" class="tab-content">
            <!-- Settings will be shown here when unlocked -->
            <div class="settings-form" id="settings-form" style="display:none;">
                <div class="settings-section">
                    <h3> Điện áp</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-overvoltage" class="tooltip-container">
                                Ngưỡng cao áp cell (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tối đa cho phép của mỗi cell. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-overvoltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-overvoltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-overvoltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_overvoltage', 'cell-overvoltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-overvoltage-recovery" class="tooltip-container">
                                Khôi phục cao áp (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi cell giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá điện áp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-overvoltage-recovery" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-overvoltage-recovery', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-overvoltage-recovery', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_overvoltage_recovery', 'cell-overvoltage-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-undervoltage" class="tooltip-container">
                                Ngưỡng thấp áp cell (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tối thiểu cho phép của mỗi cell. Khi xuống dưới mức này, BMS sẽ ngắt xả để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-undervoltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-undervoltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-undervoltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_undervoltage', 'cell-undervoltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-undervoltage-recovery" class="tooltip-container">
                                Khôi phục thấp áp (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi cell tăng lên trên mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do điện áp thấp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-undervoltage-recovery" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-undervoltage-recovery', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-undervoltage-recovery', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_undervoltage_recovery', 'cell-undervoltage-recovery')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="balance-trigger-voltage" class="tooltip-container">
                                Ngưỡng cân bằng (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp bắt đầu cân bằng các cell. Khi cell nào vượt quá ngưỡng này, BMS sẽ bắt đầu cân bằng để giảm điện áp của cell đó.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="balance-trigger-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('balance-trigger-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('balance-trigger-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('balance_trigger_voltage', 'balance-trigger-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="balance-start-voltage" class="tooltip-container">
                                Điện áp bắt đầu cân bằng (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp chính xác để bắt đầu cân bằng. Thường thấp hơn ngưỡng cân bằng một chút để tránh cân bằng không cần thiết.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="balance-start-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('balance-start-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('balance-start-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('balance_start_voltage', 'balance-start-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-soc100-voltage" class="tooltip-container">
                                Điện áp khi pin 100% (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tương ứng với mức pin 100%. Dùng để tính toán chính xác mức pin còn lại.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-soc100-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-soc100-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-soc100-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_soc100_voltage', 'cell-soc100-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-soc0-voltage" class="tooltip-container">
                                Điện áp khi pin 0% (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tương ứng với mức pin 0%. Dùng để tính toán chính xác mức pin còn lại.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-soc0-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-soc0-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-soc0-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_soc0_voltage', 'cell-soc0-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-request-charge-voltage" class="tooltip-container">
                                Điện áp yêu cầu sạc (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mục tiêu khi sạc đầy. BMS sẽ ngừng sạc khi đạt đến điện áp này.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-request-charge-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-request-charge-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-request-charge-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_request_charge_voltage', 'cell-request-charge-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-request-float-voltage" class="tooltip-container">
                                Điện áp duy trì (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp duy trì sau khi sạc đầy. Thấp hơn điện áp sạc để tránh quá sạc và tăng tuổi thọ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-request-float-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-request-float-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('cell-request-float-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_request_float_voltage', 'cell-request-float-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="smart-sleep-voltage" class="tooltip-container">
                                Điện áp ngủ thông minh (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="smart-sleep-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('smart-sleep-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('smart-sleep-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('smart_sleep_voltage', 'smart-sleep-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="power-off-voltage" class="tooltip-container">
                                Điện áp tắt nguồn (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi pin xuống dưới mức này, BMS sẽ tắt hoàn toàn để bảo vệ pin khỏi xả quá sâu.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="power-off-voltage" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('power-off-voltage', 0.001)">▲</button><button type="button" onclick="stepNumber('power-off-voltage', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('power_off_voltage', 'power-off-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-count" class="tooltip-container">
                                Số lượng cell
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tổng số cell lithium trong bộ pin. Ví dụ: 16 cell cho pin 48V.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-count" step="1" min="2" max="32">
                                <div class="stepper"><button type="button" onclick="stepNumber('cell-count', 1)">▲</button><button type="button" onclick="stepNumber('cell-count', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('cell_count', 'cell-count')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="capacity" class="tooltip-container">
                                Tổng dung lượng (Ah)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tổng dung lượng của bộ pin tính bằng Ampere-giờ. Ví dụ: 100Ah cho pin 48V 100Ah.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="capacity" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('capacity', 0.1)">▲</button><button type="button" onclick="stepNumber('capacity', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('capacity', 'capacity')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3> Dòng điện</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max-balance-current" class="tooltip-container">
                                Dòng cân bằng tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa được sử dụng để cân bằng các cell. Dòng cao hơn sẽ cân bằng nhanh hơn nhưng tiêu thụ nhiều năng lượng hơn.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="max-balance-current" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('max-balance-current', 0.1)">▲</button><button type="button" onclick="stepNumber('max-balance-current', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('max_balance_current', 'max-balance-current')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-current" class="tooltip-container">
                                Dòng sạc tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa cho phép khi sạc pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng sạc.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-current" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-current', 0.1)">▲</button><button type="button" onclick="stepNumber('charge-current', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_current', 'charge-current')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-current" class="tooltip-container">
                                Dòng xả tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa cho phép khi xả pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng xả.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-current" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-current', 0.1)">▲</button><button type="button" onclick="stepNumber('discharge-current', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_current', 'discharge-current')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="current-calibration" class="tooltip-container">
                                Hiệu chuẩn dòng điện
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến dòng điện. Dùng để bù trừ sai số đo.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="current-calibration" step="0.001">
                                <div class="stepper"><button type="button" onclick="stepNumber('current-calibration', 0.001)">▲</button><button type="button" onclick="stepNumber('current-calibration', -0.001)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('current_calibration', 'current-calibration')">OK</button>
                        </div>
                    </div>
                </div>
                </div>

                <div class="settings-section">
                    <h3> Thời gian & Độ trễ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-ocp-delay-s" class="tooltip-container">
                                Độ trễ quá dòng sạc (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ quá dòng sạc. Cho phép dòng tăng đột ngột tạm thời.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-ocp-delay-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-ocp-delay-s', 1)">▲</button><button type="button" onclick="stepNumber('charge-ocp-delay-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_ocp_delay_s', 'charge-ocp-delay-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-ocpr-time-s" class="tooltip-container">
                                Thời gian khôi phục quá dòng sạc (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép sạc lại sau khi đã ngắt do quá dòng sạc.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-ocpr-time-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-ocpr-time-s', 1)">▲</button><button type="button" onclick="stepNumber('charge-ocpr-time-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_ocpr_time_s', 'charge-ocpr-time-s')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-ocp-delay-s" class="tooltip-container">
                                Độ trễ quá dòng xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ quá dòng xả. Cho phép dòng tăng đột ngột tạm thời.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-ocp-delay-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-ocp-delay-s', 1)">▲</button><button type="button" onclick="stepNumber('discharge-ocp-delay-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_ocp_delay_s', 'discharge-ocp-delay-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="discharge-ocpr-time-s" class="tooltip-container">
                                Thời gian khôi phục quá dòng xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép xả lại sau khi đã ngắt do quá dòng xả.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-ocpr-time-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-ocpr-time-s', 1)">▲</button><button type="button" onclick="stepNumber('discharge-ocpr-time-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_ocpr_time_s', 'discharge-ocpr-time-s')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scp-delay-us" class="tooltip-container">
                                Độ trễ bảo vệ ngắn mạch (μs)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ ngắn mạch. Thời gian rất ngắn để phát hiện ngắn mạch nhanh.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="scp-delay-us" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('scp-delay-us', 1)">▲</button><button type="button" onclick="stepNumber('scp-delay-us', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('scp_delay_us', 'scp-delay-us')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="scp-recovery-time-s" class="tooltip-container">
                                Thời gian khôi phục ngắn mạch (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép hoạt động lại sau khi đã ngắt do ngắn mạch.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="scp-recovery-time-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('scp-recovery-time-s', 1)">▲</button><button type="button" onclick="stepNumber('scp-recovery-time-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('scp_recovery_time_s', 'scp-recovery-time-s')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="request-charge-voltage-time-h" class="tooltip-container">
                                Thời gian điện áp sạc (h)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian duy trì điện áp sạc trước khi chuyển sang điện áp duy trì.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="request-charge-voltage-time-h" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('request-charge-voltage-time-h', 0.1)">▲</button><button type="button" onclick="stepNumber('request-charge-voltage-time-h', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('request_charge_voltage_time_h', 'request-charge-voltage-time-h')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="request-float-voltage-time-h" class="tooltip-container">
                                Thời gian điện áp duy trì (h)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian duy trì điện áp float sau khi sạc đầy.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="request-float-voltage-time-h" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('request-float-voltage-time-h', 0.1)">▲</button><button type="button" onclick="stepNumber('request-float-voltage-time-h', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('request_float_voltage_time_h', 'request-float-voltage-time-h')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-precharge-time-s" class="tooltip-container">
                                Thời gian sạc trước xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian sạc nhẹ trước khi cho phép xả pin để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-precharge-time-s" step="1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-precharge-time-s', 1)">▲</button><button type="button" onclick="stepNumber('discharge-precharge-time-s', -1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_precharge_time_s', 'discharge-precharge-time-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="voltage-calibration" class="tooltip-container">
                                Hiệu chuẩn điện áp
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến điện áp. Dùng để bù trừ sai số đo.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="voltage-calibration" step="0.01">
                                <button class="btn-ok" onclick="saveSingleSetting('voltage_calibration', 'voltage-calibration')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3> Nhiệt độ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao khi sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép khi sạc pin. Vượt quá mức này sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-overtemp" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-overtemp', 0.1)">▲</button><button type="button" onclick="stepNumber('charge-overtemp', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_overtemp', 'charge-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá nhiệt.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-overtemp-recovery" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-overtemp-recovery', 0.1)">▲</button><button type="button" onclick="stepNumber('charge-overtemp-recovery', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_overtemp_recovery', 'charge-overtemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao khi xả (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép khi xả pin. Vượt quá mức này sẽ ngắt xả để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-overtemp" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-overtemp', 0.1)">▲</button><button type="button" onclick="stepNumber('discharge-overtemp', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_overtemp', 'discharge-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="discharge-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ xả (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do quá nhiệt.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-overtemp-recovery" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('discharge-overtemp-recovery', 0.1)">▲</button><button type="button" onclick="stepNumber('discharge-overtemp-recovery', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_overtemp_recovery', 'discharge-overtemp-recovery')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-undertemp" class="tooltip-container">
                                Nhiệt độ quá thấp khi sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối thiểu cho phép khi sạc pin. Dưới mức này sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-undertemp" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-undertemp', 0.1)">▲</button><button type="button" onclick="stepNumber('charge-undertemp', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_undertemp', 'charge-undertemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-undertemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ thấp sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi tăng lên trên mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ thấp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-undertemp-recovery" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('charge-undertemp-recovery', 0.1)">▲</button><button type="button" onclick="stepNumber('charge-undertemp-recovery', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('charge_undertemp_recovery', 'charge-undertemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mos-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao MOSFET (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép của MOSFET. Vượt quá mức này sẽ ngắt hoạt động để bảo vệ MOSFET.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="mos-overtemp" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('mos-overtemp', 0.1)">▲</button><button type="button" onclick="stepNumber('mos-overtemp', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('mos_overtemp', 'mos-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mos-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ MOSFET (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép hoạt động lại sau khi đã ngắt do quá nhiệt MOSFET.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="mos-overtemp-recovery" step="0.1">
                                <div class="stepper"><button type="button" onclick="stepNumber('mos-overtemp-recovery', 0.1)">▲</button><button type="button" onclick="stepNumber('mos-overtemp-recovery', -0.1)">▼</button></div>
                                <button class="btn-ok" onclick="saveSingleSetting('mos_overtemp_recovery', 'mos-overtemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="switch-cards-grid">
                    <!-- Power Control Section (card 1) -->
                    <div class="switch-card">
                        <h3 id="power-control-title">Công tắc điều khiển</h3>
                        <div class="switch-list">
                            <div class="switch-item">
                                <div class="label">MOSFET sạc</div>
                                <div class="switch-container"><label class="switch power-switch"><input type="checkbox" id="charge-mosfet-on" onchange="saveSwitch('charge_mosfet_on', 'charge-mosfet-on')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">MOSFET xả</div>
                                <div class="switch-container"><label class="switch power-switch"><input type="checkbox" id="discharge-mosfet-on" onchange="saveSwitch('discharge_mosfet_on', 'discharge-mosfet-on')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">Disable Temperature Sensors</div>
                                <div class="switch-container"><label class="switch system-switch"><input type="checkbox" id="disable-temperature-sensors" onchange="saveSwitch('disable_temperature_sensors', 'disable-temperature-sensors')"><span class="slider"></span></label></div>
                    </div>
                            <div class="switch-item">
                                <div class="label">Display Always On</div>
                                <div class="switch-container"><label class="switch system-switch"><input type="checkbox" id="display-always-on" onchange="saveSwitch('display_always_on', 'display-always-on')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">Smart Sleep</div>
                                <div class="switch-container"><label class="switch system-switch"><input type="checkbox" id="smart-sleep-on" onchange="saveSwitch('smart_sleep_on', 'smart-sleep-on')"><span class="slider"></span></label></div>
                        </div>
                            
                    </div>
                </div>

                    <!-- Battery Management Section (card 2) -->
                    <div class="switch-card">
                        <h3 id="battery-management-title">Quản lý pin</h3>
                        <div class="switch-list">
                            <div class="switch-item">
                                <div class="label">Bộ cân bằng</div>
                                <div class="switch-container"><label class="switch active-pulse"><input type="checkbox" id="balancer-on" onchange="saveSwitch('balancer_on', 'balancer-on')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">Sưởi ấm</div>
                                <div class="switch-container"><label class="switch"><input type="checkbox" id="heating-on" onchange="saveSwitch('heating_on', 'heating-on')"><span class="slider"></span></label></div>
                    </div>
                            <div class="switch-item">
                                <div class="label">Chế độ float sạc</div>
                                <div class="switch-container"><label class="switch"><input type="checkbox" id="charging-float-mode" onchange="saveSwitch('charging_float_mode', 'charging-float-mode')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">Lưu dữ liệu theo thời gian</div>
                                <div class="switch-container"><label class="switch"><input type="checkbox" id="timed-stored-data" onchange="saveSwitch('timed_stored_data', 'timed-stored-data')"><span class="slider"></span></label></div>
                        </div>
                            <div class="switch-item">
                                <div class="label">Tắt module PCL</div>
                                <div class="switch-container"><label class="switch system-switch"><input type="checkbox" id="disable-pcl-module" onchange="saveSwitch('disable_pcl_module', 'disable-pcl-module')"><span class="slider"></span></label></div>
                    </div>
                        </div>
                        </div>
                    </div>

                <!-- removed separate system settings card (merged above) -->

                <!-- Safety & Emergency Section - centered single card -->
                <div class="single-card-center">
                    <div class="switch-card emergency">
                        <h3 id="safety-emergency-title">Chế độ khẩn cấp</h3>
                        <div class="switch-list">
                            <div class="switch-item">
                                <div class="label">Emergency Mode</div>
                                <div class="switch-container"><label class="switch safety-switch"><input type="checkbox" id="emergency-mode" onchange="saveSwitch('emergency_mode', 'emergency-mode')"><span class="slider"></span></label></div>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Notifications Tab Content -->
        <div id="notifications-tab" class="tab-content" style="display:none;">
            <div class="card">
                <h3 id="alerts-title">Cảnh báo</h3>
                <div class="alerts" id="alerts">
                    <div class="alert" id="no-alerts-text">Không có cảnh báo</div>
                </div>
            </div>
        </div>

                <div style="text-align: center; margin-top: 30px;">
                    <span id="settings-msg" style="color:#f44336;font-weight:bold;"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Remove emoji/icons from some texts but keep them for control buttons
        function stripEmojis() {
            const strip = s => s.replace(/[\u2190-\u21FF\u2300-\u23FF\u2600-\u27BF\u1F000-\u1FAFF]/g, '').replace(/\s{2,}/g,' ').trim();
            // Only strip emojis from specific elements, not control buttons
            const nodes = document.querySelectorAll('h1,h2,h3,.unit,label,.status,.tab-btn');
            nodes.forEach(n=>{ if(n && n.textContent){ n.textContent = strip(n.textContent); } });
        }
        let autoRefresh = true;
        let refreshInterval;

        // MQTT Configuration
        const mqttConfig = {
            host: 'broker.hivemq.com',
            port: 8884, // WebSocket port
            path: '/mqtt',
            clientId: 'bms_dashboard_' + Math.random().toString(16).substr(2, 8),
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30 * 1000,
            keepalive: 60
        };

        // MQTT Global variables
        let mqttClient = null;
        let selectedDeviceId = '';
        let resolvedDevice = false;
        let devices = new Map(); // deviceId -> deviceData
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // Update device name display
        function updateDeviceNameDisplay() {
            const deviceDisplay = document.getElementById('device-name-display');
            if (deviceDisplay) {
                deviceDisplay.textContent = selectedDeviceId;
            }
        }

        // Resolve device ID without HTTP dependency (works on GitHub Pages)
        function getUrlParam(name){
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        function updateDeviceId() {
            // Priority: URL ?device=... → localStorage; NO discovery for VIP user
            const fromUrl = getUrlParam('device');
            if (fromUrl) { selectedDeviceId = fromUrl; resolvedDevice = true; localStorage.setItem('setup_device_id', fromUrl); }
            if (!resolvedDevice){
                const saved = localStorage.getItem('setup_device_id') || localStorage.getItem('selectedDeviceId');
                if (saved){ selectedDeviceId = saved; resolvedDevice = true; }
            }
            const disp = document.getElementById('device-name-display');
            if (disp) disp.textContent = selectedDeviceId || '--';
            console.log('🎯 Using device id (URL/localStorage only):', selectedDeviceId || '(none)');
        }



        // Handle Enter key in password input and initialize global password overlay
        document.addEventListener('DOMContentLoaded', function() {
            // Resolve device ID from URL/localStorage (no HTTP)
            updateDeviceId();
            // Keep emojis for better UI - don't strip them
            // stripEmojis();
            
            // Initialize language selector
            initializeLanguageSelector();
            
            // Update device name display
            updateDeviceNameDisplay();
            
            // Initialize app immediately (no password required)
            initializeApp();
            
            // Setup settings if already unlocked
            if (settingsUnlocked()) {
                if (document.getElementById('settings-tab').classList.contains('active')) {
                    hideSettingsLock();
                    loadSettings();
                }
            }
        });

        // Initialize app after password is entered
        function initializeApp() {
            // Only connect MQTT if we have a resolved device id
            if (selectedDeviceId){
                connectMQTT();
            } else {
                console.warn('❌ No device id found (URL/localStorage). VIP will not auto-discover.');
            }
        }

        // MQTT Connection
        function connectMQTT() {
            try {
                console.log('🔌 Attempting MQTT connection...');
                const url = `wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;
                console.log('🌐 MQTT URL:', url);
                
                mqttClient = mqtt.connect(url, {
                    clientId: mqttConfig.clientId,
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 30000,
                    keepalive: 60
                });

                mqttClient.on('connect', () => {
                    console.log('✅ MQTT kết nối thành công!');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    
                    // Subscribe only to the configured device topics (no discovery for VIP)
                    if (!selectedDeviceId){
                        console.error('❌ No device id at connect time; not subscribing.');
                        return;
                    }
                    subscribeDeviceTopics(selectedDeviceId);
                    
                    // Request data/settings will be triggered after device resolution
                });

                mqttClient.on('message', (topic, message) => {
                    // VIP user: do not auto-select by discovery; process only for selectedDeviceId
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', (error) => {
                    console.error('MQTT error:', error);
                    updateConnectionStatus(false);
                });

                mqttClient.on('close', () => {
                    console.log('MQTT kết nối đóng');
                    updateConnectionStatus(false);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(connectMQTT, 5000);
                    }
                });

            } catch (error) {
                console.error('Lỗi kết nối MQTT:', error);
                updateConnectionStatus(false);
            }
        }

        // Handle MQTT Messages
        function handleMQTTMessage(topic, message) {
            try {
                console.log(`📨 Received MQTT: ${topic} -> ${message.substring(0, 100)}...`);
                const topicParts = topic.split('/');
                const deviceId = topicParts[1];
                const messageType = topicParts[2];

                console.log(`🔍 Parsed topic - Device: ${deviceId}, Type: ${messageType}`);

                if (deviceId === selectedDeviceId) {
                    console.log(`✅ Processing message for selected device: ${selectedDeviceId}`);
                    switch (messageType) {
                        case 'data':
                            console.log('📊 Processing data message...');
                            const data = JSON.parse(message);
                            console.log('📊 Data received:', data);
                updateUI(data);
                            break;
                        case 'status':
                            const status = JSON.parse(message);
                            updateDeviceStatus(status);
                            break;
                        case 'online':
                            updateConnectionStatus(message === 'online');
                            break;
                        case 'settings':
                            console.log('📋 Received settings from BMS:', message);
                            const settings = JSON.parse(message);
                            console.log('📋 Parsed settings object:', settings);
                            console.log('📋 Settings keys:', Object.keys(settings));
                            updateSettingsUI(settings);
                            break;
                        case 'switches':
                            console.log('🔌 Received switches from BMS:', message);
                            const switches = JSON.parse(message);
                            updateSwitchesUI(switches);
                            break;
                    }
                }
            } catch (error) {
                console.error('Lỗi xử lý tin nhắn MQTT:', error);
            }
        }

        // Request data from device
        function requestData() {
            if (mqttClient && mqttClient.connected) {
                const topic = `bms/${selectedDeviceId}/cmd/action`;
                console.log(`📤 Publishing get_data command to: ${topic}`);
                mqttClient.publish(topic, 'get_data', { qos: 1 });
                console.log(`✅ Đã gửi lệnh get_data tới ${topic}`);
            } else {
                console.log('❌ MQTT client not connected, cannot request data');
            }
        }


        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'Đã kết nối';
                statusElement.className = 'status-item online';
            } else {
                statusElement.textContent = 'Mất kết nối';
                statusElement.className = 'status-item offline';
            }
        }

        // Update device status
        function updateDeviceStatus(status) {
            console.log('📡 Updating device status:', status);
            // Update IP address if available
            if (status.wifi_ssid) {
                document.getElementById('ip-address').textContent = `WiFi: ${status.wifi_ssid}`;
            }
            if (status.ip_address) {
                document.getElementById('ip-address').textContent = `IP: ${status.ip_address}`;
            }
        }

        // Update settings UI
        function updateSettingsUI(settings) {
            console.log('🔧 Updating settings UI with data:', settings);
            
            let updatedCount = 0;
            let missingCount = 0;
            
            // Helper function to safely update input values
            const updateInput = (id, value, defaultValue) => {
                const element = document.getElementById(id);
                if (element) {
                    const newValue = value ?? defaultValue;
                    element.value = newValue;
                    console.log(`✅ Updated ${id}: ${newValue}`);
                    updatedCount++;
                } else {
                    console.warn(`❌ Element not found: ${id}`);
                    missingCount++;
                }
            };
            
            // Voltages với giá trị mặc định
            updateInput('cell-overvoltage', settings.cell_overvoltage, '3.650');
            updateInput('cell-overvoltage-recovery', settings.cell_overvoltage_recovery, '3.500');
            updateInput('cell-undervoltage', settings.cell_undervoltage, '3.000');
            updateInput('cell-undervoltage-recovery', settings.cell_undervoltage_recovery, '3.100');
            updateInput('balance-trigger-voltage', settings.balance_trigger_voltage, '3.400');
            updateInput('balance-start-voltage', settings.balance_start_voltage, '3.350');
            updateInput('cell-soc100-voltage', settings.cell_soc100_voltage, '3.600');
            updateInput('cell-soc0-voltage', settings.cell_soc0_voltage, '3.000');
            updateInput('cell-request-charge-voltage', settings.cell_request_charge_voltage, '3.400');
            updateInput('cell-request-float-voltage', settings.cell_request_float_voltage, '3.350');
            updateInput('smart-sleep-voltage', settings.smart_sleep_voltage, '3.200');
            updateInput('power-off-voltage', settings.power_off_voltage, '2.800');
            updateInput('cell-count', settings.cell_count, '16');
            updateInput('capacity', settings.capacity, '280.0');
            
            // Currents/calibration với giá trị mặc định
            updateInput('max-balance-current', settings.max_balance_current, '0.080');
            updateInput('charge-current', settings.charge_current, '50.0');
            updateInput('discharge-current', settings.discharge_current, '50.0');
            updateInput('current-calibration', settings.current_calibration, '0.0');
            
            // Times với giá trị mặc định
            updateInput('charge-ocp-delay-s', settings.charge_ocp_delay_s, '10');
            updateInput('charge-ocpr-time-s', settings.charge_ocpr_time_s, '10');
            updateInput('discharge-ocp-delay-s', settings.discharge_ocp_delay_s, '10');
            updateInput('discharge-ocpr-time-s', settings.discharge_ocpr_time_s, '10');
            updateInput('scp-delay-us', settings.scp_delay_us, '1000');
            updateInput('scp-recovery-time-s', settings.scp_recovery_time_s, '10');
            updateInput('request-charge-voltage-time-h', settings.request_charge_voltage_time_h, '1');
            updateInput('request-float-voltage-time-h', settings.request_float_voltage_time_h, '1');
            updateInput('discharge-precharge-time-s', settings.discharge_precharge_time_s, '5');
            updateInput('voltage-calibration', settings.voltage_calibration, '0.0');
            
            // Temps với giá trị mặc định
            updateInput('charge-overtemp', settings.charge_overtemp, '60');
            updateInput('charge-overtemp-recovery', settings.charge_overtemp_recovery, '50');
            updateInput('discharge-overtemp', settings.discharge_overtemp, '70');
            updateInput('discharge-overtemp-recovery', settings.discharge_overtemp_recovery, '60');
            updateInput('charge-undertemp', settings.charge_undertemp, '-10');
            updateInput('charge-undertemp-recovery', settings.charge_undertemp_recovery, '0');
            updateInput('mos-overtemp', settings.mos_overtemp, '80');
            updateInput('mos-overtemp-recovery', settings.mos_overtemp_recovery, '70');
            
            console.log(`✅ Settings UI updated from MQTT - Updated: ${updatedCount}, Missing: ${missingCount}`);
        }

        // Update switches UI
        function updateSwitchesUI(switches) {
            console.log('🔧 Updating switches UI with data:', switches);
            const setc = (id, val) => { 
                const el = document.getElementById(id); 
                if (el) el.checked = !!val; 
            };
            
            setc('charge-mosfet-on', switches.charge_mosfet_on);
            setc('discharge-mosfet-on', switches.discharge_mosfet_on);
            setc('balancer-on', switches.balancer_on);
            setc('heating-on', switches.heating_on);
            setc('disable-temperature-sensors', switches.disable_temperature_sensors);
            setc('display-always-on', switches.display_always_on);
            setc('smart-sleep-on', switches.smart_sleep_on);
            setc('disable-pcl-module', switches.disable_pcl_module);
            setc('timed-stored-data', switches.timed_stored_data);
            setc('charging-float-mode', switches.charging_float_mode);
            setc('emergency-mode', switches.emergency_mode);
            
            console.log('Switches UI updated from MQTT');
        }

        // Cập nhật UI
        function updateUI(data) {
            console.log('🎨 Updating UI with data:', data);
            console.log('🔍 Data fields available:', Object.keys(data));
            console.log('📊 Key values - v:', data.v, 'i:', data.i, 'soc:', data.soc, 'p:', data.p);
            // Cập nhật trạng thái kết nối (MQTT data không có trường connected)
            updateConnectionStatus(true);

            // Cập nhật trạng thái emergency buttons
            if (data.emergency_active !== undefined) {
                setEmergencyButtons(data.emergency_active);
            }

            // Cập nhật thông tin chính
            const voltageEl = document.getElementById('battery-voltage');
            const currentEl = document.getElementById('current');
            const socEl = document.getElementById('soc');
            const powerEl = document.getElementById('power');
            
            console.log('🔍 Elements found:', {
                voltage: !!voltageEl,
                current: !!currentEl,
                soc: !!socEl,
                power: !!powerEl
            });
            
            if (voltageEl) voltageEl.textContent = data.v || '--';
            if (currentEl) currentEl.textContent = data.i || '--';
            if (socEl) socEl.textContent = data.soc || '--';
            if (powerEl) powerEl.textContent = data.p || '--';
            
            // Cập nhật dung lượng trong card thông tin chính
            const currentCapacityEl = document.getElementById('current-capacity');
            const totalCapacityEl = document.getElementById('total-capacity');
            if (currentCapacityEl) currentCapacityEl.textContent = (data.cap_cur ?? '--') === '--' ? '--' : (+data.cap_cur).toFixed(2);
            if (totalCapacityEl) totalCapacityEl.textContent = (data.cap_tot ?? '--') === '--' ? '--' : (+data.cap_tot).toFixed(2);
            
            console.log('✅ Updated main values:', {
                voltage: data.v,
                current: data.i,
                soc: data.soc,
                power: data.p,
                currentCapacity: data.cap_cur,
                totalCapacity: data.cap_tot
            });

            // Cập nhật nhiệt độ
            document.getElementById('temp1').textContent = data.t1 || '--';
            document.getElementById('temp2').textContent = data.t2 || '--';
            document.getElementById('temp-mos').textContent = data.temp_mos || '--';

            // Cập nhật thông tin cell (min_v, max_v, avg_v đã là Volt)
            console.log('🔋 Cell voltage summary:', {
                min_v: data.min_v,
                max_v: data.max_v,
                avg_v: data.avg_v,
                delta_voltage: data.delta_voltage
            });
            document.getElementById('min-voltage').textContent = data.min_v ? data.min_v.toFixed(3) : '--';
            document.getElementById('max-voltage').textContent = data.max_v ? data.max_v.toFixed(3) : '--';
            document.getElementById('avg-voltage').textContent = data.avg_v ? data.avg_v.toFixed(3) : '--';
            
            // Tính delta voltage từ max - min
            const deltaV = (typeof data.min_v === 'number' && typeof data.max_v === 'number') ? (data.max_v - data.min_v) : undefined;
            document.getElementById('delta-voltage').textContent = (typeof deltaV === 'number') ? deltaV.toFixed(3) : '--';


            // Cập nhật cell voltages
            console.log('🔋 Cell voltages data (cv):', data.cv);
            console.log('🔋 Cell voltages converted to V:', data.cv ? data.cv.map(v => (v/1000).toFixed(3)) : 'No data');
            updateCellVoltages(data.cv || []);
            // Cập nhật cell resistances
            console.log('⚡ Cell resistances data (cr):', data.cr);
            updateCellResistances(data);

            // Cập nhật trạng thái
            updateStatus(data);

            // Cập nhật cảnh báo
            updateAlerts(data.alerts || []);
        }

        // Cập nhật trạng thái kết nối
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.textContent = '🟢 Online';
                status.className = 'status-item online';
            } else {
                status.textContent = '🔴 Offline';
                status.className = 'status-item offline';
            }
            
            // IP address sẽ được cập nhật từ MQTT status message
        }

        // Cập nhật cell voltages
        function updateCellVoltages(cellVoltages) {
            console.log('🔋 Updating cell voltages:', cellVoltages);
            const grid = document.getElementById('cell-grid');
            if (!grid) {
                console.log('❌ Cell grid element not found');
                return;
            }
            grid.innerHTML = '';

            cellVoltages.forEach((voltage, index) => {
                if (voltage > 0) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    // Thêm class dựa trên voltage (chuyển đổi từ mV sang V)
                    const voltageV = voltage / 1000;
                    if (voltageV > 3.65) cell.classList.add('voltage-high');
                    else if (voltageV < 3.0) cell.classList.add('voltage-low');
                    else cell.classList.add('active');

                    cell.innerHTML = `
                        <div class="cell-number">Cell ${index + 1}</div>
                        <div class="cell-value">${(voltage / 1000).toFixed(3)}V</div>
                    `;
                    grid.appendChild(cell);
                }
            });
        }

        // Cập nhật cell resistances
        function updateCellResistances(data) {
            console.log('⚡ Updating cell resistances with data:', data);
            const grid = document.getElementById('res-grid');
            if (!grid) {
                console.log('❌ Resistance grid element not found');
                return;
            }
            grid.innerHTML = '';
            const resistances = data.cr || [];
            console.log('⚡ Cell resistances array:', resistances);
            const minR = data.min_r;
            const maxR = data.max_r;
            const avgR = data.avg_r;
            
            // Tính delta resistance từ max - min (như dashboard.html)
            const deltaR = (typeof data.delta_r === 'number') ? data.delta_r : ((minR != null && maxR != null) ? (maxR - minR) : undefined);
            
            console.log('⚡ Resistance values:', { minR, maxR, avgR, deltaR });

            // Cập nhật các giá trị tổng quan
            const minEl = document.getElementById('min-resistance');
            const maxEl = document.getElementById('max-resistance');
            const avgEl = document.getElementById('avg-resistance');
            const deltaEl = document.getElementById('delta-resistance');
            if (minEl) minEl.textContent = (minR !== undefined && minR > 0) ? minR.toFixed(3) : '--';
            if (maxEl) maxEl.textContent = (maxR !== undefined && maxR > 0) ? maxR.toFixed(3) : '--';
            if (avgEl) avgEl.textContent = (avgR !== undefined && avgR > 0) ? avgR.toFixed(3) : '--';
            if (deltaEl) deltaEl.textContent = (deltaR !== undefined && deltaR >= 0) ? deltaR.toFixed(3) : '--';

            // Hiển thị từng cell
            resistances.forEach((r, index) => {
                if (r > 0) {
                    const cell = document.createElement('div');
                    cell.className = 'cell active';
                    cell.innerHTML = `
                        <div class="cell-number">Cell ${index + 1}</div>
                        <div class="cell-value">${r.toFixed(3)} mΩ</div>
                    `;
                    grid.appendChild(cell);
                }
            });
        }

        // Cập nhật trạng thái
        function updateStatus(data) {
            console.log('📊 Updating status with data:', {
                chg: data.chg,
                dchg: data.dchg,
                bal: data.bal
            });
            const chargeStatus = document.getElementById('charge-status');
            const balanceStatus = document.getElementById('balance-status');

            // Trạng thái sạc
            const langSelector = document.getElementById('language-selector');
            const currentLang = langSelector ? langSelector.value : 'vi';
            const t = translations[currentLang] || translations['vi'];
            
            if (data.chg) {
                chargeStatus.textContent = t.charging;
                chargeStatus.className = 'status-item charging';
            } else if (data.dchg) {
                chargeStatus.textContent = t.discharging;
                chargeStatus.className = 'status-item discharging';
            } else {
                chargeStatus.textContent = t.not_charging_status;
                chargeStatus.className = 'status-item';
            }

            // Trạng thái cân bằng
            if (data.bal) {
                balanceStatus.textContent = t.balancing;
                balanceStatus.className = 'status-item balancing';
            } else {
                balanceStatus.textContent = t.not_balancing_status;
                balanceStatus.className = 'status-item';
            }
        }

        // Cập nhật cảnh báo
        function updateAlerts(alerts) {
            const alertsContainer = document.getElementById('alerts');
            const langSelector = document.getElementById('language-selector');
            const currentLang = langSelector ? langSelector.value : 'vi';
            const t = translations[currentLang] || translations['vi'];
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `<div class="alert">${t.no_alerts}</div>`;
            } else {
                alertsContainer.innerHTML = alerts.map(alert => 
                    `<div class="alert">⚠️ ${alert}</div>`
                ).join('');
            }
        }

        // Làm mới dữ liệu
        function refreshData() {
            loadData();
        }

        // Bật/tắt tự động làm mới
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                refreshInterval = setInterval(loadData, 500);
            } else {
                clearInterval(refreshInterval);
            }
        }

        // UI: toggle buttons based on emergency state
        function setEmergencyButtons(active){
            const be = document.getElementById('btn-emergency');
            const br = document.getElementById('btn-recover');
            if (!be || !br) return;
            if (active){ be.style.display='none'; br.style.display=''; }
            else { be.style.display=''; br.style.display='none'; }
        }

        // Open/close modals
        function openEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='flex'; } }
        function closeEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='none'; } }
        function openRecoverConfirm(){
            preloadRecoverToggles();
            const m=document.getElementById('modal-recover'); if(m){ m.style.display='flex'; }
        }
        function closeRecoverConfirm(){ const m=document.getElementById('modal-recover'); if(m){ m.style.display='none'; } }

        // Confirm emergency: call backend, then swap button
        async function confirmEmergency(){
            try{
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'emergency_stop', { qos: 1 });
                setEmergencyButtons(true);
                closeEmergencyConfirm();
                    const lang1 = document.getElementById('language-selector').value;
                    alert(lang1 === 'vi' ? 'Đã gửi lệnh dừng khẩn cấp qua MQTT' : 'Emergency stop command sent via MQTT');
                } else {
                    const lang2 = document.getElementById('language-selector').value;
                    alert(lang2 === 'vi' ? 'MQTT chưa kết nối' : 'MQTT not connected');
                }
            }catch(e){
                const lang3 = document.getElementById('language-selector').value;
                alert(lang3 === 'vi' ? 'Lỗi khi dừng khẩn cấp' : 'Error while sending emergency stop');
            }
        }

        // Preload recover modal with snapshot
        async function preloadRecoverToggles(){
            try{
                // Sử dụng dữ liệu switches hiện tại từ MQTT
                    const setc=(id,v)=>{ const el=document.getElementById(id); if(el) el.checked=!!v; };
                
                // Lấy dữ liệu từ các toggle hiện tại
                const chargeEl = document.getElementById('charge-mosfet');
                const dischargeEl = document.getElementById('discharge-mosfet');
                const balancerEl = document.getElementById('balancer');
                const heatingEl = document.getElementById('heating');
                
                if (chargeEl) setc('rcv-charge', chargeEl.checked);
                if (dischargeEl) setc('rcv-discharge', dischargeEl.checked);
                if (balancerEl) setc('rcv-balancer', balancerEl.checked);
                if (heatingEl) setc('rcv-heating', heatingEl.checked);
            }catch(e){ /* ignore */ }
        }

        // Confirm recover: apply selected toggles
        async function confirmRecover(){
            const payload = {
                charge_mosfet_on: document.getElementById('rcv-charge').checked,
                discharge_mosfet_on: document.getElementById('rcv-discharge').checked,
                balancer_on: document.getElementById('rcv-balancer').checked,
                heating_on: document.getElementById('rcv-heating').checked
            };
            try{
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/switches`;
                    mqttClient.publish(topic, JSON.stringify(payload), { qos: 1 });
                    setEmergencyButtons(false);
                    closeRecoverConfirm();
                    openRecoverSuccess();
                } else {
                    const lang5 = document.getElementById('language-selector').value;
                    alert(lang5 === 'vi' ? 'MQTT chưa kết nối' : 'MQTT not connected');
                }
            }catch(e){
                const lang6 = document.getElementById('language-selector').value;
                alert(lang6 === 'vi' ? 'Lỗi khi khôi phục BMS' : 'Error while sending recover command');
            }
        }

        // Vào Setup Mode
        function enterSetupMode() {
            openSetupConfirm();
        }

        function openSetupConfirm() {
            const m = document.getElementById('modal-setup');
            if (m) {
                m.style.display = 'flex';
            }
        }

        function closeSetupConfirm() {
            const m = document.getElementById('modal-setup');
            if (m) {
                m.style.display = 'none';
            }
        }

        async function confirmSetup() {
                try {
                    if (mqttClient && mqttClient.connected) {
                        const topic = `bms/${selectedDeviceId}/cmd/action`;
                        mqttClient.publish(topic, 'enter_setup', { qos: 1 });
                    const lang7 = document.getElementById('language-selector').value;
                    closeSetupConfirm();
                    alert(lang7 === 'vi'
                        ? '✅ Đã gửi lệnh vào Setup Mode qua MQTT!\n\nESP32 sẽ khởi động lại trong 3 giây.\n\nSau đó:\n1. Kết nối WiFi "ESP32-BMS-Setup" (password: 12345678)\n2. Truy cập http://192.168.4.1'
                        : '✅ Setup Mode command sent via MQTT!\n\nESP32 will reboot in 3 seconds.\n\nThen:\n1. Connect WiFi "ESP32-BMS-Setup" (password: 12345678)\n2. Open http://192.168.4.1');
                        
                        // Hiển thị hướng dẫn chi tiết
                        setTimeout(() => {
                            const isVi = document.getElementById('language-selector').value === 'vi';
                            const instructions = isVi ? `
🔧 HƯỚNG DẪN SETUP MODE:

1️⃣ Kết nối WiFi:
   - Tên: ESP32-BMS-Setup
   - Password: 12345678

2️⃣ Truy cập web:
   - Địa chỉ: http://192.168.4.1
   - Hoặc: http://192.168.4.1/setup

3️⃣ Cấu hình:
   - Chọn WiFi của bạn
   - Nhập password WiFi
   - Lưu cấu hình

4️⃣ ESP32 sẽ tự động kết nối WiFi và hoạt động bình thường!
                            ` : `
🔧 SETUP MODE INSTRUCTIONS:

1️⃣ Connect to WiFi:
   - SSID: ESP32-BMS-Setup
   - Password: 12345678

2️⃣ Open Web UI:
   - Address: http://192.168.4.1
   - Or: http://192.168.4.1/setup

3️⃣ Configure:
   - Select your WiFi
   - Enter WiFi password
   - Save settings

4️⃣ ESP32 will reconnect to your WiFi and operate normally!
                            `;
                            alert(instructions);
                        }, 3000);
                    } else {
                    const lang8 = document.getElementById('language-selector').value;
                    alert(lang8 === 'vi' ? '❌ MQTT chưa kết nối!\nVui lòng kiểm tra kết nối MQTT.' : '❌ MQTT not connected!\nPlease check your MQTT connection.');
                    }
                } catch (error) {
                const lang9 = document.getElementById('language-selector').value;
                alert(lang9 === 'vi' ? '❌ Lỗi khi vào Setup Mode!\nVui lòng thử lại.' : '❌ Error entering Setup Mode!\nPlease try again.');
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load settings when switching to settings tab
            if (tabName === 'settings') {
                if (!settingsUnlocked()) {
                    showSettingsLock();
                } else {
                    hideSettingsLock();
                    document.getElementById('settings-form').style.display = '';
                    // Reload settings from BMS every time settings tab is opened
                    console.log('🔄 Reloading settings from BMS...');
                loadSettings();
                    // Cập nhật labels khi mở settings tab
                    const currentLang = localStorage.getItem('language') || 'vi';
                    updateSettingsLabels(currentLang);
                }
            }
            // Load log when switching to log tab
            if (tabName === 'log') {
                loadLog();
            }
        }

        // Load settings from server
        async function loadSettings() {
            if (!settingsUnlocked()) { showSettingsLock(); return; }
            
            // Luôn hiển thị giá trị mặc định trước
            updateSettingsUI({});
            
            try {
                if (mqttClient && mqttClient.connected) {
                    // Request settings via MQTT
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'get_settings', { qos: 1 });
                    console.log('Đã gửi lệnh get_settings qua MQTT');
                } else {
                    console.log('MQTT chưa kết nối, hiển thị giá trị mặc định');
                }
            } catch(e){ 
                console.error('Lỗi khi load settings:', e);
                const lang = localStorage.getItem('language') || 'vi';
                const t = translations[lang];
                const msgEl = document.getElementById('settings-msg');
                if (msgEl){ msgEl.style.color = '#f44336'; msgEl.textContent = t.load_settings_error; }
            }
            await loadSwitches();
        }

        async function loadSwitches(){
            // Hiển thị giá trị mặc định cho switches
            updateSwitchesUI({});
            
            try{
                if (mqttClient && mqttClient.connected) {
                    // Request switches via MQTT
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'get_switches', { qos: 1 });
                    console.log('Đã gửi lệnh get_switches qua MQTT');
                } else {
                    console.log('MQTT chưa kết nối, hiển thị giá trị mặc định cho switches');
                }
            }catch(e){ 
                console.error('Lỗi khi load switches:', e);
            }
        }

        // Lưu từng setting riêng lẻ
        async function saveSingleSetting(settingKey, elementId) {
            const value = parseFloat(document.getElementById(elementId).value);
            if (isNaN(value)) {
                const lang = document.getElementById('language-selector').value;
                showSettingsMessage(lang === 'vi' ? 'Giá trị không hợp lệ!' : 'Invalid value!', 'error');
                return;
            }

            const setting = {};
            setting[settingKey] = value;

            try {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/settings`;
                    mqttClient.publish(topic, JSON.stringify(setting), { qos: 1 });
                    const lang = document.getElementById('language-selector').value;
                    showSettingsMessage(lang === 'vi' ? 'Đã gửi cài đặt qua MQTT!' : 'Settings sent via MQTT!', 'success');
                } else {
                    const lang = document.getElementById('language-selector').value;
                    showSettingsMessage(lang === 'vi' ? 'MQTT chưa kết nối!' : 'MQTT not connected!', 'error');
                }
            } catch (e) {
                const lang = document.getElementById('language-selector').value;
                showSettingsMessage(lang === 'vi' ? 'Lỗi kết nối MQTT!' : 'MQTT connection error!', 'error');
            }
        }

        // Hiển thị thông báo settings
        function showSettingsMessage(message, type) {
            const msgEl = document.getElementById('settings-msg');
            msgEl.textContent = message;
            msgEl.style.color = type === 'success' ? '#4CAF50' : '#f44336';
            msgEl.style.fontWeight = 'bold';
            setTimeout(() => msgEl.textContent = '', 2000);
        }

        // Hiển thị thông báo chung
        function showAlert(message, type = 'info') {
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#ff9800',
                'info': '#2196F3'
            };
            
            // Tạo thông báo tạm thời
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                max-width: 300px;
                word-wrap: break-word;
            `;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Lưu công tắc khi thay đổi
        async function saveSwitch(switchKey, elementId) {
            const value = document.getElementById(elementId).checked;
            
            const switchData = {};
            switchData[switchKey] = value;

            try {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/switches`;
                    mqttClient.publish(topic, JSON.stringify(switchData), { qos: 1 });
                    const lang = document.getElementById('language-selector').value;
                    showSettingsMessage(lang === 'vi' ? 'Đã gửi công tắc qua MQTT!' : 'Switches sent via MQTT!', 'success');
                } else {
                    const lang = document.getElementById('language-selector').value;
                    showSettingsMessage(lang === 'vi' ? 'MQTT chưa kết nối!' : 'MQTT not connected!', 'error');
                }
            } catch (e) {
                const lang = document.getElementById('language-selector').value;
                showSettingsMessage(lang === 'vi' ? 'Lỗi kết nối MQTT!' : 'MQTT connection error!', 'error');
            }
        }

        // Reset settings to default
        function resetSettings() {
            if (confirm('Bạn có chắc muốn khôi phục cài đặt mặc định?')) {
                document.getElementById('capacity').value = 280.0;
                document.getElementById('balance-trigger-voltage').value = 3.40;
                document.getElementById('cell-overvoltage').value = 3.65;
                document.getElementById('cell-undervoltage').value = 3.0;
                document.getElementById('charge-current').value = 50.0;
                document.getElementById('discharge-current').value = 50.0;
                document.getElementById('charge-overtemp').value = 60;
                document.getElementById('discharge-overtemp').value = 70;
                document.getElementById('mos-overtemp').value = 80;
            }
        }

        // Log tab: load log file
        async function loadLog() {
            const logArea = document.getElementById('log-area');
            logArea.textContent = 'Đang tải log...';
            try {
                const response = await fetch('/logs_jk-bms_logs.txt');
                if (response.ok) {
                    const text = await response.text();
                    logArea.textContent = text || 'Không có log.';
                } else {
                    logArea.textContent = 'Không thể tải log.';
                }
            } catch (e) { logArea.textContent = 'Không thể tải log.'; }
        }

        function settingsUnlocked(){ return sessionStorage.getItem('settingsUnlocked') === 'true'; }
        function showSettingsLock(){
            document.getElementById('settings-lock-modal').style.display = 'flex';
            document.getElementById('settings-form').style.display = 'none';
            document.getElementById('settings-lock-error').textContent = '';
            document.getElementById('settings-password').value = '';
        }
        function hideSettingsLock(){
            document.getElementById('settings-lock-modal').style.display = 'none';
            document.getElementById('settings-form').style.display = '';
        }
        function closeSettingsLock(){
            document.getElementById('settings-lock-modal').style.display = 'none';
        }
        function unlockSettings(){
            const pwd = document.getElementById('settings-password').value;
            if (pwd === 'adcdongduong') {
                sessionStorage.setItem('settingsUnlocked', 'true');
                hideSettingsLock();
                loadSettings();
                // Cập nhật labels khi unlock settings
                const currentLang = localStorage.getItem('language') || 'vi';
                updateSettingsLabels(currentLang);
            } else {
                document.getElementById('settings-lock-error').textContent = 'Mật khẩu không đúng!';
            }
        }

        // Settings unlock check is now handled in main DOMContentLoaded listener

        // Language translations
        const translations = {
            vi: {
                header_subtitle: "Hệ thống giám sát và điều khiển BMS",
                monitor_tab: "THÔNG SỐ PIN",
                settings_tab: "CÀI ĐẶT",
                notifications_tab: "THÔNG BÁO",
                connecting: "Đang kết nối...",
                not_charging: "Không sạc",
                not_balancing: "Không cân bằng",
                device: "Thiết bị:",
                main_info: "Thông tin chính",
                voltage: "Điện áp (V)",
                current: "Dòng điện (A)",
                battery_percent: "Phần trăm pin (%)",
                power: "Công suất (W)",
                temperature: "Nhiệt độ",
                temp_sensor1: "Nhiệt độ cảm biến 1 (°C)",
                temp_sensor2: "Nhiệt độ cảm biến 2 (°C)",
                temp_mos: "Nhiệt độ cảm biến MOS (°C)",
                cell_info: "Thông tin Cell",
                min_voltage: "Điện áp thấp nhất (V)",
                max_voltage: "Điện áp cao nhất (V)",
                avg_voltage: "Điện áp trung bình (V)",
                delta_voltage: "Điện áp chênh lệch (V)",
                capacity: "Dung lượng",
                min_resistance: "Điện trở thấp nhất (mΩ)",
                max_resistance: "Điện trở cao nhất (mΩ)",
                avg_resistance: "Điện trở trung bình (mΩ)",
                delta_resistance: "Điện trở chênh lệch (mΩ)",
                current_capacity: "Dung lượng hiện tại (Ah)",
                total_capacity: "Dung lượng tối đa (Ah)",
                charge_cycles: "Số lần sạc",
                cell_voltages: "Điện áp Cell",
                cell_resistances: "Điện trở Cell",
                esp32_control: "Điều khiển mô-đun cầu nối BMS",
                emergency_stop: "Dừng khẩn cấp",
                setup_mode: "Chế độ thiết lập",
                power_cycle: "Khởi động lại nguồn (5s)",
                recover_bms: "Khởi động lại BMS",
                setup_modal_title: "Chế độ thiết lập",
                setup_modal_desc: "ESP32 sẽ khởi động lại và tạo WiFi \"ESP32-BMS-Setup\" để cấu hình.",
                power_cycle_modal_title: "Khởi động lại nguồn",
                power_cycle_modal_desc: "Thiết bị sẽ tạm ngắt nguồn 5 giây rồi bật lại để khởi động lại hoàn toàn.",
                recover_success_title: "✅ Khôi phục thành công",
                recover_success_desc: "Đã gửi lệnh khôi phục BMS qua MQTT. Hệ thống sẽ khôi phục các chức năng đã chọn.",
                confirm: "Xác nhận",
                cancel: "Hủy",

                alerts: "Cảnh báo",
                no_alerts: "Không có cảnh báo",
                online: "Online",
                offline: "Offline",
                charging: "Đang sạc",
                discharging: "Đang xả",
                not_charging_status: "Không sạc",
                balancing: "Đang cân bằng",
                not_balancing_status: "Không cân bằng",
                global_password_title: "JK BMS",
                global_password_message: "Vui lòng nhập mật khẩu để truy cập",
                global_password_placeholder: "Mật khẩu",
                global_password_button: "Truy cập",
                global_password_error: "Mật khẩu không đúng!",
                settings_password: "🔒 Mở khóa cài đặt",
                settings_password_desc: "Vui lòng nhập mật khẩu để truy cập vào phần cài đặt hệ thống.",
                password: "Nhập mật khẩu",
                unlock: "Mở khóa",
                wrong_password: "Mật khẩu không đúng!",
                voltage_settings: "Điện áp",
                current_settings: "Dòng điện",
                time_settings: "Thời gian & Độ trễ",
                temp_settings: "Nhiệt độ",
                switch_settings: "Công tắc điều khiển",
                save_settings: "Lưu cài đặt",
                save_switches: "Lưu công tắc",
                save_all_settings: "Lưu tất cả cài đặt",
                settings_saved: "Đã lưu cài đặt!",
                switches_saved: "Đã lưu công tắc!",
                all_settings_saved: "Đã lưu tất cả cài đặt!",
                settings_error: "Lỗi lưu cài đặt!",
                switches_error: "Lỗi lưu công tắc!",
                connection_error: "Lỗi kết nối!",
                load_settings_error: "Lỗi tải cài đặt",
                // Settings labels
                cell_overvoltage: "Ngưỡng cao áp cell (V)",
                cell_overvoltage_recovery: "Khôi phục cao áp (V)",
                cell_undervoltage: "Ngưỡng thấp áp cell (V)",
                cell_undervoltage_recovery: "Khôi phục thấp áp (V)",
                balance_trigger_voltage: "Ngưỡng cân bằng (V)",
                balance_start_voltage: "Điện áp bắt đầu cân bằng (V)",
                cell_soc100_voltage: "Điện áp khi pin 100% (V)",
                cell_soc0_voltage: "Điện áp khi pin 0% (V)",
                cell_request_charge_voltage: "Điện áp yêu cầu sạc (V)",
                cell_request_float_voltage: "Điện áp duy trì (V)",
                smart_sleep_voltage: "Điện áp ngủ thông minh (V)",
                power_off_voltage: "Điện áp tắt nguồn (V)",
                cell_count: "Số lượng cell",
                capacity: "Tổng dung lượng (Ah)",
                max_balance_current: "Dòng cân bằng tối đa (A)",
                charge_current: "Dòng sạc tối đa (A)",
                discharge_current: "Dòng xả tối đa (A)",
                current_calibration: "Hiệu chuẩn dòng điện",
                charge_ocp_delay_s: "Độ trễ quá dòng sạc (s)",
                charge_ocpr_time_s: "Thời gian khôi phục quá dòng sạc (s)",
                discharge_ocp_delay_s: "Độ trễ quá dòng xả (s)",
                discharge_ocpr_time_s: "Thời gian khôi phục quá dòng xả (s)",
                scp_delay_us: "Độ trễ ngắn mạch (μs)",
                scp_recovery_time_s: "Thời gian khôi phục ngắn mạch (s)",
                request_charge_voltage_time_h: "Thời gian yêu cầu sạc (h)",
                request_float_voltage_time_h: "Thời gian yêu cầu float (h)",
                discharge_precharge_time_s: "Thời gian precharge xả (s)",
                voltage_calibration: "Hiệu chuẩn điện áp",
                charge_overtemp: "Nhiệt độ quá cao sạc (°C)",
                charge_overtemp_recovery: "Nhiệt độ khôi phục sạc (°C)",
                discharge_overtemp: "Nhiệt độ quá cao xả (°C)",
                discharge_overtemp_recovery: "Nhiệt độ khôi phục xả (°C)",
                charge_undertemp: "Nhiệt độ quá thấp sạc (°C)",
                charge_undertemp_recovery: "Nhiệt độ khôi phục sạc (°C)",
                mos_overtemp: "Nhiệt độ quá cao MOSFET (°C)",
                mos_overtemp_recovery: "Nhiệt độ khôi phục MOSFET (°C)",
                charge_mosfet_on: "MOSFET sạc",
                discharge_mosfet_on: "MOSFET xả",
                balancer_on: "Bộ cân bằng",
                heating_on: "Sưởi ấm",
                disable_temperature_sensors: "Tắt cảm biến nhiệt",
                display_always_on: "Màn hình luôn sáng",
                smart_sleep_on: "Ngủ thông minh",
                disable_pcl_module: "Tắt module PCL",
                timed_stored_data: "Lưu dữ liệu theo thời gian",
                charging_float_mode: "Chế độ float sạc",
                emergency_mode: "Chế độ khẩn cấp",
                // Tooltips
                cell_overvoltage_tooltip: "Điện áp tối đa cho phép của mỗi cell. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin.",
                cell_overvoltage_recovery_tooltip: "Điện áp mà khi cell giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá điện áp.",
                cell_undervoltage_tooltip: "Điện áp tối thiểu cho phép của mỗi cell. Khi xuống dưới mức này, BMS sẽ ngắt xả để bảo vệ pin.",
                cell_undervoltage_recovery_tooltip: "Điện áp mà khi cell tăng lên trên mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do điện áp thấp.",
                balance_trigger_voltage_tooltip: "Điện áp bắt đầu cân bằng các cell. Khi cell nào vượt quá ngưỡng này, BMS sẽ bắt đầu cân bằng để giảm điện áp của cell đó.",
                balance_start_voltage_tooltip: "Điện áp chính xác để bắt đầu cân bằng. Thường thấp hơn ngưỡng cân bằng một chút để tránh cân bằng không cần thiết.",
                cell_soc100_voltage_tooltip: "Điện áp tương ứng với mức pin 100%. Dùng để tính toán chính xác mức pin còn lại.",
                cell_soc0_voltage_tooltip: "Điện áp tương ứng với mức pin 0%. Dùng để tính toán chính xác mức pin còn lại.",
                cell_request_charge_voltage_tooltip: "Điện áp mục tiêu khi sạc đầy. BMS sẽ ngừng sạc khi đạt đến điện áp này.",
                cell_request_float_voltage_tooltip: "Điện áp duy trì sau khi sạc đầy. Thấp hơn điện áp sạc để tránh quá sạc và tăng tuổi thọ pin.",
                smart_sleep_voltage_tooltip: "Điện áp kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.",
                power_off_voltage_tooltip: "Điện áp mà khi pin xuống dưới mức này, BMS sẽ tắt hoàn toàn để bảo vệ pin khỏi xả quá sâu.",
                cell_count_tooltip: "Tổng số cell lithium trong bộ pin. Ví dụ: 16 cell cho pin 48V.",
                capacity_tooltip: "Tổng dung lượng của bộ pin tính bằng Ampere-giờ. Ví dụ: 100Ah cho pin 48V 100Ah.",
                max_balance_current_tooltip: "Dòng điện tối đa được sử dụng để cân bằng các cell. Dòng cao hơn sẽ cân bằng nhanh hơn nhưng tiêu thụ nhiều năng lượng hơn.",
                charge_current_tooltip: "Dòng điện tối đa cho phép khi sạc pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng sạc.",
                discharge_current_tooltip: "Dòng điện tối đa cho phép khi xả pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng xả.",
                current_calibration_tooltip: "Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến dòng điện. Dùng để bù trừ sai số đo.",
                charge_ocp_delay_s_tooltip: "Thời gian chờ trước khi kích hoạt bảo vệ quá dòng sạc. Cho phép dòng tăng đột ngột tạm thời.",
                charge_ocpr_time_s_tooltip: "Thời gian chờ trước khi cho phép sạc lại sau khi đã ngắt do quá dòng sạc.",
                discharge_ocp_delay_s_tooltip: "Thời gian chờ trước khi kích hoạt bảo vệ quá dòng xả. Cho phép dòng tăng đột ngột tạm thời.",
                discharge_ocpr_time_s_tooltip: "Thời gian chờ trước khi cho phép xả lại sau khi đã ngắt do quá dòng xả.",
                scp_delay_us_tooltip: "Thời gian chờ rất ngắn trước khi kích hoạt bảo vệ ngắn mạch. Đơn vị micro giây.",
                scp_recovery_time_s_tooltip: "Thời gian chờ trước khi cho phép hoạt động lại sau khi đã ngắt do ngắn mạch.",
                request_charge_voltage_time_h_tooltip: "Thời gian tối đa cho phép sạc liên tục. Sau thời gian này, BMS sẽ ngắt sạc để bảo vệ.",
                request_float_voltage_time_h_tooltip: "Thời gian tối đa cho phép duy trì ở chế độ float. Sau thời gian này, BMS sẽ chuyển sang chế độ khác.",
                discharge_precharge_time_s_tooltip: "Thời gian precharge trước khi cho phép xả đầy đủ. Dùng để bảo vệ mạch điện.",
                voltage_calibration_tooltip: "Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến điện áp. Dùng để bù trừ sai số đo.",
                charge_overtemp_tooltip: "Nhiệt độ tối đa cho phép khi sạc pin. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin khỏi nhiệt độ cao.",
                charge_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ cao.",
                discharge_overtemp_tooltip: "Nhiệt độ tối đa cho phép khi xả pin. Khi vượt quá, BMS sẽ ngắt xả để bảo vệ pin khỏi nhiệt độ cao.",
                discharge_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do nhiệt độ cao.",
                charge_undertemp_tooltip: "Nhiệt độ tối thiểu cho phép khi sạc pin. Khi xuống dưới mức này, BMS sẽ ngắt sạc để bảo vệ pin khỏi nhiệt độ thấp.",
                charge_undertemp_recovery_tooltip: "Nhiệt độ mà khi tăng lên trên mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ thấp.",
                mos_overtemp_tooltip: "Nhiệt độ tối đa cho phép của MOSFET. Khi vượt quá, BMS sẽ ngắt hoạt động để bảo vệ mạch điện.",
                mos_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép hoạt động lại sau khi đã ngắt do nhiệt độ MOSFET cao.",
                charge_mosfet_on_tooltip: "Bật/tắt MOSFET điều khiển sạc pin. Khi tắt, BMS sẽ không cho phép sạc pin.",
                discharge_mosfet_on_tooltip: "Bật/tắt MOSFET điều khiển xả pin. Khi tắt, BMS sẽ không cho phép xả pin.",
                balancer_on_tooltip: "Bật/tắt chức năng cân bằng các cell. Khi bật, BMS sẽ tự động cân bằng điện áp các cell.",
                heating_on_tooltip: "Bật/tắt chức năng sưởi ấm pin khi nhiệt độ thấp. Giúp pin hoạt động tốt trong môi trường lạnh.",
                disable_temperature_sensors_tooltip: "Tắt chức năng giám sát nhiệt độ. Chỉ dùng khi không có cảm biến nhiệt hoặc muốn bỏ qua bảo vệ nhiệt.",
                display_always_on_tooltip: "Giữ màn hình BMS luôn sáng. Tắt để tiết kiệm năng lượng khi không sử dụng.",
                smart_sleep_on_tooltip: "Kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.",
                disable_pcl_module_tooltip: "Tắt module PCL (Power Control Logic). Chỉ dùng khi cần thiết để bỏ qua một số chức năng bảo vệ.",
                timed_stored_data_tooltip: "Bật chức năng lưu trữ dữ liệu theo thời gian để theo dõi lịch sử hoạt động của pin.",
                charging_float_mode_tooltip: "Kích hoạt chế độ float sạc để duy trì pin ở mức sạc đầy mà không gây quá sạc.",
                emergency_mode_tooltip: "Kích hoạt chế độ khẩn cấp để bỏ qua một số bảo vệ khi cần thiết. Chỉ dùng trong trường hợp đặc biệt."
            },
            en: {
                header_subtitle: "BMS Monitoring and Control System",
                monitor_tab: "BATTERY STATUS",
                settings_tab: "SETTINGS",
                notifications_tab: "NOTIFICATIONS",
                connecting: "Connecting...",
                not_charging: "Not Charging",
                not_balancing: "Not Balancing",
                device: "Device:",
                main_info: "Main Information",
                voltage: "Voltage (V)",
                current: "Current (A)",
                battery_percent: "Battery Percentage (%)",
                power: "Power (W)",
                temperature: "Temperature",
                temp_sensor1: "Temperature Sensor 1 (°C)",
                temp_sensor2: "Temperature Sensor 2 (°C)",
                temp_mos: "MOS Temperature (°C)",
                cell_info: "Cell Information",
                min_voltage: "Minimum Voltage (V)",
                max_voltage: "Maximum Voltage (V)",
                avg_voltage: "Average Voltage (V)",
                delta_voltage: "Voltage Difference (V)",
                capacity: "Capacity",
                min_resistance: "Minimum Resistance (mΩ)",
                max_resistance: "Maximum Resistance (mΩ)",
                avg_resistance: "Average Resistance (mΩ)",
                delta_resistance: "Resistance Difference (mΩ)",
                current_capacity: "Current Capacity (Ah)",
                total_capacity: "Maximum Capacity (Ah)",
                charge_cycles: "Charge Cycles",
                cell_voltages: "Cell Voltages",
                cell_resistances: "Cell Resistances",
                esp32_control: "BMS Bridge Module Control",
                emergency_stop: "Emergency Stop",
                setup_mode: "Setup Mode",
                power_cycle: "Power Cycle (5s)",
                recover_bms: "Restart BMS",
                setup_modal_title: "Setup Mode",
                setup_modal_desc: "ESP32 will reboot and create WiFi \"ESP32-BMS-Setup\" for configuration.",
                power_cycle_modal_title: "Power Cycle",
                power_cycle_modal_desc: "Device will temporarily power off for 5 seconds then restart completely.",
                recover_success_title: "✅ Recovery Successful",
                recover_success_desc: "BMS recovery command sent via MQTT. System will restore selected functions.",
                confirm: "Confirm",
                cancel: "Cancel",

                alerts: "Alerts",
                no_alerts: "No alerts",
                online: "Online",
                offline: "Offline",
                charging: "Charging",
                discharging: "Discharging",
                not_charging_status: "Not Charging",
                balancing: "Balancing",
                not_balancing_status: "Not Balancing",
                global_password_title: "JK BMS",
                global_password_message: "Please enter password to access",
                global_password_placeholder: "Password",
                global_password_button: "Access",
                global_password_error: "Wrong password!",
                settings_password: "🔒 Unlock Settings",
                settings_password_desc: "Please enter password to access system settings.",
                password: "Enter password",
                unlock: "Unlock",
                wrong_password: "Wrong password!",
                voltage_settings: "Voltage",
                current_settings: "Current",
                time_settings: "Time & Delay",
                temp_settings: "Temperature",
                switch_settings: "Control Switches",
                save_settings: "Save Settings",
                save_switches: "Save Switches",
                save_all_settings: "Save All Settings",
                settings_saved: "Settings saved!",
                switches_saved: "Switches saved!",
                all_settings_saved: "All settings saved!",
                settings_error: "Settings save error!",
                switches_error: "Switches save error!",
                connection_error: "Connection error!",
                load_settings_error: "Settings load error",
                // Settings labels
                cell_overvoltage: "Cell Overvoltage Threshold (V)",
                cell_overvoltage_recovery: "Overvoltage Recovery (V)",
                cell_undervoltage: "Cell Undervoltage Threshold (V)",
                cell_undervoltage_recovery: "Undervoltage Recovery (V)",
                balance_trigger_voltage: "Balance Trigger Voltage (V)",
                balance_start_voltage: "Balance Start Voltage (V)",
                cell_soc100_voltage: "Cell Voltage at 100% SOC (V)",
                cell_soc0_voltage: "Cell Voltage at 0% SOC (V)",
                cell_request_charge_voltage: "Request Charge Voltage (V)",
                cell_request_float_voltage: "Request Float Voltage (V)",
                smart_sleep_voltage: "Smart Sleep Voltage (V)",
                power_off_voltage: "Power Off Voltage (V)",
                cell_count: "Cell Count",
                capacity: "Total Capacity (Ah)",
                max_balance_current: "Max Balance Current (A)",
                charge_current: "Max Charge Current (A)",
                discharge_current: "Max Discharge Current (A)",
                current_calibration: "Current Calibration",
                charge_ocp_delay_s: "Charge OCP Delay (s)",
                charge_ocpr_time_s: "Charge OCP Recovery Time (s)",
                discharge_ocp_delay_s: "Discharge OCP Delay (s)",
                discharge_ocpr_time_s: "Discharge OCP Recovery Time (s)",
                scp_delay_us: "SCP Delay (μs)",
                scp_recovery_time_s: "SCP Recovery Time (s)",
                request_charge_voltage_time_h: "Request Charge Voltage Time (h)",
                request_float_voltage_time_h: "Request Float Voltage Time (h)",
                discharge_precharge_time_s: "Discharge Precharge Time (s)",
                voltage_calibration: "Voltage Calibration",
                charge_overtemp: "Charge Overtemperature (°C)",
                charge_overtemp_recovery: "Charge Overtemperature Recovery (°C)",
                discharge_overtemp: "Discharge Overtemperature (°C)",
                discharge_overtemp_recovery: "Discharge Overtemperature Recovery (°C)",
                charge_undertemp: "Charge Undertemperature (°C)",
                charge_undertemp_recovery: "Charge Undertemperature Recovery (°C)",
                mos_overtemp: "MOS Overtemperature (°C)",
                mos_overtemp_recovery: "MOS Overtemperature Recovery (°C)",
                charge_mosfet_on: "Charge MOSFET",
                discharge_mosfet_on: "Discharge MOSFET",
                balancer_on: "Balancer",
                heating_on: "Heating",
                disable_temperature_sensors: "Disable Temperature Sensors",
                display_always_on: "Display Always On",
                smart_sleep_on: "Smart Sleep",
                disable_pcl_module: "Disable PCL Module",
                timed_stored_data: "Timed Stored Data",
                charging_float_mode: "Charging Float Mode",
                emergency_mode: "Emergency Mode",
                // Tooltips
                cell_overvoltage_tooltip: "Maximum allowed voltage for each cell. When exceeded, BMS will cut off charging to protect the battery.",
                cell_overvoltage_recovery_tooltip: "Voltage at which the cell drops below this level, BMS will allow charging again after being cut off due to overvoltage.",
                cell_undervoltage_tooltip: "Minimum allowed voltage for each cell. When below this level, BMS will cut off discharge to protect the battery.",
                cell_undervoltage_recovery_tooltip: "Voltage at which the cell rises above this level, BMS will allow discharge again after being cut off due to low voltage.",
                balance_trigger_voltage_tooltip: "Voltage to start balancing cells. When any cell exceeds this threshold, BMS will start balancing to reduce that cell's voltage.",
                balance_start_voltage_tooltip: "Exact voltage to start balancing. Usually slightly lower than balance threshold to avoid unnecessary balancing.",
                cell_soc100_voltage_tooltip: "Voltage corresponding to 100% battery level. Used to accurately calculate remaining battery level.",
                cell_soc0_voltage_tooltip: "Voltage corresponding to 0% battery level. Used to accurately calculate remaining battery level.",
                cell_request_charge_voltage_tooltip: "Target voltage when fully charged. BMS will stop charging when reaching this voltage.",
                cell_request_float_voltage_tooltip: "Maintenance voltage after fully charged. Lower than charge voltage to avoid overcharging and extend battery life.",
                smart_sleep_voltage_tooltip: "Voltage to activate smart sleep mode to save energy when battery is fully charged.",
                power_off_voltage_tooltip: "Voltage at which when battery drops below this level, BMS will shut down completely to protect battery from deep discharge.",
                cell_count_tooltip: "Total number of lithium cells in the battery pack. Example: 16 cells for 48V battery.",
                capacity_tooltip: "Total capacity of the battery pack in Ampere-hours. Example: 100Ah for 48V 100Ah battery.",
                max_balance_current_tooltip: "Maximum current used to balance cells. Higher current will balance faster but consume more energy.",
                charge_current_tooltip: "Maximum allowed current when charging battery. Exceeding this will trigger overcurrent protection.",
                discharge_current_tooltip: "Maximum allowed current when discharging battery. Exceeding this will trigger overcurrent protection.",
                current_calibration_tooltip: "Calibration factor to adjust current sensor accuracy. Used to compensate for measurement errors.",
                charge_ocp_delay_s_tooltip: "Delay time before triggering charge overcurrent protection. Allows temporary current spikes.",
                charge_ocpr_time_s_tooltip: "Wait time before allowing charging again after being cut off due to charge overcurrent.",
                discharge_ocp_delay_s_tooltip: "Delay time before triggering discharge overcurrent protection. Allows temporary current spikes.",
                discharge_ocpr_time_s_tooltip: "Wait time before allowing discharge again after being cut off due to discharge overcurrent.",
                scp_delay_us_tooltip: "Very short delay time before triggering short circuit protection. Unit in microseconds.",
                scp_recovery_time_s_tooltip: "Wait time before allowing operation again after being cut off due to short circuit.",
                request_charge_voltage_time_h_tooltip: "Maximum time allowed for continuous charging. After this time, BMS will cut off charging for protection.",
                request_float_voltage_time_h_tooltip: "Maximum time allowed to maintain float mode. After this time, BMS will switch to other mode.",
                discharge_precharge_time_s_tooltip: "Precharge time before allowing full discharge. Used to protect electrical circuits.",
                voltage_calibration_tooltip: "Calibration factor to adjust voltage sensor accuracy. Used to compensate for measurement errors.",
                current_calibration_tooltip: "Calibration factor to adjust current sensor accuracy. Used to compensate for measurement errors.",
                charge_overtemp_tooltip: "Maximum allowed temperature when charging battery. When exceeded, BMS will cut off charging to protect battery from high temperature.",
                charge_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow charging again after being cut off due to high temperature.",
                discharge_overtemp_tooltip: "Maximum allowed temperature when discharging battery. When exceeded, BMS will cut off discharge to protect battery from high temperature.",
                discharge_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow discharge again after being cut off due to high temperature.",
                charge_undertemp_tooltip: "Minimum allowed temperature when charging battery. When below this level, BMS will cut off charging to protect battery from low temperature.",
                charge_undertemp_recovery_tooltip: "Temperature at which when rises above this level, BMS will allow charging again after being cut off due to low temperature.",
                mos_overtemp_tooltip: "Maximum allowed temperature of MOSFET. When exceeded, BMS will cut off operation to protect electrical circuits.",
                mos_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow operation again after being cut off due to high MOSFET temperature.",
                charge_mosfet_on_tooltip: "Turn on/off MOSFET controlling battery charging. When off, BMS will not allow battery charging.",
                discharge_mosfet_on_tooltip: "Turn on/off MOSFET controlling battery discharging. When off, BMS will not allow battery discharging.",
                balancer_on_tooltip: "Turn on/off cell balancing function. When on, BMS will automatically balance cell voltages.",
                heating_on_tooltip: "Turn on/off heating function when temperature is low. Helps battery work well in cold environment.",
                disable_temperature_sensors_tooltip: "Turn off temperature monitoring function. Only use when no temperature sensor or want to ignore temperature protection.",
                display_always_on_tooltip: "Keep BMS display always on. Turn off to save energy when not in use.",
                smart_sleep_on_tooltip: "Activate smart sleep mode to save energy when battery is fully charged.",
                disable_pcl_module_tooltip: "Turn off PCL (Power Control Logic) module. Only use when necessary to bypass some protection functions.",
                timed_stored_data_tooltip: "Turn on timed data storage function to track battery operation history.",
                charging_float_mode_tooltip: "Activate float charging mode to maintain battery at full charge without causing overcharge.",
                emergency_mode_tooltip: "Activate emergency mode to bypass some protections when necessary. Only use in special cases."
            }
        };

        // Initialize language selector
        function initializeLanguageSelector() {
            const selector = document.getElementById('language-selector');
            if (!selector) {
                // If selector doesn't exist yet, try again after a short delay
                setTimeout(initializeLanguageSelector, 100);
                return;
            }
            
            const currentLang = localStorage.getItem('language') || 'vi';
            selector.value = currentLang;
            renderLanguageFlag(currentLang);
            applyLanguage(currentLang);
            
            // Also apply language to global password overlay if it exists
            const globalOverlay = document.getElementById('global-password-overlay');
            if (globalOverlay) {
                const t = translations[currentLang];
                const overlayTitle = globalOverlay.querySelector('h2');
                if (overlayTitle) overlayTitle.textContent = t.global_password_title;
                
                const overlayMessage = globalOverlay.querySelector('p');
                if (overlayMessage) overlayMessage.textContent = t.global_password_message;
                
                const passwordInput = document.getElementById('global-password-input');
                if (passwordInput) passwordInput.placeholder = t.global_password_placeholder;
                
                const accessBtn = globalOverlay.querySelector('button');
                if (accessBtn) accessBtn.textContent = t.global_password_button;
            }
            
            selector.addEventListener('change', function() {
                const lang = this.value;
                localStorage.setItem('language', lang);
                console.log('Language changed to:', lang);
                renderLanguageFlag(lang);
                applyLanguage(lang);
            });
        }

        function renderLanguageFlag(lang){
            const el = document.getElementById('lang-flag');
            if(!el) {
                // If flag element doesn't exist yet, try again after a short delay
                setTimeout(() => renderLanguageFlag(lang), 100);
                return;
            }
            if(lang === 'en'){
                // US flag SVG - fixed viewBox
                el.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630" preserveAspectRatio="xMidYMid meet">
  <rect width="1200" height="630" fill="#b22234"/>
  <g fill="#fff">
    <rect width="1200" height="48.5" y="48.5"/>
    <rect width="1200" height="48.5" y="145.5"/>
    <rect width="1200" height="48.5" y="242.5"/>
    <rect width="1200" height="48.5" y="339.5"/>
    <rect width="1200" height="48.5" y="436.5"/>
    <rect width="1200" height="48.5" y="533.5"/>
  </g>
  <rect width="480" height="340" fill="#3c3b6e"/>
</svg>`;
            } else {
                // Vietnam flag SVG - fixed viewBox
                el.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" preserveAspectRatio="xMidYMid meet">
  <rect width="900" height="600" fill="#da251d"/>
  <polygon fill="#ff0" points="450,135 495,290 675,290 540,365 585,520 450,445 315,520 360,365 225,290 405,290"/>
</svg>`;
            }
        }

        // Apply language to UI
        function applyLanguage(lang) {
            const t = translations[lang];
            
            // Header
            const headerSubtitle = document.getElementById('header-subtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = t.header_subtitle;
            }
            
            // Tab buttons (include Notifications)
            const tabButtons = document.querySelectorAll('.tab-btn');
            if (tabButtons.length >= 3) {
            tabButtons[0].textContent = t.monitor_tab;
            tabButtons[1].textContent = t.settings_tab;
                tabButtons[2].textContent = t.notifications_tab;
            }
            
            // Status bar
            const statusElements = document.querySelectorAll('.status');
            if (statusElements.length >= 4) {
                statusElements[0].textContent = t.connecting;
                statusElements[1].textContent = t.not_charging;
                statusElements[2].textContent = t.not_balancing;
            }
            
            // Update monitor card titles and labels
            updateMonitorTexts(lang);
            
            // Update BMS control section titles
            const safetyTitle = document.getElementById('safety-title');
            const systemTitle = document.getElementById('system-title');
            if (safetyTitle) {
                safetyTitle.textContent = (lang === 'vi') ? 'An toàn hệ thống' : 'System Safety';
            }
            if (systemTitle) {
                systemTitle.textContent = (lang === 'vi') ? 'Hoạt động của hệ thống' : 'System Operations';
            }
            
            // Update modal texts
            const emergencyTitle = document.getElementById('emergency-modal-title');
            const emergencyDesc = document.getElementById('emergency-modal-desc');
            const emergencyCancel = document.getElementById('emergency-cancel-btn');
            const emergencyConfirm = document.getElementById('emergency-confirm-btn');
            
            if (emergencyTitle) emergencyTitle.textContent = (lang === 'vi') ? 'Xác nhận dừng khẩn cấp' : 'Confirm Emergency Stop';
            if (emergencyDesc) emergencyDesc.textContent = (lang === 'vi') ? 'Hệ thống sẽ tắt sạc, xả, cân bằng, sưởi và bật chế độ khẩn cấp để đảm bảo an toàn.' : 'System will turn off charging, discharging, balancing, heating and activate emergency mode for safety.';
            if (emergencyCancel) emergencyCancel.textContent = (lang === 'vi') ? 'Hủy' : 'Cancel';
            if (emergencyConfirm) emergencyConfirm.textContent = (lang === 'vi') ? 'Xác nhận' : 'Confirm';
            
            const recoverTitle = document.getElementById('recover-modal-title');
            const recoverDesc = document.getElementById('recover-modal-desc');
            const recoverCancel = document.getElementById('recover-cancel-btn');
            const recoverConfirm = document.getElementById('recover-confirm-btn');
            
            if (recoverTitle) recoverTitle.textContent = (lang === 'vi') ? 'Khởi động lại BMS' : 'Restart BMS';
            if (recoverDesc) recoverDesc.textContent = (lang === 'vi') ? 'Chọn trạng thái cần phục hồi. Mặc định khôi phục theo trước khi dừng khẩn cấp.' : 'Select states to restore. Default restores to pre-emergency state.';
            if (recoverCancel) recoverCancel.textContent = (lang === 'vi') ? 'Hủy' : 'Cancel';
            if (recoverConfirm) recoverConfirm.textContent = (lang === 'vi') ? 'Xác nhận' : 'Confirm';
            
            // Update settings section titles
            const powerControlTitle = document.getElementById('power-control-title');
            const batteryManagementTitle = document.getElementById('battery-management-title');
            const systemSettingsTitle = document.getElementById('system-settings-title');
            const safetyEmergencyTitle = document.getElementById('safety-emergency-title');
            
            if (powerControlTitle) powerControlTitle.textContent = (lang === 'vi') ? 'CÔNG TẮC ĐIỀU KHIỂN' : 'CONTROL SWITCHES';
            if (batteryManagementTitle) batteryManagementTitle.textContent = (lang === 'vi') ? 'QUẢN LÝ PIN' : 'BATTERY MANAGEMENT';
            if (systemSettingsTitle) systemSettingsTitle.textContent = (lang === 'vi') ? 'CÀI ĐẶT HỆ THỐNG' : 'SYSTEM SETTINGS';
            if (safetyEmergencyTitle) safetyEmergencyTitle.textContent = (lang === 'vi') ? 'AN TOÀN & KHẨN CẤP' : 'SAFETY & EMERGENCY';
            
            // Main info units (corrected order)
            const units = document.querySelectorAll('.unit');
            if (units.length >= 6) {
                units[0].textContent = t.voltage;             // Voltage (V)
                units[1].textContent = t.battery_percent;     // Battery Percentage (%)
                units[2].textContent = t.current;             // Current (A)
                units[3].textContent = t.power;               // Power (W)
                units[4].textContent = t.current_capacity;    // Current Capacity (Ah)
                units[5].textContent = t.total_capacity;      // Maximum Capacity (Ah)
            }
            
            // Temperature units (skip main info units)
            const tempUnits = document.querySelectorAll('.unit');
            if (tempUnits.length >= 10) {
                tempUnits[6].textContent = t.temp_sensor1;   // Nhiệt độ cảm biến 1
                tempUnits[7].textContent = t.temp_sensor2;   // Nhiệt độ cảm biến 2
                tempUnits[8].textContent = t.temp_mos;       // Nhiệt độ cảm biến MOS
            }
            
            // Cell info units (skip main info + temperature units)
            const cellUnits = document.querySelectorAll('.unit');
            if (cellUnits.length >= 15) {
                cellUnits[9].textContent = t.min_voltage;
                cellUnits[10].textContent = t.max_voltage;
                cellUnits[11].textContent = t.avg_voltage;
                cellUnits[12].textContent = t.delta_voltage;
            }
            
            // Resistance units (skip main info + temperature + cell voltage units)
            const resistanceUnits = document.querySelectorAll('.unit');
            if (resistanceUnits.length >= 17) {
                resistanceUnits[13].textContent = t.min_resistance;
                resistanceUnits[14].textContent = t.max_resistance;
                resistanceUnits[15].textContent = t.avg_resistance;
                resistanceUnits[16].textContent = t.delta_resistance;
            }
            
            // Control buttons
            const controlButtons = document.querySelectorAll('.btn');
            // Update control buttons
            const emergencyText = document.getElementById('emergency-text');
            const recoverText = document.getElementById('recover-text');
            const setupText = document.getElementById('setup-text');
            const powerCycleText = document.getElementById('power-cycle-text');
            
            if (emergencyText) emergencyText.textContent = t.emergency_stop;
            if (recoverText) recoverText.textContent = t.recover_bms;
            if (setupText) setupText.textContent = t.setup_mode;
            if (powerCycleText) powerCycleText.textContent = t.power_cycle;
            
            // Update modal texts
            const setupModalTitle = document.getElementById('setup-modal-title');
            const setupModalDesc = document.getElementById('setup-modal-desc');
            const powerCycleModalTitle = document.getElementById('power-cycle-modal-title');
            const powerCycleModalDesc = document.getElementById('power-cycle-modal-desc');
            
            if (setupModalTitle) setupModalTitle.textContent = t.setup_modal_title;
            if (setupModalDesc) setupModalDesc.textContent = t.setup_modal_desc;
            if (powerCycleModalTitle) powerCycleModalTitle.textContent = t.power_cycle_modal_title;
            if (powerCycleModalDesc) powerCycleModalDesc.textContent = t.power_cycle_modal_desc;
            
            // Update recover success modal texts
            const recoverSuccessTitle = document.getElementById('recover-success-title');
            const recoverSuccessDesc = document.getElementById('recover-success-desc');
            const recoverSuccessBtn = document.getElementById('recover-success-btn');
            
            if (recoverSuccessTitle) recoverSuccessTitle.textContent = t.recover_success_title;
            if (recoverSuccessDesc) recoverSuccessDesc.textContent = t.recover_success_desc;
            if (recoverSuccessBtn) recoverSuccessBtn.textContent = t.confirm;
            
            // Update alerts title and no alerts text
            const alertsTitle = document.getElementById('alerts-title');
            const noAlertsText = document.getElementById('no-alerts-text');
            
            if (alertsTitle) alertsTitle.textContent = t.alerts;
            if (noAlertsText) noAlertsText.textContent = t.no_alerts;
            
            // Update device label
            const deviceLabel = document.getElementById('device-label');
            if (deviceLabel) deviceLabel.textContent = t.device;
            
            // Update capacity units
            const currentCapacityUnit = document.getElementById('current-capacity-unit');
            const totalCapacityUnit = document.getElementById('total-capacity-unit');
            if (currentCapacityUnit) currentCapacityUnit.textContent = t.current_capacity;
            if (totalCapacityUnit) totalCapacityUnit.textContent = t.total_capacity;
            
            // Update resistance units
            const minResistanceUnit = document.getElementById('min-resistance-unit');
            const maxResistanceUnit = document.getElementById('max-resistance-unit');
            const avgResistanceUnit = document.getElementById('avg-resistance-unit');
            const deltaResistanceUnit = document.getElementById('delta-resistance-unit');
            if (minResistanceUnit) minResistanceUnit.textContent = t.min_resistance;
            if (maxResistanceUnit) maxResistanceUnit.textContent = t.max_resistance;
            if (avgResistanceUnit) avgResistanceUnit.textContent = t.avg_resistance;
            if (deltaResistanceUnit) deltaResistanceUnit.textContent = t.delta_resistance;
            
            // Global password overlay
            const globalOverlay = document.getElementById('global-password-overlay');
            if (globalOverlay) {
                const overlayTitle = globalOverlay.querySelector('h2');
                if (overlayTitle) overlayTitle.textContent = t.global_password_title;
                
                const overlayMessage = globalOverlay.querySelector('p');
                if (overlayMessage) overlayMessage.textContent = t.global_password_message;
                
                const passwordInput = document.getElementById('global-password-input');
                if (passwordInput) passwordInput.placeholder = t.global_password_placeholder;
                
                const accessBtn = globalOverlay.querySelector('button');
                if (accessBtn) accessBtn.textContent = t.global_password_button;
            }
            
            // Settings lock modal
            const lockTitle = document.getElementById('settings-lock-title');
            const lockDesc = document.getElementById('settings-lock-desc');
                const passwordInput = document.getElementById('settings-password');
            const unlockBtn = document.getElementById('settings-lock-unlock');
            const cancelBtn = document.getElementById('settings-lock-cancel');
                
            if (lockTitle) lockTitle.textContent = t.settings_password;
            if (lockDesc) lockDesc.textContent = t.settings_password_desc;
            if (passwordInput) passwordInput.placeholder = t.password;
                if (unlockBtn) unlockBtn.textContent = t.unlock;
            if (cancelBtn) cancelBtn.textContent = t.cancel;
            
            // Settings sections
            const settingsSections = document.querySelectorAll('.settings-section h3');
            // Cập nhật tiêu đề từng card nếu tồn tại (không phụ thuộc vào số lượng cố định)
            if (settingsSections[0]) settingsSections[0].textContent = t.voltage_settings;
            if (settingsSections[1]) settingsSections[1].textContent = t.current_settings;
            if (settingsSections[2]) settingsSections[2].textContent = t.time_settings;
            if (settingsSections[3]) settingsSections[3].textContent = t.temp_settings;
            if (settingsSections[4]) settingsSections[4].textContent = t.switch_settings;
            
            // Save buttons
            const saveButtons = document.querySelectorAll('.btn-save');
            if (saveButtons.length >= 1) {
                saveButtons[0].textContent = t.save_all_settings;
            }
            
            // Settings labels and tooltips
            updateSettingsLabels(lang);
            
            // Update status messages
            updateStatusMessages(lang);
        }

        // Update settings labels and tooltips
        function updateSettingsLabels(lang) {
            const t = translations[lang];
            console.log('Updating settings labels for language:', lang);
            
            // Voltage settings
            updateLabelAndTooltip('cell-overvoltage', t.cell_overvoltage, t.cell_overvoltage_tooltip);
            updateLabelAndTooltip('cell-overvoltage-recovery', t.cell_overvoltage_recovery, t.cell_overvoltage_recovery_tooltip);
            updateLabelAndTooltip('cell-undervoltage', t.cell_undervoltage, t.cell_undervoltage_tooltip);
            updateLabelAndTooltip('cell-undervoltage-recovery', t.cell_undervoltage_recovery, t.cell_undervoltage_recovery_tooltip);
            updateLabelAndTooltip('balance-trigger-voltage', t.balance_trigger_voltage, t.balance_trigger_voltage_tooltip);
            updateLabelAndTooltip('balance-start-voltage', t.balance_start_voltage, t.balance_start_voltage_tooltip);
            updateLabelAndTooltip('cell-soc100-voltage', t.cell_soc100_voltage, t.cell_soc100_voltage_tooltip);
            updateLabelAndTooltip('cell-soc0-voltage', t.cell_soc0_voltage, t.cell_soc0_voltage_tooltip);
            updateLabelAndTooltip('cell-request-charge-voltage', t.cell_request_charge_voltage, t.cell_request_charge_voltage_tooltip);
            updateLabelAndTooltip('cell-request-float-voltage', t.cell_request_float_voltage, t.cell_request_float_voltage_tooltip);
            updateLabelAndTooltip('smart-sleep-voltage', t.smart_sleep_voltage, t.smart_sleep_voltage_tooltip);
            updateLabelAndTooltip('power-off-voltage', t.power_off_voltage, t.power_off_voltage_tooltip);
            updateLabelAndTooltip('cell-count', t.cell_count, t.cell_count_tooltip);
            updateLabelAndTooltip('capacity', t.capacity, t.capacity_tooltip);
            
            // Current settings
            updateLabelAndTooltip('max-balance-current', t.max_balance_current, t.max_balance_current_tooltip);
            updateLabelAndTooltip('charge-current', t.charge_current, t.charge_current_tooltip);
            updateLabelAndTooltip('discharge-current', t.discharge_current, t.discharge_current_tooltip);
            updateLabelAndTooltip('current-calibration', t.current_calibration, t.current_calibration_tooltip);
            
            // Time settings
            updateLabelAndTooltip('charge-ocp-delay-s', t.charge_ocp_delay_s, t.charge_ocp_delay_s_tooltip);
            updateLabelAndTooltip('charge-ocpr-time-s', t.charge_ocpr_time_s, t.charge_ocpr_time_s_tooltip);
            updateLabelAndTooltip('discharge-ocp-delay-s', t.discharge_ocp_delay_s, t.discharge_ocp_delay_s_tooltip);
            updateLabelAndTooltip('discharge-ocpr-time-s', t.discharge_ocpr_time_s, t.discharge_ocpr_time_s_tooltip);
            updateLabelAndTooltip('scp-delay-us', t.scp_delay_us, t.scp_delay_us_tooltip);
            updateLabelAndTooltip('scp-recovery-time-s', t.scp_recovery_time_s, t.scp_recovery_time_s_tooltip);
            updateLabelAndTooltip('request-charge-voltage-time-h', t.request_charge_voltage_time_h, t.request_charge_voltage_time_h_tooltip);
            updateLabelAndTooltip('request-float-voltage-time-h', t.request_float_voltage_time_h, t.request_float_voltage_time_h_tooltip);
            updateLabelAndTooltip('discharge-precharge-time-s', t.discharge_precharge_time_s, t.discharge_precharge_time_s_tooltip);
            updateLabelAndTooltip('voltage-calibration', t.voltage_calibration, t.voltage_calibration_tooltip);
            
            // Temperature settings
            updateLabelAndTooltip('charge-overtemp', t.charge_overtemp, t.charge_overtemp_tooltip);
            updateLabelAndTooltip('charge-overtemp-recovery', t.charge_overtemp_recovery, t.charge_overtemp_recovery_tooltip);
            updateLabelAndTooltip('discharge-overtemp', t.discharge_overtemp, t.discharge_overtemp_tooltip);
            updateLabelAndTooltip('discharge-overtemp-recovery', t.discharge_overtemp_recovery, t.discharge_overtemp_recovery_tooltip);
            updateLabelAndTooltip('charge-undertemp', t.charge_undertemp, t.charge_undertemp_tooltip);
            updateLabelAndTooltip('charge-undertemp-recovery', t.charge_undertemp_recovery, t.charge_undertemp_recovery_tooltip);
            updateLabelAndTooltip('mos-overtemp', t.mos_overtemp, t.mos_overtemp_tooltip);
            updateLabelAndTooltip('mos-overtemp-recovery', t.mos_overtemp_recovery, t.mos_overtemp_recovery_tooltip);
            
            // Switch settings
            updateSwitchLabelAndTooltip('charge-mosfet-on', t.charge_mosfet_on, t.charge_mosfet_on_tooltip);
            updateSwitchLabelAndTooltip('discharge-mosfet-on', t.discharge_mosfet_on, t.discharge_mosfet_on_tooltip);
            updateSwitchLabelAndTooltip('balancer-on', t.balancer_on, t.balancer_on_tooltip);
            updateSwitchLabelAndTooltip('heating-on', t.heating_on, t.heating_on_tooltip);
            updateSwitchLabelAndTooltip('disable-temperature-sensors', t.disable_temperature_sensors, t.disable_temperature_sensors_tooltip);
            updateSwitchLabelAndTooltip('display-always-on', t.display_always_on, t.display_always_on_tooltip);
            updateSwitchLabelAndTooltip('smart-sleep-on', t.smart_sleep_on, t.smart_sleep_on_tooltip);
            updateSwitchLabelAndTooltip('disable-pcl-module', t.disable_pcl_module, t.disable_pcl_module_tooltip);
            updateSwitchLabelAndTooltip('timed-stored-data', t.timed_stored_data, t.timed_stored_data_tooltip);
            updateSwitchLabelAndTooltip('charging-float-mode', t.charging_float_mode, t.charging_float_mode_tooltip);
            updateSwitchLabelAndTooltip('emergency-mode', t.emergency_mode, t.emergency_mode_tooltip);
            
            console.log('Settings labels update completed');
        }

        // Helper function to update label and tooltip for input fields
        function updateLabelAndTooltip(inputId, labelText, tooltipText) {
            const input = document.getElementById(inputId);
            if (input) {
                // Tìm label - có thể là previousElementSibling hoặc trong form-group
                let label = input.previousElementSibling;
                if (!label || !label.classList.contains('tooltip-container')) {
                    // Thử tìm trong form-group
                    const formGroup = input.closest('.form-group');
                    if (formGroup) {
                        label = formGroup.querySelector('label.tooltip-container');
                    }
                }
                
                if (label && label.classList.contains('tooltip-container')) {
                    // Update the label text by replacing the first text node
                    let updated = false;
                    for (let i = 0; i < label.childNodes.length; i++) {
                        const node = label.childNodes[i];
                        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                            node.textContent = labelText;
                            updated = true;
                            console.log('Updated label for', inputId, 'to:', labelText);
                            break;
                        }
                    }
                    
                    if (!updated) {
                        // Thử cách khác - tìm text node đầu tiên
                        const textNodes = [];
                        function findTextNodes(element) {
                            for (let i = 0; i < element.childNodes.length; i++) {
                                const node = element.childNodes[i];
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                    textNodes.push(node);
                                } else if (node.nodeType === Node.ELEMENT_NODE) {
                                    findTextNodes(node);
                                }
                            }
                        }
                        findTextNodes(label);
                        if (textNodes.length > 0) {
                            textNodes[0].textContent = labelText;
                            updated = true;
                            console.log('Updated label for', inputId, 'using alternative method');
                        }
                    }
                    
                    if (!updated) {
                        console.log('Could not find text node for', inputId);
                    }
                    
                    const tooltipElement = label.querySelector('.tooltip-text');
                    if (tooltipElement) {
                        tooltipElement.textContent = tooltipText;
                        console.log('Updated tooltip for', inputId);
                    } else {
                        console.log('No tooltip element found for', inputId);
                    }
                } else {
                    console.log('Label not found for', inputId);
                }
            } else {
                console.log('Input element not found:', inputId);
            }
        }

        // Helper function to update label and tooltip for switch fields
        function updateSwitchLabelAndTooltip(switchId, labelText, tooltipText) {
            const switchInput = document.getElementById(switchId);
            if (!switchInput) { console.log('Switch input element not found:', switchId); return; }

            // New layout: switch-item with a div.label next to the switch
            const switchItem = switchInput.closest('.switch-item');
            if (switchItem) {
                const labelDiv = switchItem.querySelector('.label');
                if (labelDiv) {
                    labelDiv.textContent = labelText;
                    console.log('Updated switch-item label for', switchId, 'to:', labelText);
                    return; // In new layout we don't have tooltip for switches
                }
            }

            // Fallback: legacy layout with label.tooltip-container
                const switchContainer = switchInput.closest('.form-group');
            if (!switchContainer) { console.log('Switch container not found for', switchId); return; }

                    const label = switchContainer.querySelector('label.tooltip-container');
            if (!label) { console.log('Switch label not found for', switchId); return; }

                        let updated = false;
                        for (let i = 0; i < label.childNodes.length; i++) {
                            const node = label.childNodes[i];
                            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                node.textContent = labelText;
                                updated = true;
                                console.log('Updated switch label for', switchId, 'to:', labelText);
                                break;
                            }
                        }
            if (!updated) console.log('Could not find text node for switch', switchId);
                        
                        const tooltipElement = label.querySelector('.tooltip-text');
                        if (tooltipElement) {
                            tooltipElement.textContent = tooltipText;
                            console.log('Updated switch tooltip for', switchId);
            }
        }

        // Update status messages based on language
        function updateStatusMessages(lang) {
            const t = translations[lang];
            
            // Update connection status
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                if (connectionStatus.textContent.includes('Online')) {
                    connectionStatus.textContent = t.online;
                } else if (connectionStatus.textContent.includes('Offline')) {
                    connectionStatus.textContent = t.offline;
                }
            }
            
            // Update charge status
            const chargeStatus = document.getElementById('charge-status');
            if (chargeStatus) {
                if (chargeStatus.textContent.includes('Đang sạc') || chargeStatus.textContent.includes('Charging')) {
                    chargeStatus.textContent = t.charging;
                } else if (chargeStatus.textContent.includes('Đang xả') || chargeStatus.textContent.includes('Discharging')) {
                    chargeStatus.textContent = t.discharging;
                } else {
                    chargeStatus.textContent = t.not_charging_status;
                }
            }
            
            // Update balance status
            const balanceStatus = document.getElementById('balance-status');
            if (balanceStatus) {
                if (balanceStatus.textContent.includes('Đang cân bằng') || balanceStatus.textContent.includes('Balancing')) {
                    balanceStatus.textContent = t.balancing;
                } else {
                    balanceStatus.textContent = t.not_balancing_status;
                }
            }
            
            // Update alerts title and container
            const alertsTitle = document.getElementById('alerts-title');
            if (alertsTitle) { alertsTitle.textContent = (lang === 'vi') ? 'CẢNH BÁO' : 'ALERTS'; }
            const alertsContainer = document.getElementById('alerts');
            if (alertsContainer) {
                if (!alertsContainer.children.length) {
                    alertsContainer.innerHTML = `<div class="alert" id="no-alerts-text">${t.no_alerts}</div>`;
                } else {
                    const empty = alertsContainer.querySelector('#no-alerts-text');
                    if (empty) empty.textContent = t.no_alerts;
                }
            }
        }

        // Update monitor titles/labels and force uppercase
        function updateMonitorTexts(lang){
            const t = translations[lang];
            // Titles
            const titleMap = [
                t.main_info,
                t.temperature,
                t.cell_info,
                t.cell_voltages,
                t.cell_resistances,
                (lang === 'vi' ? 'ĐIỀU KHIỂN MÔ-ĐUN CẦU NỐI BMS' : 'BMS BRIDGE MODULE CONTROL'),
                t.alerts
            ];
            const cardTitles = document.querySelectorAll('.card h3');
            for (let i = 0; i < cardTitles.length && i < titleMap.length; i++) {
                cardTitles[i].textContent = titleMap[i].toUpperCase();
            }
            // Update metric labels (Vietnamese texts were static before)
            const metricLabels = document.querySelectorAll('.metric-label');
            if (metricLabels.length >= 17) {
                // Main information 6 items
                metricLabels[0].textContent  = t.voltage;            // Voltage (V)
                metricLabels[1].textContent  = t.current;            // Current (A)
                metricLabels[2].textContent  = t.battery_percent;    // Battery Percentage (%)
                metricLabels[3].textContent  = t.power;              // Power (W)
                metricLabels[4].textContent  = t.current_capacity;   // Current Capacity (Ah)
                metricLabels[5].textContent  = t.total_capacity;     // Maximum Capacity (Ah)

                // Temperature 3 items
                metricLabels[6].textContent  = t.temp_sensor1;       // Sensor 1 (°C)
                metricLabels[7].textContent  = t.temp_sensor2;       // Sensor 2 (°C)
                metricLabels[8].textContent  = t.temp_mos;           // MOS (°C)

                // Cell voltages 4 items
                metricLabels[9].textContent  = t.min_voltage;        // Min voltage (V)
                metricLabels[10].textContent = t.max_voltage;        // Max voltage (V)
                metricLabels[11].textContent = t.avg_voltage;        // Avg voltage (V)
                metricLabels[12].textContent = t.delta_voltage;      // Delta voltage (V)

                // Resistances 4 items
                metricLabels[13].textContent = t.min_resistance;     // Min resistance (mΩ)
                metricLabels[14].textContent = t.max_resistance;     // Max resistance (mΩ)
                metricLabels[15].textContent = t.avg_resistance;     // Avg resistance (mΩ)
                metricLabels[16].textContent = t.delta_resistance;   // Delta resistance (mΩ)
            }
        }

        // Khởi động lại nguồn (ngắt 5s rồi bật lại)
        function powerCycleDevice() {
            openPowerCycleConfirm();
        }

        function openPowerCycleConfirm() {
            const m = document.getElementById('modal-power-cycle');
            if (m) {
                m.style.display = 'flex';
            }
        }

        function closePowerCycleConfirm() {
            const m = document.getElementById('modal-power-cycle');
            if (m) {
                m.style.display = 'none';
            }
        }

        function openRecoverSuccess() {
            const m = document.getElementById('modal-recover-success');
            if (m) {
                m.style.display = 'flex';
            }
        }

        function closeRecoverSuccess() {
            const m = document.getElementById('modal-recover-success');
            if (m) {
                m.style.display = 'none';
            }
        }

        async function confirmPowerCycle() {
            try {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'power_cycle', { qos: 1 });
                    closePowerCycleConfirm();
                    const successMsg = currentLang === 'vi' 
                        ? 'Đã gửi lệnh khởi động lại nguồn (5s) qua MQTT'
                        : 'Power cycle command sent via MQTT';
                    showAlert(successMsg, 'success');
                    } else {
                    const errorMsg = currentLang === 'vi' 
                        ? 'MQTT chưa kết nối'
                        : 'MQTT not connected';
                    showAlert(errorMsg, 'error');
                    }
            } catch (error) {
                const currentLang = document.getElementById('language-selector').value;
                const errorMsg = currentLang === 'vi' 
                    ? 'Lỗi khi khởi động lại nguồn'
                    : 'Error during power cycle';
                showAlert(errorMsg, 'error');
            }
        }

        // Custom stepper helper for number inputs
        function stepNumber(inputId, delta){
            const el = document.getElementById(inputId);
            if(!el) return;
            const step = parseFloat(el.step || '1');
            const current = parseFloat(el.value || '0') || 0;
            let next = current + delta;
            if (!isFinite(next)) next = current;
            const decimals = Math.max(0, (step.toString().split('.')[1] || '').length);
            el.value = next.toFixed(decimals);
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    </script>
</body>
</html>
