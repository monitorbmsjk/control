<!DOCTYPE html>

<html lang="vi">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BMS Central Dashboard - Admin</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: #f5f5f5;

            min-height: 100vh;

        }



        .dashboard-container {

            display: flex;

            min-height: 100vh;

        }



        /* Sidebar */

        .sidebar {

            width: 300px;

            background: #2c3e50;

            color: white;

            overflow-y: auto;

            box-shadow: 2px 0 10px rgba(0,0,0,0.1);

        }



        .sidebar-header {

            padding: 20px;

            background: #34495e;

            border-bottom: 1px solid #465c71;

        }



        .sidebar-header h2 {

            color: white;

            font-size: 1.3em;

            margin-bottom: 5px;

        }



        .sidebar-header p {

            color: #bdc3c7;

            font-size: 0.9em;

        }



        .device-list {

            padding: 10px;

        }



        .device-item {

            padding: 15px;

            margin: 5px 0;

            background: #34495e;

            border-radius: 8px;

            cursor: pointer;

            transition: all 0.3s;

            border-left: 4px solid transparent;

        }



        .device-item:hover {

            background: #3498db;

            transform: translateX(5px);

        }



        .device-item.active {

            background: #3498db;

            border-left-color: #e74c3c;

        }



        .device-item-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 8px;

        }



        .device-name {

            font-weight: bold;

            font-size: 1.1em;

        }



        .device-status {

            padding: 4px 8px;

            border-radius: 12px;

            font-size: 0.8em;

            font-weight: bold;

        }



        .status-online {

            background: #27ae60;

            color: white;

        }



        .status-offline {

            background: #e74c3c;

            color: white;

        }



        .device-info-small {

            font-size: 0.9em;

            color: #bdc3c7;

        }



        /* Main Content */

        .main-content {

            flex: 1;

            background: white;

            overflow-y: auto;

        }



        .main-header {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            padding: 30px;

            text-align: center;

        }



        .main-header h1 {

            font-size: 2.5em;

            margin-bottom: 10px;

        }



        .main-header p {

            font-size: 1.1em;

            opacity: 0.9;

        }



        .connection-status {

            background: white;

            border-radius: 15px;

            padding: 25px;

            margin: 20px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

            text-align: center;

        }



        .status-indicator {

            display: inline-block;

            width: 20px;

            height: 20px;

            border-radius: 50%;

            margin-right: 10px;

        }



        .status-connected {

            background: #28a745;

        }



        .status-disconnected {

            background: #dc3545;

        }



        .status-connecting {

            background: #ffc107;

            animation: pulse 1s infinite;

        }



        @keyframes pulse {

            0% { opacity: 1; }

            50% { opacity: 0.5; }

            100% { opacity: 1; }

        }



        /* BMS Interface (similar to index.html) */

        .bms-interface {

            padding: 20px;

            display: none;

        }



        .bms-interface.active {

            display: block;

        }



        .grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));

            gap: 20px;

            margin-bottom: 20px;

        }



        .card {

            background: white;

            border-radius: 15px;

            padding: 25px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

        }



        .card h3 {

            color: #333;

            margin-bottom: 20px;

            font-size: 1.3em;

            border-bottom: 2px solid #f0f0f0;

            padding-bottom: 10px;

        }



        .value {

            font-size: 2.5em;

            font-weight: bold;

            color: #3498db;

            text-align: center;

            margin-bottom: 10px;

        }



        .unit {

            text-align: center;

            color: #666;

            font-size: 1.1em;

        }



        .cell-grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));

            gap: 10px;

            margin-top: 15px;

        }



        .cell {

            background: #f8f9fa;

            border: 2px solid #e9ecef;

            border-radius: 8px;

            padding: 15px 10px;

            text-align: center;

            font-weight: bold;

            transition: all 0.3s;

        }



        .cell:hover {

            transform: scale(1.05);

            box-shadow: 0 5px 15px rgba(0,0,0,0.2);

        }



        .cell-number {

            font-size: 0.9em;

            color: #666;

            margin-bottom: 5px;

        }



        .cell-value {

            font-size: 1.1em;

            color: #333;

        }



        .voltage-high {

            background: #d4edda;

            border-color: #28a745;

            color: #155724;

        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #888;
            transition: .2s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(24px); }



        .voltage-low {

            background: #f8d7da;

            border-color: #dc3545;

            color: #721c24;

        }



        .voltage-normal {

            background: #d1ecf1;

            border-color: #17a2b8;

            color: #0c5460;

        }



        .resistance-high {

            background: #fff3cd;

            border-color: #ffc107;

            color: #856404;

        }



        .resistance-low {

            background: #d1ecf1;

            border-color: #17a2b8;

            color: #0c5460;

        }



        .resistance-normal {

            background: #d4edda;

            border-color: #28a745;

            color: #155724;

        }



        /* Control Buttons */

        .control-section {

            background: white;

            border-radius: 15px;

            padding: 25px;

            margin: 20px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

        }



        .control-section h2 {

            color: #333;

            margin-bottom: 20px;

            display: flex;

            align-items: center;

            gap: 10px;

        }



        .control-buttons {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 15px;

        }



        .btn {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            border: none;

            padding: 15px 25px;

            border-radius: 8px;

            font-size: 16px;

            cursor: pointer;

            transition: transform 0.2s;

        }



        .btn:hover {

            transform: translateY(-2px);

        }



        .btn-danger {

            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);

        }



        .btn-warning {

            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);

        }



        .btn-success {

            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);

        }



        /* Alerts */

        .alert {

            background: #f8d7da;

            color: #721c24;

            padding: 15px;

            border-radius: 8px;

            margin: 20px;

            border: 1px solid #f5c6cb;

        }



        .success {

            background: #d4edda;

            color: #155724;

            padding: 15px;

            border-radius: 8px;

            margin: 20px;

            border: 1px solid #c3e6cb;

        }



        /* Welcome Screen */

        .welcome-screen {

            text-align: center;

            padding: 100px 20px;

            color: #666;

        }



        .welcome-screen h2 {

            font-size: 2.5em;

            margin-bottom: 20px;

            color: #333;

        }



        .welcome-screen p {

            font-size: 1.2em;

            margin-bottom: 30px;

        }



        .welcome-icon {

            font-size: 5em;

            margin-bottom: 30px;

            opacity: 0.3;

        }



        /* Responsive */

        @media (max-width: 768px) {

            .dashboard-container {

                flex-direction: column;

            }

            

            .sidebar {

                width: 100%;

                height: auto;

            }

            

            .grid {

                grid-template-columns: 1fr;

            }

        }

        /* Tabs */

        .nav-tabs { display:flex; gap:10px; margin: 0 20px 10px; }

        .tab-btn { padding:10px 16px; border:none; border-radius:20px; cursor:pointer; background:#eef1f7; color:#333; font-weight:600; }

        .tab-btn.active { background:#667eea; color:#fff; }

        .tab-content { display:none; }

        .tab-content.active { display:block; }


        /* Settings Tab Styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #fff;
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="number"]:hover {
            border-color: #bbb;
        }

        .input-with-button {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button button {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
            min-width: 60px;
        }

        .input-with-button button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Switch Toggle Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Switch Container */
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .switch-container label {
            margin: 0;
            font-weight: 500;
            color: #333;
        }

        /* Settings Section Headers */
        .settings-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-section-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        /* Device Management Buttons */
        .device-management-buttons {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .device-management-buttons .btn {
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .device-management-buttons .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .device-management-buttons .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .device-management-buttons .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .device-management-buttons .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .device-management-buttons .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>

</head>

<body>

    <div class="dashboard-container">

        <!-- Sidebar -->

        <div class="sidebar">

            <div class="sidebar-header">

                <h2>üîß BMS Dashboard</h2>

                <p>Qu·∫£n l√Ω ESP32 BMS</p>

                <div class="device-management-buttons">
                    <button class="btn btn-primary" onclick="scanActiveDevices()">
                        üîç Scan thi·∫øt b·ªã
                    </button>
                    <button class="btn btn-danger" onclick="removeSelectedDevice()" id="remove-device-btn" disabled>
                        üóëÔ∏è X√≥a thi·∫øt b·ªã
                    </button>
                </div>
            </div>

            

            <div class="device-list" id="device-list">

                <!-- Devices will be populated here -->

            </div>

        </div>



        <!-- Main Content -->

        <div class="main-content">

            <div class="nav-tabs">

                <button class="tab-btn active" onclick="showTab('monitor')">Th√¥ng s·ªë pin</button>

                <button class="tab-btn" onclick="showTab('settings')">C√†i ƒë·∫∑t</button>

            </div>

            <div id="monitor-tab" class="tab-content active">




            <div id="alerts"></div>



            <!-- Welcome Screen -->

            <div class="welcome-screen" id="welcome-screen">

                <div class="welcome-icon">üîã</div>

                <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi BMS Dashboard</h2>

                <p>Ch·ªçn m·ªôt ESP32 t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu gi√°m s√°t</p>

            </div>



            <!-- BMS Interface -->

            <div class="bms-interface" id="bms-interface">

                <!-- Main Header -->

                <div class="main-header">

                    <h1 id="selected-device-title">ESP32 BMS Monitor</h1>

                    <p id="selected-device-subtitle">Gi√°m s√°t th·ªùi gian th·ª±c</p>

                </div>



                <!-- Main Info Grid -->

                <div class="grid">

                    <div class="card">

                        <h3>üîã Th√¥ng tin ch√≠nh</h3>

                        <div class="value" id="battery-voltage">--</div>

                        <div class="unit">ƒêi·ªán √°p (V)</div>

                    </div>

                    

                    <div class="card">

                        <h3>‚ö° D√≤ng ƒëi·ªán</h3>

                        <div class="value" id="current">--</div>

                        <div class="unit">D√≤ng ƒëi·ªán (A)</div>

                    </div>

                    

                    <div class="card">

                        <h3>üìä M·ª©c s·∫°c</h3>

                        <div class="value" id="soc">--</div>

                        <div class="unit">SOC (%)</div>

                    </div>

                    

                    <div class="card">

                        <h3>üí™ C√¥ng su·∫•t</h3>

                        <div class="value" id="power">--</div>

                        <div class="unit">C√¥ng su·∫•t (W)</div>

                    </div>

                </div>



                <!-- Temperature Grid -->

                <div class="grid">

                    <div class="card">

                        <h3>üå°Ô∏è Nhi·ªát ƒë·ªô</h3>

                        <div class="value" id="temp1">--</div>

                        <div class="unit">Nhi·ªát ƒë·ªô 1 (¬∞C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>üå°Ô∏è Nhi·ªát ƒë·ªô 2</h3>

                        <div class="value" id="temp2">--</div>

                        <div class="unit">Nhi·ªát ƒë·ªô 2 (¬∞C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>üî• Nhi·ªát ƒë·ªô MOS</h3>

                        <div class="value" id="temp-mos">--</div>

                        <div class="unit">Nhi·ªát ƒë·ªô MOS (¬∞C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>üìà Dung l∆∞·ª£ng</h3>

                        <div class="value" id="current-capacity">--</div>

                        <div class="unit">Dung l∆∞·ª£ng hi·ªán t·∫°i (Ah)</div>

                        <div class="value" id="total-capacity">--</div>

                        <div class="unit">Dung l∆∞·ª£ng t·ªëi ƒëa (Ah)</div>

                        <div class="value" id="charge-cycles">--</div>

                        <div class="unit">Chu k·ª≥ s·∫°c</div>

                    </div>

                </div>



                <!-- Cell Information -->

                <div class="grid">

                    <div class="card">

                        <h3>üîã Th√¥ng tin Cell</h3>

                        <div class="value" id="min-voltage">--</div>

                        <div class="unit">ƒêi·ªán √°p th·∫•p nh·∫•t (V)</div>

                        <div class="value" id="max-voltage">--</div>

                        <div class="unit">ƒêi·ªán √°p cao nh·∫•t (V)</div>

                        <div class="value" id="avg-voltage">--</div>

                        <div class="unit">ƒêi·ªán √°p trung b√¨nh (V)</div>

                        <div class="value" id="delta-voltage">--</div>

                        <div class="unit">Ch√™nh l·ªách ƒëi·ªán √°p (V)</div>

                    </div>

                    

                    <div class="card">

                        <h3>‚ö° ƒêi·ªán tr·ªü Cell</h3>

                        <div class="value" id="min-resistance">--</div>

                        <div class="unit">ƒêi·ªán tr·ªü th·∫•p nh·∫•t (mŒ©)</div>

                        <div class="value" id="max-resistance">--</div>

                        <div class="unit">ƒêi·ªán tr·ªü cao nh·∫•t (mŒ©)</div>

                        <div class="value" id="avg-resistance">--</div>

                        <div class="unit">ƒêi·ªán tr·ªü trung b√¨nh (mŒ©)</div>

                        <div class="value" id="delta-resistance">--</div>

                        <div class="unit">Ch√™nh l·ªách ƒëi·ªán tr·ªü (mŒ©)</div>

                    </div>

                </div>



                <!-- Cell Voltage Grid -->

                <div class="card">

                    <h3>üîã ƒêi·ªán √°p Cell</h3>

                    <div class="cell-grid" id="cell-grid">

                        <!-- Cell voltages will be populated here -->

                    </div>

                </div>



                <!-- Cell Resistance Grid -->

                <div class="card">

                    <h3>‚ö° ƒêi·ªán tr·ªü Cell</h3>

                    <div class="cell-grid" id="resistance-grid">

                        <!-- Cell resistances will be populated here -->

                    </div>

                </div>



                <!-- Control Section -->

                <div class="control-section">

                    <h2>üõ°Ô∏è Qu·∫£n l√Ω BMS</h2>

                    <div class="control-buttons">

                        <button id="btn-emergency" class="btn btn-danger" onclick="openEmergencyConfirm()">üõë D·ª´ng kh·∫©n c·∫•p</button>

                        <button id="btn-recover" class="btn btn-primary" style="display:none;" onclick="openRecoverConfirm()">üîÑ Kh·ªüi ƒë·ªông l·∫°i BMS</button>

                        <button class="btn btn-warning" onclick="restartDevice()">üîÑ Ch·∫ø ƒë·ªô thi·∫øt l·∫≠p </button>

                        <button class="btn btn-info" onclick="powerCycleDevice()"> Reset th·ªß c√¥ng </button>

                    </div>

                </div>

                <!-- Emergency confirm modal -->
                <div id="modal-emergency" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:12px; padding:20px; max-width:420px; width:92%;">
                        <h3 style="margin-bottom:10px;">X√°c nh·∫≠n d·ª´ng kh·∫©n c·∫•p</h3>
                        <p style="color:#555;">H·ªá th·ªëng s·∫Ω t·∫Øt s·∫°c, x·∫£, c√¢n b·∫±ng, s∆∞·ªüi v√† b·∫≠t ch·∫ø ƒë·ªô kh·∫©n c·∫•p ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n.</p>
                        <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                            <button class="btn btn-secondary" onclick="closeEmergencyConfirm()">H·ªßy</button>
                            <button class="btn btn-danger" onclick="confirmEmergency()">X√°c nh·∫≠n</button>
                        </div>
                    </div>
                </div>

                <!-- Recover confirm modal -->
                <div id="modal-recover" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:12px; padding:20px; max-width:520px; width:92%;">
                        <h3 style="margin-bottom:10px;">Kh·ªüi ƒë·ªông l·∫°i BMS</h3>
                        <p style="color:#555;">Ch·ªçn tr·∫°ng th√°i c·∫ßn ph·ª•c h·ªìi. M·∫∑c ƒë·ªãnh kh√¥i ph·ª•c theo tr∆∞·ªõc khi d·ª´ng kh·∫©n c·∫•p.</p>
                        <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <label>Charge MOSFET
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-charge" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Discharge MOSFET
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-discharge" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Balancer
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-balancer" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Heating
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-heating" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                            <button class="btn btn-secondary" onclick="closeRecoverConfirm()">H·ªßy</button>
                            <button class="btn btn-primary" onclick="confirmRecover()">X√°c nh·∫≠n</button>
                        </div>
                    </div>
                </div>

            </div>

            </div> <!-- end monitor-tab -->



            <div id="settings-tab" class="tab-content">

                <div class="grid">

                    <div class="card">

                        <div class="settings-section-header">
                        <h3>‚ö° ƒêi·ªán √°p</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ng∆∞·ª°ng cao √°p cell (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-overvoltage" step="0.001" placeholder="3.65">
                                    <button onclick="saveSingleSetting('cell_overvoltage','cell-overvoltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Kh√¥i ph·ª•c cao √°p (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-overvoltage-recovery" step="0.001" placeholder="3.40">
                                    <button onclick="saveSingleSetting('cell_overvoltage_recovery','cell-overvoltage-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ng∆∞·ª°ng th·∫•p √°p cell (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-undervoltage" step="0.001" placeholder="3.00">
                                    <button onclick="saveSingleSetting('cell_undervoltage','cell-undervoltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Kh√¥i ph·ª•c th·∫•p √°p (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-undervoltage-recovery" step="0.001" placeholder="3.20">
                                    <button onclick="saveSingleSetting('cell_undervoltage_recovery','cell-undervoltage-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ng∆∞·ª°ng c√¢n b·∫±ng (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="balance-trigger-voltage" step="0.001" placeholder="0.10">
                                    <button onclick="saveSingleSetting('balance_trigger_voltage','balance-trigger-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p b·∫Øt ƒë·∫ßu c√¢n b·∫±ng (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="balance-start-voltage" step="0.001" placeholder="4.10">
                                    <button onclick="saveSingleSetting('balance_start_voltage','balance-start-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p khi pin 100% (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-soc100-voltage" step="0.001" placeholder="3.65">
                                    <button onclick="saveSingleSetting('cell_soc100_voltage','cell-soc100-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p khi pin 0% (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-soc0-voltage" step="0.001" placeholder="3.00">
                                    <button onclick="saveSingleSetting('cell_soc0_voltage','cell-soc0-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p y√™u c·∫ßu s·∫°c (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-request-charge-voltage" step="0.001" placeholder="3.455">
                                    <button onclick="saveSingleSetting('cell_request_charge_voltage','cell-request-charge-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p duy tr√¨ (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-request-float-voltage" step="0.001" placeholder="3.401">
                                    <button onclick="saveSingleSetting('cell_request_float_voltage','cell-request-float-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p ng·ªß th√¥ng minh (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="smart-sleep-voltage" step="0.001" placeholder="0.003">
                                    <button onclick="saveSingleSetting('smart_sleep_voltage','smart-sleep-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒêi·ªán √°p t·∫Øt ngu·ªìn (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="power-off-voltage" step="0.001" placeholder="3.40">
                                    <button onclick="saveSingleSetting('power_off_voltage','power-off-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>S·ªë l∆∞·ª£ng cell</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-count" step="1" min="2" max="32" placeholder="16">
                                    <button onclick="saveSingleSetting('cell_count','cell-count')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>T·ªïng dung l∆∞·ª£ng (Ah)</label>
                                <div class="input-with-button">
                                    <input type="number" id="capacity" step="0.1" placeholder="280.0">
                                    <button onclick="saveSingleSetting('capacity','capacity')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>‚ö° D√≤ng ƒëi·ªán</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>D√≤ng c√¢n b·∫±ng t·ªëi ƒëa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="max-balance-current" step="0.1" placeholder="0.3">
                                    <button onclick="saveSingleSetting('max_balance_current','max-balance-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>D√≤ng s·∫°c t·ªëi ƒëa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-current" step="0.1" placeholder="50.0">
                                    <button onclick="saveSingleSetting('charge_current','charge-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>D√≤ng x·∫£ t·ªëi ƒëa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-current" step="0.1" placeholder="50.0">
                                    <button onclick="saveSingleSetting('discharge_current','discharge-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hi·ªáu chu·∫©n d√≤ng ƒëi·ªán</label>
                                <div class="input-with-button">
                                    <input type="number" id="current-calibration" step="0.001" placeholder="2.0">
                                    <button onclick="saveSingleSetting('current_calibration','current-calibration')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>‚è±Ô∏è Th·ªùi gian & ƒê·ªô tr·ªÖ</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ƒê·ªô tr·ªÖ qu√° d√≤ng s·∫°c (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-ocp-delay-s" step="1" placeholder="40">
                                    <button onclick="saveSingleSetting('charge_ocp_delay_s','charge-ocp-delay-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian kh√¥i ph·ª•c qu√° d√≤ng s·∫°c (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-ocpr-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('charge_ocpr_time_s','charge-ocpr-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒê·ªô tr·ªÖ qu√° d√≤ng x·∫£ (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-ocp-delay-s" step="1" placeholder="300">
                                    <button onclick="saveSingleSetting('discharge_ocp_delay_s','discharge-ocp-delay-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian kh√¥i ph·ª•c qu√° d√≤ng x·∫£ (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-ocpr-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('discharge_ocpr_time_s','discharge-ocpr-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒê·ªô tr·ªÖ ng·∫Øn m·∫°ch (Œºs)</label>
                                <div class="input-with-button">
                                    <input type="number" id="scp-delay-us" step="1" placeholder="2000">
                                    <button onclick="saveSingleSetting('scp_delay_us','scp-delay-us')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian kh√¥i ph·ª•c ng·∫Øn m·∫°ch (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="scp-recovery-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('scp_recovery_time_s','scp-recovery-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian y√™u c·∫ßu s·∫°c (h)</label>
                                <div class="input-with-button">
                                    <input type="number" id="request-charge-voltage-time-h" step="0.1" placeholder="2.0">
                                    <button onclick="saveSingleSetting('request_charge_voltage_time_h','request-charge-voltage-time-h')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian ƒëi·ªán √°p duy tr√¨ (h)</label>
                                <div class="input-with-button">
                                    <input type="number" id="request-float-voltage-time-h" step="0.1" placeholder="9.0">
                                    <button onclick="saveSingleSetting('request_float_voltage_time_h','request-float-voltage-time-h')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian precharge x·∫£ (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-precharge-time-s" step="1" placeholder="0">
                                    <button onclick="saveSingleSetting('discharge_precharge_time_s','discharge-precharge-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hi·ªáu chu·∫©n ƒëi·ªán √°p</label>
                                <div class="input-with-button">
                                    <input type="number" id="voltage-calibration" step="0.01" placeholder="15.00">
                                    <button onclick="saveSingleSetting('voltage_calibration','voltage-calibration')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>üå°Ô∏è Nhi·ªát ƒë·ªô</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô qu√° cao s·∫°c (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-overtemp" step="0.1" placeholder="66.0">
                                    <button onclick="saveSingleSetting('charge_overtemp','charge-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô kh√¥i ph·ª•c s·∫°c (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-overtemp-recovery" step="0.1" placeholder="61.0">
                                    <button onclick="saveSingleSetting('charge_overtemp_recovery','charge-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô qu√° cao x·∫£ (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-overtemp" step="0.1" placeholder="77.0">
                                    <button onclick="saveSingleSetting('discharge_overtemp','discharge-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô kh√¥i ph·ª•c x·∫£ (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-overtemp-recovery" step="0.1" placeholder="65.0">
                                    <button onclick="saveSingleSetting('discharge_overtemp_recovery','discharge-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô qu√° th·∫•p s·∫°c (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-undertemp" step="0.1" placeholder="-22.0">
                                    <button onclick="saveSingleSetting('charge_undertemp','charge-undertemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô kh√¥i ph·ª•c s·∫°c (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-undertemp-recovery" step="0.1" placeholder="-9.0">
                                    <button onclick="saveSingleSetting('charge_undertemp_recovery','charge-undertemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô qu√° cao MOSFET (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="mos-overtemp" step="0.1" placeholder="99.0">
                                    <button onclick="saveSingleSetting('mos_overtemp','mos-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhi·ªát ƒë·ªô kh√¥i ph·ª•c MOSFET (¬∞C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="mos-overtemp-recovery" step="0.1" placeholder="78.0">
                                    <button onclick="saveSingleSetting('mos_overtemp_recovery','mos-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>üéöÔ∏è C√¥ng t·∫Øc ƒëi·ªÅu khi·ªÉn</h3>

                        </div>

                        <div class="form-row">
                            <div class="switch-container">
                                <label>MOSFET s·∫°c</label>
                                <label class="switch">
                                    <input type="checkbox" id="charge-mosfet-on" onchange="saveSwitch('charge_mosfet_on','charge-mosfet-on')">
                                    <span class="slider"></span>
                                </label>
                    </div>

                            <div class="switch-container">
                                <label>MOSFET x·∫£</label>
                                <label class="switch">
                                    <input type="checkbox" id="discharge-mosfet-on" onchange="saveSwitch('discharge_mosfet_on','discharge-mosfet-on')">
                                    <span class="slider"></span>
                                </label>
                </div>

                            <div class="switch-container">
                                <label>B·ªô c√¢n b·∫±ng</label>
                                <label class="switch">
                                    <input type="checkbox" id="balancer-on" onchange="saveSwitch('balancer_on','balancer-on')">
                                    <span class="slider"></span>
                                </label>
            </div>

                            <div class="switch-container">
                                <label>S∆∞·ªüi ·∫•m</label>
                                <label class="switch">
                                    <input type="checkbox" id="heating-on" onchange="saveSwitch('heating_on','heating-on')">
                                    <span class="slider"></span>
                                </label>
                        </div>

                            <div class="switch-container">
                                <label>T·∫Øt c·∫£m bi·∫øn nhi·ªát</label>
                                <label class="switch">
                                    <input type="checkbox" id="disable-temperature-sensors" onchange="saveSwitch('disable_temperature_sensors','disable-temperature-sensors')">
                                    <span class="slider"></span>
                                </label>
                    </div>

                            <div class="switch-container">
                                <label>M√†n h√¨nh lu√¥n s√°ng</label>
                                <label class="switch">
                                    <input type="checkbox" id="display-always-on" onchange="saveSwitch('display_always_on','display-always-on')">
                                    <span class="slider"></span>
                                </label>
                </div>

                            <div class="switch-container">
                                <label>Ng·ªß th√¥ng minh</label>
                                <label class="switch">
                                    <input type="checkbox" id="smart-sleep-on" onchange="saveSwitch('smart_sleep_on','smart-sleep-on')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>T·∫Øt module PCL</label>
                                <label class="switch">
                                    <input type="checkbox" id="disable-pcl-module" onchange="saveSwitch('disable_pcl_module','disable-pcl-module')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>L∆∞u d·ªØ li·ªáu theo th·ªùi gian</label>
                                <label class="switch">
                                    <input type="checkbox" id="timed-stored-data" onchange="saveSwitch('timed_stored_data','timed-stored-data')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Ch·∫ø ƒë·ªô float s·∫°c</label>
                                <label class="switch">
                                    <input type="checkbox" id="charging-float-mode" onchange="saveSwitch('charging_float_mode','charging-float-mode')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Ch·∫ø ƒë·ªô kh·∫©n c·∫•p</label>
                                <label class="switch">
                                    <input type="checkbox" id="emergency-mode" onchange="saveSwitch('emergency_mode','emergency-mode')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </div>



    <script>

        // MQTT Configuration

        const mqttConfig = {

            host: 'broker.hivemq.com',

            port: 8884, // WebSocket port

            path: '/mqtt',

            clientId: 'BMS_Dashboard_' + Math.random().toString(16).substr(2, 8)

        };



        let mqttClient = null;

        let devices = new Map(); // Map ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin thi·∫øt b·ªã

        let selectedDeviceId = null; // ID c·ªßa thi·∫øt b·ªã ƒë∆∞·ª£c ch·ªçn

        let reconnectAttempts = 0;

        const maxReconnectAttempts = 5;



        // Monitor/control refresh (UI only; data push qua MQTT)

        let autoRefresh = true;

        let refreshMs = 3000;

        let refreshTimer = null;



        function setRefreshMs(val){

            refreshMs = parseInt(val,10) || 3000;

            const lbl=document.getElementById('refresh-label');

            if(lbl) lbl.textContent = `ƒêang c·∫≠p nh·∫≠t m·ªói ${refreshMs} ms`;

            if (autoRefresh){

                if (refreshTimer){ clearInterval(refreshTimer); }

                refreshTimer = setInterval(()=>{/* UI refresh hook if needed */}, refreshMs);

            }

        }



        function toggleAutoRefresh(){

            autoRefresh = !autoRefresh;

            if (autoRefresh){

                if (refreshTimer){ clearInterval(refreshTimer); }

                refreshTimer = setInterval(()=>{/* UI refresh hook if needed */}, refreshMs);

            } else if (refreshTimer){

                clearInterval(refreshTimer); refreshTimer=null;

            }

        }



        function showTab(tab){

            const tabs = document.querySelectorAll('.tab-content');

            tabs.forEach(t=>t.classList.remove('active'));

            const btns = document.querySelectorAll('.tab-btn');

            btns.forEach(b=>b.classList.remove('active'));

            const target = document.getElementById(`${tab}-tab`);

            if(target) target.classList.add('active');

            if(tab==='monitor' && btns[0]) btns[0].classList.add('active');

            if(tab==='settings' && btns[1]) btns[1].classList.add('active');

            if(tab==='control' && btns[2]) btns[2].classList.add('active');

        }



        // K·∫øt n·ªëi MQTT

        function connectMQTT() {

            try {

                const url = `wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;

                

                mqttClient = mqtt.connect(url, {

                    clientId: mqttConfig.clientId,

                    clean: true,

                    reconnectPeriod: 5000,

                    connectTimeout: 30000

                });



                mqttClient.on('connect', () => {

                    console.log('MQTT k·∫øt n·ªëi th√†nh c√¥ng!');

                    showAlert('K·∫øt n·ªëi MQTT th√†nh c√¥ng!', 'success');

                    reconnectAttempts = 0;

                    

                    // Subscribe v√†o t·∫•t c·∫£ topics

                    subscribeToTopics();

                });



                mqttClient.on('message', (topic, message) => {

                    handleMQTTMessage(topic, message.toString());

                });



                mqttClient.on('error', (error) => {

                    console.error('MQTT error:', error);

                    showAlert('L·ªói k·∫øt n·ªëi MQTT: ' + error.message, 'error');

                });



                mqttClient.on('close', () => {

                    console.log('MQTT k·∫øt n·ªëi ƒë√≥ng');

                    if (reconnectAttempts < maxReconnectAttempts) {

                        reconnectAttempts++;

                        setTimeout(connectMQTT, 5000);

                    }

                });



            } catch (error) {

                console.error('L·ªói k·∫øt n·ªëi MQTT:', error);

                showAlert('L·ªói k·∫øt n·ªëi MQTT: ' + error.message, 'error');

            }

        }



        // ===== MQTT command publishers for remote control =====

        function ensureMqttConnected(){

            if (!mqttClient || !mqttClient.connected){

                showAlert('MQTT ch∆∞a k·∫øt n·ªëi', 'error');

                return false;

            }

            if (!selectedDeviceId){

                showAlert('Ch∆∞a ch·ªçn thi·∫øt b·ªã', 'error');

                return false;

            }

            return true;

        }



        // Publish a single setting { key: value } to bms/<id>/cmd/settings

        function saveSingleSetting(settingKey, elementId){

            const el = document.getElementById(elementId);

            if (!el){ showAlert('Kh√¥ng t√¨m th·∫•y input: '+elementId,'error'); return; }

            const raw = el.value;

            const value = Number(raw);

            if (Number.isNaN(value)) { showAlert('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá!', 'error'); return; }

            if (!ensureMqttConnected()) return;

            const cmd = {}; cmd[settingKey] = value;

            const topic = `bms/esp32_001/cmd/settings`;
            try{

                mqttClient.publish(topic, JSON.stringify(cmd), { qos: 1 });

                showAlert(`ƒê√£ g·ª≠i c√†i ƒë·∫∑t ${settingKey}=${value}`,'success');

            }catch(e){ showAlert('L·ªói g·ª≠i MQTT','error'); }

        }



        // Publish a switch toggle { key: boolean } to bms/<id>/cmd/switches

        function saveSwitch(switchKey, elementId){

            const el = document.getElementById(elementId);

            if (!el){ showAlert('Kh√¥ng t√¨m th·∫•y c√¥ng t·∫Øc: '+elementId,'error'); return; }

            const value = !!el.checked;

            if (!ensureMqttConnected()) return;

            const cmd = {}; cmd[switchKey] = value;

            const topic = `bms/esp32_001/cmd/switches`;
            try{

                mqttClient.publish(topic, JSON.stringify(cmd), { qos: 1 });

                showAlert(`ƒê√£ g·ª≠i c√¥ng t·∫Øc ${switchKey}=${value}`,'success');

            }catch(e){ showAlert('L·ªói g·ª≠i MQTT','error'); }

        }



        // Publish simple action string to bms/<id>/cmd/action

        function publishCommand(deviceId, action){

            if (!ensureMqttConnected()) return;

            const topic = `bms/${deviceId}/cmd/action`;

            try{

                mqttClient.publish(topic, action, { qos: 1 });

                showAlert(`ƒê√£ g·ª≠i l·ªánh: ${action}`,'success');

            }catch(e){ showAlert('L·ªói g·ª≠i MQTT','error'); }

        }

        // Publish settings object to bms/<id>/cmd/settings for recovery
        function publishSettingsCommand(deviceId, settings){
            if (!ensureMqttConnected()) return;
            const topic = `bms/${deviceId}/cmd/settings`;
            try{
                mqttClient.publish(topic, JSON.stringify(settings), { qos: 1 });
                showAlert(`ƒê√£ g·ª≠i c√†i ƒë·∫∑t kh√¥i ph·ª•c cho ${deviceId}`,'success');
            }catch(e){ showAlert('L·ªói g·ª≠i MQTT settings','error'); }
        }



        // Subscribe v√†o c√°c topics

        function subscribeToTopics() {

            if (mqttClient && mqttClient.connected) {

                // Subscribe v√†o t·∫•t c·∫£ topics BMS

                mqttClient.subscribe('bms/+/data');

                mqttClient.subscribe('bms/+/status');

                mqttClient.subscribe('bms/+/online');

                

                console.log('ƒê√£ subscribe v√†o topics BMS');

            }

        }



        // X·ª≠ l√Ω tin nh·∫Øn MQTT

        function handleMQTTMessage(topic, message) {

            const topicParts = topic.split('/');

            const deviceId = topicParts[1];

            const messageType = topicParts[2];



            if (!devices.has(deviceId)) {

                devices.set(deviceId, {

                    id: deviceId,

                    status: 'offline',

                    lastSeen: Date.now(),

                    data: {},

                    info: {}

                });

            }



            const device = devices.get(deviceId);

            device.lastSeen = Date.now();



            // online l√† plain text, kh√¥ng ph·∫£i JSON

            if (messageType === 'online') {

                const txt = (message || '').toString().trim();

                device.status = (txt === 'online') ? 'online' : 'offline';

                updateDeviceList();

                if (selectedDeviceId === deviceId) updateBMSInterface(device);

                return;

            }



            try {

                const data = JSON.parse(message);

                if (messageType === 'data') {

                    device.data = data;

                    device.status = 'online';

                } else if (messageType === 'status') {

                    device.info = data;

                    device.status = 'online';

                }



                updateDeviceList();

                if (selectedDeviceId === deviceId) {

                    updateBMSInterface(device);

                }

            } catch (error) {

                console.error('L·ªói x·ª≠ l√Ω tin nh·∫Øn MQTT:', error);

            }

        }



        // C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã

        function updateDeviceList() {

            const deviceList = document.getElementById('device-list');

            deviceList.innerHTML = '';

            

            devices.forEach((device, deviceId) => {

                const deviceItem = createDeviceItem(device);

                deviceList.appendChild(deviceItem);

            });

        }



        // T·∫°o item thi·∫øt b·ªã

        function createDeviceItem(device) {

            const item = document.createElement('div');

            item.className = `device-item ${selectedDeviceId === device.id ? 'active' : ''}`;

            item.onclick = () => selectDevice(device.id);

            

            const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';

            const statusText = device.status === 'online' ? 'Online' : 'Offline';

            

            const vTxt = (device.data && typeof device.data.v === 'number') ? device.data.v.toFixed(2) + 'V' : '--';

            const socTxt = (device.data && typeof device.data.soc === 'number') ? device.data.soc + '%' : '--';

            const rssi = (device.info && typeof device.info.wifi_rssi === 'number') ? `RSSI ${device.info.wifi_rssi}` : '--';



            item.innerHTML = `

                <div class="device-item-header">

                    <div class="device-name">ESP32 ${device.id}</div>

                    <div class="device-status ${statusClass}">${statusText}</div>

                </div>

                <div class="device-info-small">

                    ${vTxt} | ${socTxt} | ${rssi}

                </div>

            `;

            

            return item;

        }



        // Ch·ªçn thi·∫øt b·ªã

        function selectDevice(deviceId) {

            selectedDeviceId = deviceId;

            const device = devices.get(deviceId);

            

            if (device) {

                // C·∫≠p nh·∫≠t giao di·ªán

                updateBMSInterface(device);

                

                // Hi·ªÉn th·ªã BMS interface

                document.getElementById('welcome-screen').style.display = 'none';

                document.getElementById('bms-interface').classList.add('active');

                

                // C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã

                updateDeviceList();

                

                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ

                document.getElementById('selected-device-title').textContent = `ESP32 BMS ${deviceId}`;

                document.getElementById('selected-device-subtitle').textContent = 

                    `IP: ${device.info.local_ip || '--'} | WiFi: ${device.info.wifi_ssid || '--'}`;

                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t x√≥a
                updateRemoveButtonState();
            }

        }



        // C·∫≠p nh·∫≠t giao di·ªán BMS

        function updateBMSInterface(device) {

            const d = device.data || {};

            // Check emergency state and update buttons accordingly
            const emergencyActive = d.emergency_active === true;
            setEmergencyButtons(emergencyActive);

            

            // Th√¥ng tin ch√≠nh (v, i, soc, p)

            document.getElementById('battery-voltage').textContent = (d.v ?? '--') === '--' ? '--' : (+d.v).toFixed(2);

            document.getElementById('current').textContent        = (d.i ?? '--') === '--' ? '--' : (+d.i).toFixed(2);

            document.getElementById('soc').textContent            = d.soc ?? '--';

            document.getElementById('power').textContent          = (d.p ?? '--') === '--' ? '--' : (+d.p).toFixed(2);

            

            // Nhi·ªát ƒë·ªô (t1, t2, temp_mos)

            document.getElementById('temp1').textContent    = (d.t1 ?? '--') === '--' ? '--' : (+d.t1).toFixed(1);

            document.getElementById('temp2').textContent    = (d.t2 ?? '--') === '--' ? '--' : (+d.t2).toFixed(1);

            document.getElementById('temp-mos').textContent = (d.temp_mos ?? '--') === '--' ? '--' : (+d.temp_mos).toFixed(1);

            

            // ƒêi·ªán √°p cell (min_v, max_v, avg_v, delta t·ª± t√≠nh)

            const minV = d.min_v, maxV = d.max_v, avgV = d.avg_v;

            const deltaV = (typeof minV === 'number' && typeof maxV === 'number') ? (maxV - minV) : undefined;

            document.getElementById('min-voltage').textContent   = (typeof minV === 'number') ? minV.toFixed(3) : '--';

            document.getElementById('max-voltage').textContent   = (typeof maxV === 'number') ? maxV.toFixed(3) : '--';

            document.getElementById('avg-voltage').textContent   = (typeof avgV === 'number') ? avgV.toFixed(3) : '--';

            document.getElementById('delta-voltage').textContent = (typeof deltaV === 'number') ? deltaV.toFixed(3) : '--';

            

            // L∆∞·ªõi cell: cv l√† mV ‚Üí ƒë·ªïi sang V; fallback sang cell_voltages (V)

            const cellVoltages = Array.isArray(d.cv) ? d.cv.map(mv => mv / 1000) : (d.cell_voltages || []);

            updateCellGrid(cellVoltages, 'cell-grid', 'voltage');

            

            // L∆∞·ªõi ƒëi·ªán tr·ªü (ƒë·ªçc cr n·∫øu c√≥; fallback cell_resistances)

            const cellRes = Array.isArray(d.cr) ? d.cr : (d.cell_resistances || []);

            updateCellGrid(cellRes, 'resistance-grid', 'resistance');



            // T·ªïng h·ª£p ƒëi·ªán tr·ªü: ∆∞u ti√™n min_r/max_r/avg_r/delta_r; n·∫øu thi·∫øu th√¨ t√≠nh t·ª´ m·∫£ng

            const minR   = (typeof d.min_r === 'number')   ? d.min_r   : (cellRes.length ? Math.min(...cellRes) : undefined);

            const maxR   = (typeof d.max_r === 'number')   ? d.max_r   : (cellRes.length ? Math.max(...cellRes) : undefined);

            const avgR   = (typeof d.avg_r === 'number')   ? d.avg_r   : (cellRes.length ? (cellRes.reduce((a,b)=>a+b,0)/cellRes.length) : undefined);

            const deltaR = (typeof d.delta_r === 'number') ? d.delta_r : ((minR!=null && maxR!=null) ? (maxR - minR) : undefined);



            document.getElementById('min-resistance').textContent   = (minR!=null)   ? minR.toFixed(3)   : '--';

            document.getElementById('max-resistance').textContent   = (maxR!=null)   ? maxR.toFixed(3)   : '--';

            document.getElementById('avg-resistance').textContent   = (avgR!=null)   ? avgR.toFixed(3)   : '--';

            document.getElementById('delta-resistance').textContent = (deltaR!=null) ? deltaR.toFixed(3) : '--';

            // Dung l∆∞·ª£ng pin
            document.getElementById('current-capacity').textContent = (d.cap_cur ?? '--') === '--' ? '--' : (+d.cap_cur).toFixed(2);
            document.getElementById('total-capacity').textContent = (d.cap_tot ?? '--') === '--' ? '--' : (+d.cap_tot).toFixed(2);
            document.getElementById('charge-cycles').textContent = d.cycles ?? '--';

        }



        // C·∫≠p nh·∫≠t cell grid

        function updateCellGrid(cellData, gridId, type) {

            const grid = document.getElementById(gridId);

            if (!cellData || cellData.length === 0) {

                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';

                return;

            }

            

            grid.innerHTML = '';

            

            cellData.forEach((value, index) => {

                const cell = document.createElement('div');

                cell.className = 'cell';

                

                let cssClass = '';

                if (type === 'voltage') {

                    if (value > 3.65) cssClass = 'voltage-high';

                    else if (value < 3.0) cssClass = 'voltage-low';

                    else cssClass = 'voltage-normal';

                } else if (type === 'resistance') {

                    if (value > 2.0) cssClass = 'resistance-high';

                    else if (value < 0.5) cssClass = 'resistance-low';

                    else cssClass = 'resistance-normal';

                }

                

                cell.className = `cell ${cssClass}`;

                cell.innerHTML = `

                    <div class="cell-number">Cell ${index + 1}</div>

                    <div class="cell-value">${value.toFixed(3)}</div>

                `;

                

                grid.appendChild(cell);

            });

        }



        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi (removed - no longer needed)

        function updateConnectionStatus(status, text) {

            // Function kept for compatibility but no longer updates UI

        }



        // Hi·ªÉn th·ªã th√¥ng b√°o

        function showAlert(message, type = 'info') {

            const alertsContainer = document.getElementById('alerts');

            const alert = document.createElement('div');

            alert.className = `alert ${type}`;

            alert.textContent = message;

            

            alertsContainer.appendChild(alert);

            

            setTimeout(() => {

                alert.remove();

            }, 1000);

        }



        // ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã

        // UI: toggle buttons based on emergency state
        function setEmergencyButtons(active){
            const be = document.getElementById('btn-emergency');
            const br = document.getElementById('btn-recover');
            if (!be || !br) return;
            if (active){ be.style.display='none'; br.style.display=''; }
            else { be.style.display=''; br.style.display='none'; }
        }

        // Open/close modals
        function openEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='flex'; } }
        function closeEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='none'; } }
        function openRecoverConfirm(){
            preloadRecoverToggles();
            const m=document.getElementById('modal-recover'); if(m){ m.style.display='flex'; }
        }
        function closeRecoverConfirm(){ const m=document.getElementById('modal-recover'); if(m){ m.style.display='none'; } }

        // Confirm emergency: call backend, then swap button
        async function confirmEmergency(){
            if (!selectedDeviceId) { showAlert('Vui l√≤ng ch·ªçn thi·∫øt b·ªã tr∆∞·ªõc', 'error'); return; }
            try{
                // Send emergency stop command via MQTT
                publishCommand(selectedDeviceId, 'emergency_stop');
                setEmergencyButtons(true);
                closeEmergencyConfirm();
                showAlert(`ƒê√£ k√≠ch ho·∫°t d·ª´ng kh·∫©n c·∫•p thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }catch(e){ showAlert('L·ªói khi d·ª´ng kh·∫©n c·∫•p', 'error'); }
        }

        // Preload recover modal with snapshot (simulate previous state)
        async function preloadRecoverToggles(){
            try{
                // For dashboard, we'll use default values since we don't have direct access to device state
                const setc=(id,v)=>{ const el=document.getElementById(id); if(el) el.checked=!!v; };
                setc('rcv-charge', true);      // Default: enable charge
                setc('rcv-discharge', true);   // Default: enable discharge  
                setc('rcv-balancer', true);    // Default: enable balancer
                setc('rcv-heating', false);    // Default: disable heating
            }catch(e){ /* ignore */ }
        }

        // Confirm recover: apply selected toggles
        async function confirmRecover(){
            if (!selectedDeviceId) { showAlert('Vui l√≤ng ch·ªçn thi·∫øt b·ªã tr∆∞·ªõc', 'error'); return; }
            const payload = {
                charge_mosfet_on: document.getElementById('rcv-charge').checked,
                discharge_mosfet_on: document.getElementById('rcv-discharge').checked,
                balancer_on: document.getElementById('rcv-balancer').checked,
                heating_on: document.getElementById('rcv-heating').checked
            };
            try{
                // Send recovery command via MQTT
                publishSettingsCommand(selectedDeviceId, payload);
                setEmergencyButtons(false);
                closeRecoverConfirm();
                showAlert(`ƒê√£ kh√¥i ph·ª•c BMS thi·∫øt b·ªã ${selectedDeviceId} theo l·ª±a ch·ªçn`, 'success');
            }catch(e){ showAlert('L·ªói khi kh√¥i ph·ª•c BMS', 'error'); }
        }



        function restartDevice() {

            if (selectedDeviceId && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${selectedDeviceId}?`)) {

                publishCommand(selectedDeviceId, 'restart');

                showAlert(`ƒê√£ g·ª≠i l·ªánh kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${selectedDeviceId}`, 'success');

            }

        }

        function powerCycleDevice() {
            if (selectedDeviceId && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën power cycle thi·∫øt b·ªã ${selectedDeviceId}?\n\nThi·∫øt b·ªã s·∫Ω t·∫°m ng·∫Øt ngu·ªìn 5 gi√¢y r·ªìi b·∫≠t l·∫°i.`)) {
                publishCommand(selectedDeviceId, 'power_cycle');
                showAlert(`ƒê√£ g·ª≠i l·ªánh power cycle thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }






        // G·ª≠i l·ªánh qua MQTT

        function publishCommand(deviceId, command) {

            if (mqttClient && mqttClient.connected) {

                const topic = `bms/${deviceId}/control`;

                mqttClient.publish(topic, command);

                console.log(`ƒê√£ g·ª≠i l·ªánh ${command} t·ªõi ${topic}`);

            } else {

                showAlert('Kh√¥ng th·ªÉ g·ª≠i l·ªánh - MQTT ch∆∞a k·∫øt n·ªëi', 'error');

            }

        }



        // Kh·ªüi t·∫°o dashboard

        function initDashboard() {

            console.log('Kh·ªüi t·∫°o BMS Central Dashboard...');

            connectMQTT();

            
            // Kh·ªüi t·∫°o tr·∫°ng th√°i n√∫t x√≥a
            updateRemoveButtonState();
            

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã m·ªói 30 gi√¢y

            setInterval(() => {

                const now = Date.now();

                devices.forEach((device, deviceId) => {

                    if (now - device.lastSeen > 60000) { // 1 ph√∫t

                        device.status = 'offline';

                        updateDeviceList();

                        

                        // N·∫øu ƒëang ch·ªçn thi·∫øt b·ªã offline, quay v·ªÅ welcome screen

                        if (selectedDeviceId === deviceId) {

                            selectedDeviceId = null;

                            document.getElementById('welcome-screen').style.display = 'block';

                            document.getElementById('bms-interface').classList.remove('active');

                        }

                    }

                });

                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t x√≥a
                updateRemoveButtonState();
            }, 1000);

        }


        // Scan c√°c thi·∫øt b·ªã ƒëang ho·∫°t ƒë·ªông
        function scanActiveDevices() {
            console.log('ƒêang scan c√°c thi·∫øt b·ªã ƒëang ho·∫°t ƒë·ªông...');
            
            // G·ª≠i l·ªánh scan t·ªõi ESP32
            if (mqttClient && mqttClient.connected) {
                const topic = `bms/esp32_001/cmd/action`;
                mqttClient.publish(topic, 'get_status', { qos: 1 });
                console.log('ƒê√£ g·ª≠i l·ªánh scan t·ªõi ESP32');
                
                showAlert('ƒê√£ g·ª≠i l·ªánh scan t·ªõi ESP32', 'success');
            } else {
                showAlert('MQTT ch∆∞a k·∫øt n·ªëi, kh√¥ng th·ªÉ scan thi·∫øt b·ªã', 'error');
            }
        }

        // X√≥a thi·∫øt b·ªã ƒë∆∞·ª£c ch·ªçn
        function removeSelectedDevice() {
            if (!selectedDeviceId) {
                showAlert('Ch∆∞a ch·ªçn thi·∫øt b·ªã ƒë·ªÉ x√≥a', 'error');
                return;
            }

            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thi·∫øt b·ªã ${selectedDeviceId} kh·ªèi danh s√°ch?`)) {
                // X√≥a thi·∫øt b·ªã kh·ªèi danh s√°ch
                devices.delete(selectedDeviceId);
                
                // N·∫øu ƒëang ch·ªçn thi·∫øt b·ªã b·ªã x√≥a, quay v·ªÅ welcome screen
                if (selectedDeviceId === selectedDeviceId) {
                    selectedDeviceId = null;
                    document.getElementById('welcome-screen').style.display = 'block';
                    document.getElementById('bms-interface').classList.remove('active');
                }
                
                // C·∫≠p nh·∫≠t giao di·ªán
                updateDeviceList();
                updateRemoveButtonState();
                
                showAlert(`ƒê√£ x√≥a thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t x√≥a thi·∫øt b·ªã
        function updateRemoveButtonState() {
            const removeBtn = document.getElementById('remove-device-btn');
            if (removeBtn) {
                removeBtn.disabled = !selectedDeviceId;
            }
        }



        // Kh·ªüi t·∫°o khi trang load xong

        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>

</body>

</html>