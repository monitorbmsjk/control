<!DOCTYPE html>

<html lang="vi">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BMS Central Dashboard - Admin</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: #f5f5f5;

            min-height: 100vh;

        }



        .dashboard-container {

            display: flex;

            min-height: 100vh;

        }



        /* Sidebar */

        .sidebar {

            width: 300px;

            background: #2c3e50;

            color: white;

            overflow-y: auto;

            box-shadow: 2px 0 10px rgba(0,0,0,0.1);

        }



        .sidebar-header {

            padding: 20px;

            background: #34495e;

            border-bottom: 1px solid #465c71;

        }



        .sidebar-header h2 {

            color: white;

            font-size: 1.3em;

            margin-bottom: 5px;

        }



        .sidebar-header p {

            color: #bdc3c7;

            font-size: 0.9em;

        }



        .device-list {

            padding: 10px;

        }



        .device-item {

            padding: 15px;

            margin: 5px 0;

            background: #34495e;

            border-radius: 8px;

            cursor: pointer;

            transition: all 0.3s;

            border-left: 4px solid transparent;

        }



        .device-item:hover {

            background: #3498db;

            transform: translateX(5px);

        }



        .device-item.active {

            background: #3498db;

            border-left-color: #e74c3c;

        }



        .device-item-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 8px;

        }



        .device-name {

            font-weight: bold;

            font-size: 1.1em;

        }



        .device-status {

            padding: 4px 8px;

            border-radius: 12px;

            font-size: 0.8em;

            font-weight: bold;

        }



        .status-online {

            background: #27ae60;

            color: white;

        }



        .status-offline {

            background: #e74c3c;

            color: white;

        }



        .device-info-small {

            font-size: 0.9em;

            color: #bdc3c7;

        }



        /* Main Content */

        .main-content {

            flex: 1;

            background: white;

            overflow-y: auto;

        }



        .main-header {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            padding: 30px;

            text-align: center;

        }



        .main-header h1 {

            font-size: 2.5em;

            margin-bottom: 10px;

        }



        .main-header p {

            font-size: 1.1em;

            opacity: 0.9;

        }



        .connection-status {

            background: white;

            border-radius: 15px;

            padding: 25px;

            margin: 20px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

            text-align: center;

        }



        .status-indicator {

            display: inline-block;

            width: 20px;

            height: 20px;

            border-radius: 50%;

            margin-right: 10px;

        }



        .status-connected {

            background: #28a745;

        }



        .status-disconnected {

            background: #dc3545;

        }



        .status-connecting {

            background: #ffc107;

            animation: pulse 1s infinite;

        }



        @keyframes pulse {

            0% { opacity: 1; }

            50% { opacity: 0.5; }

            100% { opacity: 1; }

        }



        /* BMS Interface (similar to index.html) */

        .bms-interface {

            padding: 20px;

            display: none;

        }



        .bms-interface.active {

            display: block;

        }



        .grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));

            gap: 20px;

            margin-bottom: 20px;

        }



        .card {

            background: white;

            border-radius: 15px;

            padding: 25px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

        }



        .card h3 {

            color: #333;

            margin-bottom: 20px;

            font-size: 1.3em;

            border-bottom: 2px solid #f0f0f0;

            padding-bottom: 10px;

        }



        .value {

            font-size: 2.5em;

            font-weight: bold;

            color: #3498db;

            text-align: center;

            margin-bottom: 10px;

        }



        .unit {

            text-align: center;

            color: #666;

            font-size: 1.1em;

        }



        .cell-grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));

            gap: 10px;

            margin-top: 15px;

        }



        .cell {

            background: #f8f9fa;

            border: 2px solid #e9ecef;

            border-radius: 8px;

            padding: 15px 10px;

            text-align: center;

            font-weight: bold;

            transition: all 0.3s;

        }



        .cell:hover {

            transform: scale(1.05);

            box-shadow: 0 5px 15px rgba(0,0,0,0.2);

        }



        .cell-number {

            font-size: 0.9em;

            color: #666;

            margin-bottom: 5px;

        }



        .cell-value {

            font-size: 1.1em;

            color: #333;

        }



        .voltage-high {

            background: #d4edda;

            border-color: #28a745;

            color: #155724;

        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #888;
            transition: .2s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(24px); }



        .voltage-low {

            background: #f8d7da;

            border-color: #dc3545;

            color: #721c24;

        }



        .voltage-normal {

            background: #d1ecf1;

            border-color: #17a2b8;

            color: #0c5460;

        }



        .resistance-high {

            background: #fff3cd;

            border-color: #ffc107;

            color: #856404;

        }



        .resistance-low {

            background: #d1ecf1;

            border-color: #17a2b8;

            color: #0c5460;

        }



        .resistance-normal {

            background: #d4edda;

            border-color: #28a745;

            color: #155724;

        }



        /* Control Buttons */

        .control-section {

            background: white;

            border-radius: 15px;

            padding: 25px;

            margin: 20px;

            box-shadow: 0 5px 15px rgba(0,0,0,0.1);

        }



        .control-section h2 {

            color: #333;

            margin-bottom: 20px;

            display: flex;

            align-items: center;

            gap: 10px;

        }



        .control-buttons {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 15px;

        }



        .btn {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            border: none;

            padding: 15px 25px;

            border-radius: 8px;

            font-size: 16px;

            cursor: pointer;

            transition: transform 0.2s;

        }



        .btn:hover {

            transform: translateY(-2px);

        }



        .btn-danger {

            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);

        }



        .btn-warning {

            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);

        }



        .btn-success {

            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);

        }



        /* Alerts */

        .alert {

            background: #f8d7da;

            color: #721c24;

            padding: 15px;

            border-radius: 8px;

            margin: 20px;

            border: 1px solid #f5c6cb;

        }



        .success {

            background: #d4edda;

            color: #155724;

            padding: 15px;

            border-radius: 8px;

            margin: 20px;

            border: 1px solid #c3e6cb;

        }



        /* Welcome Screen */

        .welcome-screen {

            text-align: center;

            padding: 100px 20px;

            color: #666;

        }



        .welcome-screen h2 {

            font-size: 2.5em;

            margin-bottom: 20px;

            color: #333;

        }



        .welcome-screen p {

            font-size: 1.2em;

            margin-bottom: 30px;

        }



        .welcome-icon {

            font-size: 5em;

            margin-bottom: 30px;

            opacity: 0.3;

        }



        /* Responsive */

        @media (max-width: 768px) {

            .dashboard-container {

                flex-direction: column;

            }

            

            .sidebar {

                width: 100%;

                height: auto;

            }

            

            .grid {

                grid-template-columns: 1fr;

            }

        }

        /* Tabs */

        .nav-tabs { display:flex; gap:10px; margin: 0 20px 10px; }

        .tab-btn { padding:10px 16px; border:none; border-radius:20px; cursor:pointer; background:#eef1f7; color:#333; font-weight:600; }

        .tab-btn.active { background:#667eea; color:#fff; }

        .tab-content { display:none; }

        .tab-content.active { display:block; }


        /* Settings Tab Styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #fff;
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="number"]:hover {
            border-color: #bbb;
        }

        .input-with-button {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button button {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
            min-width: 60px;
        }

        .input-with-button button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Switch Toggle Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Switch Container */
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .switch-container label {
            margin: 0;
            font-weight: 500;
            color: #333;
        }

        /* Settings Section Headers */
        .settings-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-section-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        /* Device Management Buttons */
        .device-management-buttons {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .device-management-buttons .btn {
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .device-management-buttons .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .device-management-buttons .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .device-management-buttons .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .device-management-buttons .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .device-management-buttons .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>

</head>

<body>

    <div class="dashboard-container">

        <!-- Sidebar -->

        <div class="sidebar">

            <div class="sidebar-header">

                <h2>🔧 BMS Dashboard</h2>

                <p>Quản lý ESP32 BMS</p>

                <div class="device-management-buttons">
                    <button class="btn btn-primary" onclick="scanActiveDevices()">
                        🔍 Scan thiết bị
                    </button>
                    <button class="btn btn-danger" onclick="removeSelectedDevice()" id="remove-device-btn" disabled>
                        🗑️ Xóa thiết bị
                    </button>
                </div>
            </div>

            

            <div class="device-list" id="device-list">

                <!-- Devices will be populated here -->

            </div>

        </div>



        <!-- Main Content -->

        <div class="main-content">

            <div class="nav-tabs">

                <button class="tab-btn active" onclick="showTab('monitor')">Thông số pin</button>

                <button class="tab-btn" onclick="showTab('settings')">Cài đặt</button>

            </div>

            <div id="monitor-tab" class="tab-content active">




            <div id="alerts"></div>



            <!-- Welcome Screen -->

            <div class="welcome-screen" id="welcome-screen">

                <div class="welcome-icon">🔋</div>

                <h2>Chào mừng đến với BMS Dashboard</h2>

                <p>Chọn một ESP32 từ danh sách bên trái để bắt đầu giám sát</p>

            </div>



            <!-- BMS Interface -->

            <div class="bms-interface" id="bms-interface">

                <!-- Main Header -->

                <div class="main-header">

                    <h1 id="selected-device-title">ESP32 BMS Monitor</h1>

                    <p id="selected-device-subtitle">Giám sát thời gian thực</p>

                </div>



                <!-- Main Info Grid -->

                <div class="grid">

                    <div class="card">

                        <h3>🔋 Thông tin chính</h3>

                        <div class="value" id="battery-voltage">--</div>

                        <div class="unit">Điện áp (V)</div>

                    </div>

                    

                    <div class="card">

                        <h3>⚡ Dòng điện</h3>

                        <div class="value" id="current">--</div>

                        <div class="unit">Dòng điện (A)</div>

                    </div>

                    

                    <div class="card">

                        <h3>📊 Mức sạc</h3>

                        <div class="value" id="soc">--</div>

                        <div class="unit">SOC (%)</div>

                    </div>

                    

                    <div class="card">

                        <h3>💪 Công suất</h3>

                        <div class="value" id="power">--</div>

                        <div class="unit">Công suất (W)</div>

                    </div>

                </div>



                <!-- Temperature Grid -->

                <div class="grid">

                    <div class="card">

                        <h3>🌡️ Nhiệt độ</h3>

                        <div class="value" id="temp1">--</div>

                        <div class="unit">Nhiệt độ 1 (°C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>🌡️ Nhiệt độ 2</h3>

                        <div class="value" id="temp2">--</div>

                        <div class="unit">Nhiệt độ 2 (°C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>🔥 Nhiệt độ MOS</h3>

                        <div class="value" id="temp-mos">--</div>

                        <div class="unit">Nhiệt độ MOS (°C)</div>

                    </div>

                    

                    <div class="card">

                        <h3>📈 Dung lượng</h3>

                        <div class="value" id="current-capacity">--</div>

                        <div class="unit">Dung lượng hiện tại (Ah)</div>

                        <div class="value" id="total-capacity">--</div>

                        <div class="unit">Dung lượng tối đa (Ah)</div>

                        <div class="value" id="charge-cycles">--</div>

                        <div class="unit">Chu kỳ sạc</div>

                    </div>

                </div>



                <!-- Cell Information -->

                <div class="grid">

                    <div class="card">

                        <h3>🔋 Thông tin Cell</h3>

                        <div class="value" id="min-voltage">--</div>

                        <div class="unit">Điện áp thấp nhất (V)</div>

                        <div class="value" id="max-voltage">--</div>

                        <div class="unit">Điện áp cao nhất (V)</div>

                        <div class="value" id="avg-voltage">--</div>

                        <div class="unit">Điện áp trung bình (V)</div>

                        <div class="value" id="delta-voltage">--</div>

                        <div class="unit">Chênh lệch điện áp (V)</div>

                    </div>

                    

                    <div class="card">

                        <h3>⚡ Điện trở Cell</h3>

                        <div class="value" id="min-resistance">--</div>

                        <div class="unit">Điện trở thấp nhất (mΩ)</div>

                        <div class="value" id="max-resistance">--</div>

                        <div class="unit">Điện trở cao nhất (mΩ)</div>

                        <div class="value" id="avg-resistance">--</div>

                        <div class="unit">Điện trở trung bình (mΩ)</div>

                        <div class="value" id="delta-resistance">--</div>

                        <div class="unit">Chênh lệch điện trở (mΩ)</div>

                    </div>

                </div>



                <!-- Cell Voltage Grid -->

                <div class="card">

                    <h3>🔋 Điện áp Cell</h3>

                    <div class="cell-grid" id="cell-grid">

                        <!-- Cell voltages will be populated here -->

                    </div>

                </div>



                <!-- Cell Resistance Grid -->

                <div class="card">

                    <h3>⚡ Điện trở Cell</h3>

                    <div class="cell-grid" id="resistance-grid">

                        <!-- Cell resistances will be populated here -->

                    </div>

                </div>



                <!-- Control Section -->

                <div class="control-section">

                    <h2>🛡️ Quản lý BMS</h2>

                    <div class="control-buttons">

                        <button id="btn-emergency" class="btn btn-danger" onclick="openEmergencyConfirm()">🛑 Dừng khẩn cấp</button>

                        <button id="btn-recover" class="btn btn-primary" style="display:none;" onclick="openRecoverConfirm()">🔄 Khởi động lại BMS</button>

                        <button class="btn btn-warning" onclick="enterSetupFromDashboard()">Chế độ thiết lập </button>

                        <button class="btn btn-info" onclick="powerCycleDevice()">⚡ Khởi động lại nguồn (5s)</button>
                        <button class="btn btn-success" onclick="disconnectSelectedDevice()">🔌 Ngắt kết nối</button>

                    </div>

                </div>

                <!-- Emergency confirm modal -->
                <div id="modal-emergency" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:12px; padding:20px; max-width:420px; width:92%;">
                        <h3 style="margin-bottom:10px;">Xác nhận dừng khẩn cấp</h3>
                        <p style="color:#555;">Hệ thống sẽ tắt sạc, xả, cân bằng, sưởi và bật chế độ khẩn cấp để đảm bảo an toàn.</p>
                        <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                            <button class="btn btn-secondary" onclick="closeEmergencyConfirm()">Hủy</button>
                            <button class="btn btn-danger" onclick="confirmEmergency()">Xác nhận</button>
                        </div>
                    </div>
                </div>

                <!-- Recover confirm modal -->
                <div id="modal-recover" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:12px; padding:20px; max-width:520px; width:92%;">
                        <h3 style="margin-bottom:10px;">Khởi động lại BMS</h3>
                        <p style="color:#555;">Chọn trạng thái cần phục hồi. Mặc định khôi phục theo trước khi dừng khẩn cấp.</p>
                        <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <label>Charge MOSFET
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-charge" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Discharge MOSFET
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-discharge" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Balancer
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-balancer" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                            <label>Heating
                                <label class="switch" style="margin-left:8px;">
                                    <input id="rcv-heating" type="checkbox"><span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                            <button class="btn btn-secondary" onclick="closeRecoverConfirm()">Hủy</button>
                            <button class="btn btn-primary" onclick="confirmRecover()">Xác nhận</button>
                        </div>
                    </div>
                </div>

            </div>

            </div> <!-- end monitor-tab -->



            <div id="settings-tab" class="tab-content">

                <div id="settings-empty" style="text-align:center; padding:60px 20px; color:#666; display: none;">
                    <div style="font-size:48px; opacity:0.25;">🛠️</div>
                    <h2 style="margin-top:10px; color:#333;">Chưa chọn thiết bị</h2>
                    <p>Chọn một thiết bị từ danh sách bên trái .</p>
                </div>

                <div id="settings-content" class="grid">

                    <div class="card">

                        <div class="settings-section-header">
                        <h3>⚡ Điện áp</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ngưỡng cao áp cell (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-overvoltage" step="0.001" placeholder="3.65">
                                    <button onclick="saveSingleSetting('cell_overvoltage','cell-overvoltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Khôi phục cao áp (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-overvoltage-recovery" step="0.001" placeholder="3.40">
                                    <button onclick="saveSingleSetting('cell_overvoltage_recovery','cell-overvoltage-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ngưỡng thấp áp cell (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-undervoltage" step="0.001" placeholder="3.00">
                                    <button onclick="saveSingleSetting('cell_undervoltage','cell-undervoltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Khôi phục thấp áp (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-undervoltage-recovery" step="0.001" placeholder="3.20">
                                    <button onclick="saveSingleSetting('cell_undervoltage_recovery','cell-undervoltage-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ngưỡng cân bằng (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="balance-trigger-voltage" step="0.001" placeholder="0.10">
                                    <button onclick="saveSingleSetting('balance_trigger_voltage','balance-trigger-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp bắt đầu cân bằng (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="balance-start-voltage" step="0.001" placeholder="4.10">
                                    <button onclick="saveSingleSetting('balance_start_voltage','balance-start-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp khi pin 100% (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-soc100-voltage" step="0.001" placeholder="3.65">
                                    <button onclick="saveSingleSetting('cell_soc100_voltage','cell-soc100-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp khi pin 0% (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-soc0-voltage" step="0.001" placeholder="3.00">
                                    <button onclick="saveSingleSetting('cell_soc0_voltage','cell-soc0-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp yêu cầu sạc (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-request-charge-voltage" step="0.001" placeholder="3.455">
                                    <button onclick="saveSingleSetting('cell_request_charge_voltage','cell-request-charge-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp duy trì (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-request-float-voltage" step="0.001" placeholder="3.401">
                                    <button onclick="saveSingleSetting('cell_request_float_voltage','cell-request-float-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp ngủ thông minh (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="smart-sleep-voltage" step="0.001" placeholder="0.003">
                                    <button onclick="saveSingleSetting('smart_sleep_voltage','smart-sleep-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Điện áp tắt nguồn (V)</label>
                                <div class="input-with-button">
                                    <input type="number" id="power-off-voltage" step="0.001" placeholder="3.40">
                                    <button onclick="saveSingleSetting('power_off_voltage','power-off-voltage')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Số lượng cell</label>
                                <div class="input-with-button">
                                    <input type="number" id="cell-count" step="1" min="2" max="32" placeholder="16">
                                    <button onclick="saveSingleSetting('cell_count','cell-count')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Tổng dung lượng (Ah)</label>
                                <div class="input-with-button">
                                    <input type="number" id="capacity" step="0.1" placeholder="280.0">
                                    <button onclick="saveSingleSetting('capacity','capacity')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>⚡ Dòng điện</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dòng cân bằng tối đa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="max-balance-current" step="0.1" placeholder="0.3">
                                    <button onclick="saveSingleSetting('max_balance_current','max-balance-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Dòng sạc tối đa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-current" step="0.1" placeholder="50.0">
                                    <button onclick="saveSingleSetting('charge_current','charge-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Dòng xả tối đa (A)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-current" step="0.1" placeholder="50.0">
                                    <button onclick="saveSingleSetting('discharge_current','discharge-current')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hiệu chuẩn dòng điện</label>
                                <div class="input-with-button">
                                    <input type="number" id="current-calibration" step="0.001" placeholder="2.0">
                                    <button onclick="saveSingleSetting('current_calibration','current-calibration')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>⏱️ Thời gian & Độ trễ</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Độ trễ quá dòng sạc (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-ocp-delay-s" step="1" placeholder="40">
                                    <button onclick="saveSingleSetting('charge_ocp_delay_s','charge-ocp-delay-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian khôi phục quá dòng sạc (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-ocpr-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('charge_ocpr_time_s','charge-ocpr-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Độ trễ quá dòng xả (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-ocp-delay-s" step="1" placeholder="300">
                                    <button onclick="saveSingleSetting('discharge_ocp_delay_s','discharge-ocp-delay-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian khôi phục quá dòng xả (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-ocpr-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('discharge_ocpr_time_s','discharge-ocpr-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Độ trễ ngắn mạch (μs)</label>
                                <div class="input-with-button">
                                    <input type="number" id="scp-delay-us" step="1" placeholder="2000">
                                    <button onclick="saveSingleSetting('scp_delay_us','scp-delay-us')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian khôi phục ngắn mạch (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="scp-recovery-time-s" step="1" placeholder="70">
                                    <button onclick="saveSingleSetting('scp_recovery_time_s','scp-recovery-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian yêu cầu sạc (h)</label>
                                <div class="input-with-button">
                                    <input type="number" id="request-charge-voltage-time-h" step="0.1" placeholder="2.0">
                                    <button onclick="saveSingleSetting('request_charge_voltage_time_h','request-charge-voltage-time-h')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian điện áp duy trì (h)</label>
                                <div class="input-with-button">
                                    <input type="number" id="request-float-voltage-time-h" step="0.1" placeholder="9.0">
                                    <button onclick="saveSingleSetting('request_float_voltage_time_h','request-float-voltage-time-h')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Thời gian precharge xả (s)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-precharge-time-s" step="1" placeholder="0">
                                    <button onclick="saveSingleSetting('discharge_precharge_time_s','discharge-precharge-time-s')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hiệu chuẩn điện áp</label>
                                <div class="input-with-button">
                                    <input type="number" id="voltage-calibration" step="0.01" placeholder="15.00">
                                    <button onclick="saveSingleSetting('voltage_calibration','voltage-calibration')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>🌡️ Nhiệt độ</h3>

                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nhiệt độ quá cao sạc (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-overtemp" step="0.1" placeholder="66.0">
                                    <button onclick="saveSingleSetting('charge_overtemp','charge-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ khôi phục sạc (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-overtemp-recovery" step="0.1" placeholder="61.0">
                                    <button onclick="saveSingleSetting('charge_overtemp_recovery','charge-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ quá cao xả (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-overtemp" step="0.1" placeholder="77.0">
                                    <button onclick="saveSingleSetting('discharge_overtemp','discharge-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ khôi phục xả (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="discharge-overtemp-recovery" step="0.1" placeholder="65.0">
                                    <button onclick="saveSingleSetting('discharge_overtemp_recovery','discharge-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ quá thấp sạc (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-undertemp" step="0.1" placeholder="-22.0">
                                    <button onclick="saveSingleSetting('charge_undertemp','charge-undertemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ khôi phục sạc (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="charge-undertemp-recovery" step="0.1" placeholder="-9.0">
                                    <button onclick="saveSingleSetting('charge_undertemp_recovery','charge-undertemp-recovery')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ quá cao MOSFET (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="mos-overtemp" step="0.1" placeholder="99.0">
                                    <button onclick="saveSingleSetting('mos_overtemp','mos-overtemp')">OK</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nhiệt độ khôi phục MOSFET (°C)</label>
                                <div class="input-with-button">
                                    <input type="number" id="mos-overtemp-recovery" step="0.1" placeholder="78.0">
                                    <button onclick="saveSingleSetting('mos_overtemp_recovery','mos-overtemp-recovery')">OK</button>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="card">

                        <div class="settings-section-header">
                        <h3>🎚️ Công tắc điều khiển</h3>

                        </div>

                        <div class="form-row">
                            <div class="switch-container">
                                <label>MOSFET sạc</label>
                                <label class="switch">
                                    <input type="checkbox" id="charge-mosfet-on" onchange="saveSwitch('charge_mosfet_on','charge-mosfet-on')">
                                    <span class="slider"></span>
                                </label>
                    </div>

                            <div class="switch-container">
                                <label>MOSFET xả</label>
                                <label class="switch">
                                    <input type="checkbox" id="discharge-mosfet-on" onchange="saveSwitch('discharge_mosfet_on','discharge-mosfet-on')">
                                    <span class="slider"></span>
                                </label>
                </div>

                            <div class="switch-container">
                                <label>Bộ cân bằng</label>
                                <label class="switch">
                                    <input type="checkbox" id="balancer-on" onchange="saveSwitch('balancer_on','balancer-on')">
                                    <span class="slider"></span>
                                </label>
            </div>

                            <div class="switch-container">
                                <label>Sưởi ấm</label>
                                <label class="switch">
                                    <input type="checkbox" id="heating-on" onchange="saveSwitch('heating_on','heating-on')">
                                    <span class="slider"></span>
                                </label>
                        </div>

                            <div class="switch-container">
                                <label>Tắt cảm biến nhiệt</label>
                                <label class="switch">
                                    <input type="checkbox" id="disable-temperature-sensors" onchange="saveSwitch('disable_temperature_sensors','disable-temperature-sensors')">
                                    <span class="slider"></span>
                                </label>
                    </div>

                            <div class="switch-container">
                                <label>Màn hình luôn sáng</label>
                                <label class="switch">
                                    <input type="checkbox" id="display-always-on" onchange="saveSwitch('display_always_on','display-always-on')">
                                    <span class="slider"></span>
                                </label>
                </div>

                            <div class="switch-container">
                                <label>Ngủ thông minh</label>
                                <label class="switch">
                                    <input type="checkbox" id="smart-sleep-on" onchange="saveSwitch('smart_sleep_on','smart-sleep-on')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Tắt module PCL</label>
                                <label class="switch">
                                    <input type="checkbox" id="disable-pcl-module" onchange="saveSwitch('disable_pcl_module','disable-pcl-module')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Lưu dữ liệu theo thời gian</label>
                                <label class="switch">
                                    <input type="checkbox" id="timed-stored-data" onchange="saveSwitch('timed_stored_data','timed-stored-data')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Chế độ float sạc</label>
                                <label class="switch">
                                    <input type="checkbox" id="charging-float-mode" onchange="saveSwitch('charging_float_mode','charging-float-mode')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="switch-container">
                                <label>Chế độ khẩn cấp</label>
                                <label class="switch">
                                    <input type="checkbox" id="emergency-mode" onchange="saveSwitch('emergency_mode','emergency-mode')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </div>



    <script>
        // Remove emoji/icons from all texts to keep a clean UI
        document.addEventListener('DOMContentLoaded', () => {
            const strip = s => s.replace(/[\u2190-\u21FF\u2300-\u23FF\u2600-\u27BF\u1F000-\u1FAFF]/g, '').replace(/\s{2,}/g,' ').trim();
            const nodes = document.querySelectorAll('h1,h2,h3,button,.unit,.device-name,.device-info-small,label');
            nodes.forEach(n=>{ if(n && n.textContent){ n.textContent = strip(n.textContent); } });
        });

        // MQTT Configuration

        const mqttConfig = {

            host: 'broker.hivemq.com',

            port: 8884, // WebSocket port

            path: '/mqtt',

            clientId: 'BMS_Dashboard_' + Math.random().toString(16).substr(2, 8)

        };



        let mqttClient = null;

        let devices = new Map(); // Map để lưu trữ thông tin thiết bị

        let selectedDeviceId = null; // ID của thiết bị được chọn

        let reconnectAttempts = 0;

        const maxReconnectAttempts = 5;



        // Monitor/control refresh (UI only; data push qua MQTT)

        let autoRefresh = true;

        let refreshMs = 3000;

        let refreshTimer = null;



        function setRefreshMs(val){

            refreshMs = parseInt(val,10) || 3000;

            const lbl=document.getElementById('refresh-label');

            if(lbl) lbl.textContent = `Đang cập nhật mỗi ${refreshMs} ms`;

            if (autoRefresh){

                if (refreshTimer){ clearInterval(refreshTimer); }

                refreshTimer = setInterval(()=>{/* UI refresh hook if needed */}, refreshMs);

            }

        }



        function toggleAutoRefresh(){

            autoRefresh = !autoRefresh;

            if (autoRefresh){

                if (refreshTimer){ clearInterval(refreshTimer); }

                refreshTimer = setInterval(()=>{/* UI refresh hook if needed */}, refreshMs);

            } else if (refreshTimer){

                clearInterval(refreshTimer); refreshTimer=null;

            }

        }



        function showTab(tab){

            const tabs = document.querySelectorAll('.tab-content');

            tabs.forEach(t=>t.classList.remove('active'));

            const btns = document.querySelectorAll('.tab-btn');

            btns.forEach(b=>b.classList.remove('active'));

            const target = document.getElementById(`${tab}-tab`);

            if(target) target.classList.add('active');

            if(tab==='monitor' && btns[0]) btns[0].classList.add('active');

            if(tab==='settings' && btns[1]) btns[1].classList.add('active');
            // Toggle settings placeholder vs content
            const hasSelection = !!selectedDeviceId;
            const se = document.getElementById('settings-empty');
            const sc = document.getElementById('settings-content');
            if (se && sc){
                if (hasSelection){ se.style.display = 'none'; sc.style.display = ''; }
                else { se.style.display = ''; sc.style.display = 'none'; }
            }

            if(tab==='control' && btns[2]) btns[2].classList.add('active');

        }



        // Kết nối MQTT

        function connectMQTT() {

            try {

                const url = `wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;

                

                mqttClient = mqtt.connect(url, {

                    clientId: mqttConfig.clientId,

                    clean: true,

                    reconnectPeriod: 5000,

                    connectTimeout: 30000

                });



                mqttClient.on('connect', () => {

                    console.log('MQTT kết nối thành công!');

                    // Tránh spam thông báo trên UI khi kết nối lại nhiều lần
                    reconnectAttempts = 0;

                    

                    // Subscribe vào tất cả topics

                    subscribeToTopics();

                });



                mqttClient.on('message', (topic, message) => {

                    handleMQTTMessage(topic, message.toString());

                });



                mqttClient.on('error', (error) => {

                    console.error('MQTT error:', error);

                    showAlert('Lỗi kết nối MQTT: ' + error.message, 'error');

                });



                mqttClient.on('close', () => {

                    console.log('MQTT kết nối đóng');

                    if (reconnectAttempts < maxReconnectAttempts) {

                        reconnectAttempts++;

                        setTimeout(connectMQTT, 5000);

                    }

                });



            } catch (error) {

                console.error('Lỗi kết nối MQTT:', error);

                showAlert('Lỗi kết nối MQTT: ' + error.message, 'error');

            }

        }



        // ===== MQTT command publishers for remote control =====

        function ensureMqttConnected(){

            if (!mqttClient || !mqttClient.connected){

                showAlert('MQTT chưa kết nối', 'error');

                return false;

            }

            if (!selectedDeviceId){

                showAlert('Chưa chọn thiết bị', 'error');

                return false;

            }

            return true;

        }



        // Publish a single setting { key: value } to bms/<id>/cmd/settings

        function saveSingleSetting(settingKey, elementId){

            const el = document.getElementById(elementId);

            if (!el){ showAlert('Không tìm thấy input: '+elementId,'error'); return; }

            const raw = el.value;

            const value = Number(raw);

            if (Number.isNaN(value)) { showAlert('Giá trị không hợp lệ!', 'error'); return; }

            if (!ensureMqttConnected()) return;

            const cmd = {}; cmd[settingKey] = value;

            const topic = `bms/esp32_001/cmd/settings`;
            try{

                mqttClient.publish(topic, JSON.stringify(cmd), { qos: 1 });

                showAlert(`Đã gửi cài đặt ${settingKey}=${value}`,'success');

            }catch(e){ showAlert('Lỗi gửi MQTT','error'); }

        }



        // Publish a switch toggle { key: boolean } to bms/<id>/cmd/switches

        function saveSwitch(switchKey, elementId){

            const el = document.getElementById(elementId);

            if (!el){ showAlert('Không tìm thấy công tắc: '+elementId,'error'); return; }

            const value = !!el.checked;

            if (!ensureMqttConnected()) return;

            const cmd = {}; cmd[switchKey] = value;

            const topic = `bms/esp32_001/cmd/switches`;
            try{

                mqttClient.publish(topic, JSON.stringify(cmd), { qos: 1 });

                showAlert(`Đã gửi công tắc ${switchKey}=${value}`,'success');

            }catch(e){ showAlert('Lỗi gửi MQTT','error'); }

        }



        // Publish simple action string to bms/<id>/cmd/action

        function publishCommand(deviceId, action){

            if (!ensureMqttConnected()) return;

            const topic = `bms/${deviceId}/cmd/action`;

            try{

                mqttClient.publish(topic, action, { qos: 1 });

                showAlert(`Đã gửi lệnh: ${action}`,'success');

            }catch(e){ showAlert('Lỗi gửi MQTT','error'); }

        }

        // Publish settings object to bms/<id>/cmd/settings for recovery
        function publishSettingsCommand(deviceId, settings){
            if (!ensureMqttConnected()) return;
            const topic = `bms/${deviceId}/cmd/settings`;
            try{
                mqttClient.publish(topic, JSON.stringify(settings), { qos: 1 });
                showAlert(`Đã gửi cài đặt khôi phục cho ${deviceId}`,'success');
            }catch(e){ showAlert('Lỗi gửi MQTT settings','error'); }
        }



        // Subscribe vào các topics

        function subscribeToTopics() {

            if (mqttClient && mqttClient.connected) {

                // Subscribe vào tất cả topics BMS

                mqttClient.subscribe('bms/+/data');

                mqttClient.subscribe('bms/+/status');

                mqttClient.subscribe('bms/+/online');

                

                console.log('Đã subscribe vào topics BMS');

            }

        }



        // Xử lý tin nhắn MQTT

        function handleMQTTMessage(topic, message) {

            const topicParts = topic.split('/');

            const deviceId = topicParts[1];

            const messageType = topicParts[2];



            if (!devices.has(deviceId)) {

                devices.set(deviceId, {

                    id: deviceId,

                    status: 'offline',

                    lastSeen: Date.now(),

                    data: {},

                    info: {}

                });

            }



            const device = devices.get(deviceId);

            device.lastSeen = Date.now();



            // online là plain text, không phải JSON

            if (messageType === 'online') {

                const txt = (message || '').toString().trim();

                device.status = (txt === 'online') ? 'online' : 'offline';

                updateDeviceList();

                if (selectedDeviceId === deviceId) updateBMSInterface(device);

                return;

            }



            try {

                const data = JSON.parse(message);

                if (messageType === 'data') {

                    device.data = data;

                    device.status = 'online';

                } else if (messageType === 'status') {

                    device.info = data;

                    device.status = 'online';

                }

                // Giữ nguyên trạng thái khi chưa chọn thiết bị (không tự động chọn)



                updateDeviceList();

                if (selectedDeviceId === deviceId) {

                    updateBMSInterface(device);

                }

            } catch (error) {

                console.error('Lỗi xử lý tin nhắn MQTT:', error);

            }

        }



        // Cập nhật danh sách thiết bị

        function updateDeviceList() {

            const deviceList = document.getElementById('device-list');

            deviceList.innerHTML = '';

            

            devices.forEach((device, deviceId) => {

                const deviceItem = createDeviceItem(device);

                deviceList.appendChild(deviceItem);

            });

        }



        // Tạo item thiết bị

        function createDeviceItem(device) {

            const item = document.createElement('div');

            item.className = `device-item ${selectedDeviceId === device.id ? 'active' : ''}`;

            item.onclick = () => selectDevice(device.id);

            

            const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';

            const statusText = device.status === 'online' ? 'Online' : 'Offline';

            

            const vTxt = (device.data && typeof device.data.v === 'number') ? device.data.v.toFixed(2) + 'V' : '--';

            const socTxt = (device.data && typeof device.data.soc === 'number') ? device.data.soc + '%' : '--';

            const rssi = (device.info && typeof device.info.wifi_rssi === 'number') ? `RSSI ${device.info.wifi_rssi}` : '--';



            item.innerHTML = `

                <div class="device-item-header">

                    <div class="device-name">ESP32 ${device.id}</div>

                    <div class="device-status ${statusClass}">${statusText}</div>

                </div>

                <div class="device-info-small">

                    ${vTxt} | ${socTxt} | ${rssi}

                </div>

            `;

            

            return item;

        }



        // Chọn thiết bị

        function selectDevice(deviceId) {

            selectedDeviceId = deviceId;

            const device = devices.get(deviceId);

            

            if (device) {

                // Cập nhật giao diện

                updateBMSInterface(device);

                

                // Hiển thị BMS interface

                document.getElementById('welcome-screen').style.display = 'none';

                document.getElementById('bms-interface').classList.add('active');

                

                // Cập nhật danh sách thiết bị

                updateDeviceList();

                

                // Cập nhật tiêu đề

                document.getElementById('selected-device-title').textContent = `ESP32 BMS ${deviceId}`;

                document.getElementById('selected-device-subtitle').textContent = 

                    `IP: ${device.info.local_ip || '--'} | WiFi: ${device.info.wifi_ssid || '--'}`;

                // Khi đã chọn thiết bị, hiển thị settings content và ẩn placeholder
                const se = document.getElementById('settings-empty');
                const sc = document.getElementById('settings-content');
                if (se && sc){ se.style.display = 'none'; sc.style.display = ''; }

                
                // Cập nhật trạng thái nút xóa
                updateRemoveButtonState();
            }

        }



        // Cập nhật giao diện BMS

        function updateBMSInterface(device) {

            const d = device.data || {};

            // Check emergency state and update buttons accordingly
            const emergencyActive = d.emergency_active === true;
            setEmergencyButtons(emergencyActive);

            

            // Thông tin chính (v, i, soc, p)

            document.getElementById('battery-voltage').textContent = (d.v ?? '--') === '--' ? '--' : (+d.v).toFixed(2);

            document.getElementById('current').textContent        = (d.i ?? '--') === '--' ? '--' : (+d.i).toFixed(2);

            document.getElementById('soc').textContent            = d.soc ?? '--';

            document.getElementById('power').textContent          = (d.p ?? '--') === '--' ? '--' : (+d.p).toFixed(2);

            

            // Nhiệt độ (t1, t2, temp_mos)

            document.getElementById('temp1').textContent    = (d.t1 ?? '--') === '--' ? '--' : (+d.t1).toFixed(1);

            document.getElementById('temp2').textContent    = (d.t2 ?? '--') === '--' ? '--' : (+d.t2).toFixed(1);

            document.getElementById('temp-mos').textContent = (d.temp_mos ?? '--') === '--' ? '--' : (+d.temp_mos).toFixed(1);

            

            // Điện áp cell (min_v, max_v, avg_v, delta tự tính)

            const minV = d.min_v, maxV = d.max_v, avgV = d.avg_v;

            const deltaV = (typeof minV === 'number' && typeof maxV === 'number') ? (maxV - minV) : undefined;

            document.getElementById('min-voltage').textContent   = (typeof minV === 'number') ? minV.toFixed(3) : '--';

            document.getElementById('max-voltage').textContent   = (typeof maxV === 'number') ? maxV.toFixed(3) : '--';

            document.getElementById('avg-voltage').textContent   = (typeof avgV === 'number') ? avgV.toFixed(3) : '--';

            document.getElementById('delta-voltage').textContent = (typeof deltaV === 'number') ? deltaV.toFixed(3) : '--';

            

            // Lưới cell: cv là mV → đổi sang V; fallback sang cell_voltages (V)

            const cellVoltages = Array.isArray(d.cv) ? d.cv.map(mv => mv / 1000) : (d.cell_voltages || []);

            updateCellGrid(cellVoltages, 'cell-grid', 'voltage');

            

            // Lưới điện trở (đọc cr nếu có; fallback cell_resistances)

            const cellRes = Array.isArray(d.cr) ? d.cr : (d.cell_resistances || []);

            updateCellGrid(cellRes, 'resistance-grid', 'resistance');



            // Tổng hợp điện trở: ưu tiên min_r/max_r/avg_r/delta_r; nếu thiếu thì tính từ mảng

            const minR   = (typeof d.min_r === 'number')   ? d.min_r   : (cellRes.length ? Math.min(...cellRes) : undefined);

            const maxR   = (typeof d.max_r === 'number')   ? d.max_r   : (cellRes.length ? Math.max(...cellRes) : undefined);

            const avgR   = (typeof d.avg_r === 'number')   ? d.avg_r   : (cellRes.length ? (cellRes.reduce((a,b)=>a+b,0)/cellRes.length) : undefined);

            const deltaR = (typeof d.delta_r === 'number') ? d.delta_r : ((minR!=null && maxR!=null) ? (maxR - minR) : undefined);



            document.getElementById('min-resistance').textContent   = (minR!=null)   ? minR.toFixed(3)   : '--';

            document.getElementById('max-resistance').textContent   = (maxR!=null)   ? maxR.toFixed(3)   : '--';

            document.getElementById('avg-resistance').textContent   = (avgR!=null)   ? avgR.toFixed(3)   : '--';

            document.getElementById('delta-resistance').textContent = (deltaR!=null) ? deltaR.toFixed(3) : '--';

            // Dung lượng pin
            document.getElementById('current-capacity').textContent = (d.cap_cur ?? '--') === '--' ? '--' : (+d.cap_cur).toFixed(2);
            document.getElementById('total-capacity').textContent = (d.cap_tot ?? '--') === '--' ? '--' : (+d.cap_tot).toFixed(2);
            document.getElementById('charge-cycles').textContent = d.cycles ?? '--';

        }



        // Cập nhật cell grid

        function updateCellGrid(cellData, gridId, type) {

            const grid = document.getElementById(gridId);

            if (!cellData || cellData.length === 0) {

                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">Chưa có dữ liệu</div>';

                return;

            }

            

            grid.innerHTML = '';

            

            cellData.forEach((value, index) => {

                const cell = document.createElement('div');

                cell.className = 'cell';

                

                let cssClass = '';

                if (type === 'voltage') {

                    if (value > 3.65) cssClass = 'voltage-high';

                    else if (value < 3.0) cssClass = 'voltage-low';

                    else cssClass = 'voltage-normal';

                } else if (type === 'resistance') {

                    if (value > 2.0) cssClass = 'resistance-high';

                    else if (value < 0.5) cssClass = 'resistance-low';

                    else cssClass = 'resistance-normal';

                }

                

                cell.className = `cell ${cssClass}`;

                cell.innerHTML = `

                    <div class="cell-number">Cell ${index + 1}</div>

                    <div class="cell-value">${value.toFixed(3)}</div>

                `;

                

                grid.appendChild(cell);

            });

        }



        // Cập nhật trạng thái kết nối (removed - no longer needed)

        function updateConnectionStatus(status, text) {

            // Function kept for compatibility but no longer updates UI

        }



        // Hiển thị thông báo

        function showAlert(message, type = 'info') {

            const alertsContainer = document.getElementById('alerts');

            const alert = document.createElement('div');

            alert.className = `alert ${type}`;

            alert.textContent = message;

            

            alertsContainer.appendChild(alert);

            

            setTimeout(() => {

                alert.remove();

            }, 1000);

        }



        // Điều khiển thiết bị

        // UI: toggle buttons based on emergency state
        function setEmergencyButtons(active){
            const be = document.getElementById('btn-emergency');
            const br = document.getElementById('btn-recover');
            if (!be || !br) return;
            if (active){ be.style.display='none'; br.style.display=''; }
            else { be.style.display=''; br.style.display='none'; }
        }

        // Open/close modals
        function openEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='flex'; } }
        function closeEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='none'; } }
        function openRecoverConfirm(){
            preloadRecoverToggles();
            const m=document.getElementById('modal-recover'); if(m){ m.style.display='flex'; }
        }
        function closeRecoverConfirm(){ const m=document.getElementById('modal-recover'); if(m){ m.style.display='none'; } }

        // Confirm emergency: call backend, then swap button
        async function confirmEmergency(){
            if (!selectedDeviceId) { showAlert('Vui lòng chọn thiết bị trước', 'error'); return; }
            try{
                // Send emergency stop command via MQTT
                publishCommand(selectedDeviceId, 'emergency_stop');
                setEmergencyButtons(true);
                closeEmergencyConfirm();
                showAlert(`Đã kích hoạt dừng khẩn cấp thiết bị ${selectedDeviceId}`, 'success');
            }catch(e){ showAlert('Lỗi khi dừng khẩn cấp', 'error'); }
        }

        // Preload recover modal with snapshot (simulate previous state)
        async function preloadRecoverToggles(){
            try{
                // For dashboard, we'll use default values since we don't have direct access to device state
                const setc=(id,v)=>{ const el=document.getElementById(id); if(el) el.checked=!!v; };
                setc('rcv-charge', true);      // Default: enable charge
                setc('rcv-discharge', true);   // Default: enable discharge  
                setc('rcv-balancer', true);    // Default: enable balancer
                setc('rcv-heating', false);    // Default: disable heating
            }catch(e){ /* ignore */ }
        }

        // Confirm recover: apply selected toggles
        async function confirmRecover(){
            if (!selectedDeviceId) { showAlert('Vui lòng chọn thiết bị trước', 'error'); return; }
            const payload = {
                charge_mosfet_on: document.getElementById('rcv-charge').checked,
                discharge_mosfet_on: document.getElementById('rcv-discharge').checked,
                balancer_on: document.getElementById('rcv-balancer').checked,
                heating_on: document.getElementById('rcv-heating').checked
            };
            try{
                // Send recovery command via MQTT
                publishSettingsCommand(selectedDeviceId, payload);
                setEmergencyButtons(false);
                closeRecoverConfirm();
                showAlert(`Đã khôi phục BMS thiết bị ${selectedDeviceId} theo lựa chọn`, 'success');
            }catch(e){ showAlert('Lỗi khi khôi phục BMS', 'error'); }
        }



        function restartDevice() {

            if (selectedDeviceId && confirm(`Bạn có chắc muốn khởi động lại thiết bị ${selectedDeviceId}?`)) {

                publishCommand(selectedDeviceId, 'restart');

                showAlert(`Đã gửi lệnh khởi động lại thiết bị ${selectedDeviceId}`, 'success');

            }

        }

        // Vào Setup Mode qua MQTT: xóa cấu hình trên thiết bị và restart vào AP
        function enterSetupFromDashboard(){
            if (!selectedDeviceId){ showAlert('Chưa chọn thiết bị', 'error'); return; }
            if (confirm(`Thiết lập lại cấu hình và vào Setup Mode cho thiết bị ${selectedDeviceId}?\n\nThiết bị sẽ xoá WiFi/BLE đã lưu và phát AP ESP32-BMS-Setup.`)){
                publishCommand(selectedDeviceId, 'enter_setup');
                showAlert(`Đã gửi lệnh vào Setup Mode cho thiết bị ${selectedDeviceId}`, 'success');
            }
        }

        function powerCycleDevice() {
            if (selectedDeviceId && confirm(`Bạn có chắc muốn khởi động lại nguồn (5s) thiết bị ${selectedDeviceId}?\n\nThiết bị sẽ tạm ngắt nguồn 5 giây rồi bật lại.`)) {
                publishCommand(selectedDeviceId, 'power_cycle');
                showAlert(`Đã gửi lệnh khởi động lại nguồn (5s) cho thiết bị ${selectedDeviceId}`, 'success');
            }
        }

        // Ngắt kết nối: bỏ chọn thiết bị và quay lại màn hình chào mừng
        function disconnectSelectedDevice(){
            if (!selectedDeviceId){ showAlert('Chưa chọn thiết bị để ngắt kết nối', 'error'); return; }
            const devId = selectedDeviceId;
            selectedDeviceId = null;
            // Ẩn interface, hiện welcome
            const welcome = document.getElementById('welcome-screen');
            const iface = document.getElementById('bms-interface');
            if (welcome) welcome.style.display = 'block';
            if (iface) iface.classList.remove('active');
            // Cập nhật danh sách và nút xóa
            updateDeviceList();
            updateRemoveButtonState();
            // Trả Settings về placeholder
            const se = document.getElementById('settings-empty');
            const sc = document.getElementById('settings-content');
            if (se && sc){ se.style.display = ''; sc.style.display = 'none'; }
            showAlert(`Đã ngắt kết nối khỏi thiết bị ${devId}`, 'success');
        }






        // Gửi lệnh qua MQTT

        function publishCommand(deviceId, command) {

            if (mqttClient && mqttClient.connected) {

                const topic = `bms/${deviceId}/control`;

                mqttClient.publish(topic, command);

                console.log(`Đã gửi lệnh ${command} tới ${topic}`);

            } else {

                showAlert('Không thể gửi lệnh - MQTT chưa kết nối', 'error');

            }

        }



        // Khởi tạo dashboard

        function initDashboard() {

            console.log('Khởi tạo BMS Central Dashboard...');

            connectMQTT();

            
            // Khởi tạo trạng thái nút xóa
            updateRemoveButtonState();
            

            // Cập nhật trạng thái thiết bị mỗi 30 giây

            setInterval(() => {

                const now = Date.now();

                devices.forEach((device, deviceId) => {

                    if (now - device.lastSeen > 60000) { // 1 phút

                        device.status = 'offline';

                        updateDeviceList();

                        

                        // Nếu đang chọn thiết bị offline, quay về welcome screen

                        if (selectedDeviceId === deviceId) {

                            selectedDeviceId = null;

                            document.getElementById('welcome-screen').style.display = 'block';

                            document.getElementById('bms-interface').classList.remove('active');

                        }

                    }

                });

                
                // Cập nhật trạng thái nút xóa
                updateRemoveButtonState();
            }, 1000);

        }


        // Scan các thiết bị đang hoạt động
        function scanActiveDevices() {
            console.log('Đang scan các thiết bị đang hoạt động...');
            
            // Gửi lệnh scan tới ESP32
            if (mqttClient && mqttClient.connected) {
                const topic = `bms/esp32_001/cmd/action`;
                mqttClient.publish(topic, 'get_status', { qos: 1 });
                console.log('Đã gửi lệnh scan tới ESP32');
                
                showAlert('Đã gửi lệnh scan tới ESP32', 'success');
            } else {
                showAlert('MQTT chưa kết nối, không thể scan thiết bị', 'error');
            }
        }

        // Xóa thiết bị được chọn
        function removeSelectedDevice() {
            if (!selectedDeviceId) {
                showAlert('Chưa chọn thiết bị để xóa', 'error');
                return;
            }

            if (confirm(`Bạn có chắc muốn xóa thiết bị ${selectedDeviceId} khỏi danh sách?`)) {
                // Xóa thiết bị khỏi danh sách
                devices.delete(selectedDeviceId);
                
                // Nếu đang chọn thiết bị bị xóa, quay về welcome screen
                if (selectedDeviceId === selectedDeviceId) {
                    selectedDeviceId = null;
                    document.getElementById('welcome-screen').style.display = 'block';
                    document.getElementById('bms-interface').classList.remove('active');
                }
                
                // Cập nhật giao diện
                updateDeviceList();
                updateRemoveButtonState();
                
                showAlert(`Đã xóa thiết bị ${selectedDeviceId}`, 'success');
            }
        }

        // Cập nhật trạng thái nút xóa thiết bị
        function updateRemoveButtonState() {
            const removeBtn = document.getElementById('remove-device-btn');
            if (removeBtn) {
                removeBtn.disabled = !selectedDeviceId;
            }
        }



        // Khởi tạo khi trang load xong

        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>

</body>

</html>