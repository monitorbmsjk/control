<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JK BMS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #667eea;
            padding-bottom: 10px;
        }

        .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .unit {
            font-size: 0.8em;
            color: #666;
        }

        .info-section {
            margin-bottom: 15px;
        }
        
        .value {
            padding-bottom: 4px;
            margin-bottom: 0;
        }
        
        .unit {
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .unit:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .separator {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 0;
            border-radius: 1px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }

        .status.online { background: #4CAF50; color: white; }
        .status.offline { background: #f44336; color: white; }
        .status.charging { background: #2196F3; color: white; }
        .status.discharging { background: #FF9800; color: white; }
        .status.balancing { background: #9C27B0; color: white; }

        .cell-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .cell {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid transparent;
        }

        .cell.active {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .cell.voltage-high {
            border-color: #f44336;
            background: #ffebee;
        }

        .cell.voltage-low {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .cell-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        .cell-number {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .alerts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .alert {
            color: #856404;
            margin: 5px 0;
        }

        /* Device name styling */
        .device-name {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }

        .device-label {
            color: #E0E0E0;
            font-weight: 500;
            font-size: 14px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .device-name {
                font-size: 14px;
            }
            .device-label {
                font-size: 13px;
            }
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Settings Form */
        .settings-form {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #667eea;
        }

        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn-ok {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            white-space: nowrap;
        }

        .btn-ok:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-ok:active {
            transform: translateY(0);
        }

        .btn-save {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .btn-reset {
            background: #f44336;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .btn-reset:hover {
            background: #d32f2f;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings lock */
        .lock-box { background: rgba(255,255,255,0.95); border-radius: 12px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); text-align: center; }
        .lock-input { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; width: 220px; }
        .lock-btn { padding: 10px 16px; border: none; border-radius: 8px; background: #667eea; color: #fff; font-weight: bold; margin-left: 10px; cursor: pointer; }
        .lock-msg { margin-top: 10px; color: #f44336; font-weight: bold; }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #888;
            transition: .2s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Language selector styles */
        .lang-selector {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
        }
        .lang-flag {
            width: 22px;
            height: 16px;
            display: inline-block;
            border-radius: 2px;
            overflow: hidden;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .lang-flag svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .lang-select {
            min-width: 140px;
            background: transparent;
            color: #fff;
            border: none;
            outline: none;
            font-size: 14px;
            cursor: pointer;
        }
        .lang-select option {
            background: rgba(255,255,255,0.95);
            color: #333;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .cell-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-content">
        <div class="header">
            <div style="position: relative;">
                <div style="position: absolute; top: 0; right: 0;">
                    <div class="lang-selector">
                        <span id="lang-flag" class="lang-flag" aria-hidden="true"></span>
                        <select id="language-selector" class="lang-select">
                            <option value="vi">Tiếng Việt</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                <h1>🔋 JK BMS </h1>
                <p id="header-subtitle">Hệ thống giám sát và điều khiển BMS</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('monitor')"> Thông số pin </button>
            <button class="tab-btn" onclick="showTab('settings')">Cài đặt </button>
        </div>

        <div class="status-bar">
            <div class="status" id="connection-status">Đang kết nối...</div>
            <div class="status" id="charge-status">Không sạc</div>
            <div class="status" id="balance-status">Không cân bằng</div>
            <div class="status" id="ip-address">IP: --</div>
            <div style="margin-top: 10px;">
                <label class="device-label" id="device-label">Thiết bị:</label>
                <span id="device-name-display" class="device-name">esp32_001</span>
            </div>
        </div>

        <!-- Monitor Tab Content -->
        <div id="monitor-tab" class="tab-content active">
            <div class="grid">
            <!-- Thông tin chính -->
            <div class="card">
                <h3>📊 Thông tin chính</h3>
                
                <!-- Điện áp và SOC -->
                <div class="info-section">
                <div class="value" id="battery-voltage">--</div>
                <div class="unit">Điện áp (V)</div>
                <div class="value" id="soc">--</div>
                <div class="unit">Phần trăm pin (%)</div>
                </div>
                
                <div class="separator"></div>
                
                <!-- Dòng điện và công suất -->
                <div class="info-section">
                    <div class="value" id="current">--</div>
                    <div class="unit">Dòng điện (A)</div>
                <div class="value" id="power">--</div>
                <div class="unit">Công suất (W)</div>
                </div>
                
                <div class="separator"></div>
                
                <!-- Dung lượng -->
                <div class="info-section">
                    <div class="value" id="current-capacity">--</div>
                    <div class="unit" id="current-capacity-unit">Dung lượng hiện tại (Ah)</div>
                    <div class="value" id="total-capacity">--</div>
                    <div class="unit" id="total-capacity-unit">Dung lượng tối đa (Ah)</div>
                </div>
            </div>

            <!-- Nhiệt độ -->
            <div class="card">
                <h3> Nhiệt độ</h3>
                <div class="value" id="temp1">--</div>
                <div class="unit">Nhiệt độ cảm biến 1  (°C)</div>
                <div class="value" id="temp2">--</div>
                <div class="unit">Nhiệt độ cảm biến 2 (°C)</div>
                <div class="value" id="temp-mos">--</div>
                <div class="unit">Nhiệt độ cảm biến MOS (°C)</div>
            </div>

            <!-- Thông tin cell -->
            <div class="card">
                <h3> Thông tin Cell</h3>
                <div class="value" id="min-voltage">--</div>
                <div class="unit">Điện áp thấp nhất  (V)</div>
                <div class="value" id="max-voltage">--</div>
                <div class="unit">Điện áp cao nhất (V)</div>
                <div class="value" id="avg-voltage">--</div>
                <div class="unit">Điện áp trung bình  (V)</div>
                <div class="value" id="delta-voltage">--</div>
                <div class="unit">Điện áp chênh lệch (V)</div>
                <div class="value" id="min-resistance">--</div>
                <div class="unit" id="min-resistance-unit">Điện trở thấp nhất (mΩ)</div>
                <div class="value" id="max-resistance">--</div>
                <div class="unit" id="max-resistance-unit">Điện trở cao nhất (mΩ)</div>
                <div class="value" id="avg-resistance">--</div>
                <div class="unit" id="avg-resistance-unit">Điện trở trung bình (mΩ)</div>
                <div class="value" id="delta-resistance">--</div>
                <div class="unit" id="delta-resistance-unit">Điện trở chênh lệch (mΩ)</div>
            </div>

        </div>

        <!-- Cell Voltages -->
        <div class="card">
            <h3> Điện áp Cell</h3>
            <div class="cell-grid" id="cell-grid">
                <!-- Cells will be populated by JavaScript -->
            </div>
        </div>

        <!-- Cell Resistances -->
        <div class="card">
            <h3> Điện trở Cell</h3>
            <div class="cell-grid" id="res-grid">
                <!-- Resistances will be populated by JavaScript -->
            </div>
        </div>

        <!-- Điều khiển -->
        <div class="card">
            <h3>🛡️ Quản lý BMS</h3>
            <div class="controls">
                <button id="btn-emergency" class="btn btn-danger" onclick="openEmergencyConfirm()">🛑 <span id="emergency-text">Dừng khẩn cấp</span></button>
                <button id="btn-recover" class="btn btn-primary" style="display:none;" onclick="openRecoverConfirm()">🔄 <span id="recover-text">Khởi động lại BMS</span></button>
                <button class="btn btn-warning" onclick="enterSetupMode()">⚙️ <span id="setup-text">Chế độ thiết lập</span></button>
                <button class="btn btn-info" onclick="powerCycleDevice()">⚡ <span id="power-cycle-text">Khởi động lại nguồn (5s)</span></button>
            </div>
        </div>

        <!-- Emergency confirm modal -->
        <div id="modal-emergency" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
            <div style="background:#fff; border-radius:12px; padding:20px; max-width:420px; width:92%;">
                <h3 style="margin-bottom:10px;">Xác nhận dừng khẩn cấp</h3>
                <p style="color:#555;">Hệ thống sẽ tắt sạc, xả, cân bằng, sưởi và bật chế độ khẩn cấp để đảm bảo an toàn.</p>
                <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="closeEmergencyConfirm()">Hủy</button>
                    <button class="btn btn-danger" onclick="confirmEmergency()">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Recover confirm modal -->
        <div id="modal-recover" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
            <div style="background:#fff; border-radius:12px; padding:20px; max-width:520px; width:92%;">
                <h3 style="margin-bottom:10px;">Khởi động lại BMS</h3>
                <p style="color:#555;">Chọn trạng thái cần phục hồi. Mặc định khôi phục theo trước khi dừng khẩn cấp.</p>
                <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <label>MOSFET sạc
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-charge" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>MOSFET xả
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-discharge" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>Bộ cân bằng
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-balancer" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                    <label>Sưởi ấm
                        <label class="switch" style="margin-left:8px;">
                            <input id="rcv-heating" type="checkbox"><span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div style="margin-top:16px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="closeRecoverConfirm()">Hủy</button>
                    <button class="btn btn-primary" onclick="confirmRecover()">Xác nhận</button>
                </div>
            </div>
        </div>

        <!-- Cảnh báo -->
        <div class="card">
            <h3 id="alerts-title"> Cảnh báo</h3>
            <div class="alerts" id="alerts">
                <div class="alert" id="no-alerts-text">Không có cảnh báo</div>
            </div>
        </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings-tab" class="tab-content">
            <div id="settings-lock" class="lock-box" style="display:none; margin-bottom: 20px;">
                <h3>🔒 Nhập mật khẩu để mở cài đặt</h3>
                <div style="margin-top:12px;">
                    <input type="password" id="settings-password" class="lock-input" placeholder="Mật khẩu" />
                    <button class="lock-btn" onclick="unlockSettings()">Mở khóa</button>
                </div>
                <div id="lock-error" class="lock-msg"></div>
            </div>
            <div class="settings-form" id="settings-form" style="display:none;">
                <div class="settings-section">
                    <h3> Điện áp</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-overvoltage" class="tooltip-container">
                                Ngưỡng cao áp cell (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tối đa cho phép của mỗi cell. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-overvoltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_overvoltage', 'cell-overvoltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-overvoltage-recovery" class="tooltip-container">
                                Khôi phục cao áp (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi cell giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá điện áp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-overvoltage-recovery" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_overvoltage_recovery', 'cell-overvoltage-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-undervoltage" class="tooltip-container">
                                Ngưỡng thấp áp cell (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tối thiểu cho phép của mỗi cell. Khi xuống dưới mức này, BMS sẽ ngắt xả để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-undervoltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_undervoltage', 'cell-undervoltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-undervoltage-recovery" class="tooltip-container">
                                Khôi phục thấp áp (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi cell tăng lên trên mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do điện áp thấp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-undervoltage-recovery" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_undervoltage_recovery', 'cell-undervoltage-recovery')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="balance-trigger-voltage" class="tooltip-container">
                                Ngưỡng cân bằng (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp bắt đầu cân bằng các cell. Khi cell nào vượt quá ngưỡng này, BMS sẽ bắt đầu cân bằng để giảm điện áp của cell đó.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="balance-trigger-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('balance_trigger_voltage', 'balance-trigger-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="balance-start-voltage" class="tooltip-container">
                                Điện áp bắt đầu cân bằng (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp chính xác để bắt đầu cân bằng. Thường thấp hơn ngưỡng cân bằng một chút để tránh cân bằng không cần thiết.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="balance-start-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('balance_start_voltage', 'balance-start-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-soc100-voltage" class="tooltip-container">
                                Điện áp khi pin 100% (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tương ứng với mức pin 100%. Dùng để tính toán chính xác mức pin còn lại.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-soc100-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_soc100_voltage', 'cell-soc100-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-soc0-voltage" class="tooltip-container">
                                Điện áp khi pin 0% (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp tương ứng với mức pin 0%. Dùng để tính toán chính xác mức pin còn lại.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-soc0-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_soc0_voltage', 'cell-soc0-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-request-charge-voltage" class="tooltip-container">
                                Điện áp yêu cầu sạc (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mục tiêu khi sạc đầy. BMS sẽ ngừng sạc khi đạt đến điện áp này.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-request-charge-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_request_charge_voltage', 'cell-request-charge-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cell-request-float-voltage" class="tooltip-container">
                                Điện áp duy trì (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp duy trì sau khi sạc đầy. Thấp hơn điện áp sạc để tránh quá sạc và tăng tuổi thọ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-request-float-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_request_float_voltage', 'cell-request-float-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="smart-sleep-voltage" class="tooltip-container">
                                Điện áp ngủ thông minh (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="smart-sleep-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('smart_sleep_voltage', 'smart-sleep-voltage')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="power-off-voltage" class="tooltip-container">
                                Điện áp tắt nguồn (V)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Điện áp mà khi pin xuống dưới mức này, BMS sẽ tắt hoàn toàn để bảo vệ pin khỏi xả quá sâu.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="power-off-voltage" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('power_off_voltage', 'power-off-voltage')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cell-count" class="tooltip-container">
                                Số lượng cell
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tổng số cell lithium trong bộ pin. Ví dụ: 16 cell cho pin 48V.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="cell-count" step="1" min="2" max="32">
                                <button class="btn-ok" onclick="saveSingleSetting('cell_count', 'cell-count')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="capacity" class="tooltip-container">
                                Tổng dung lượng (Ah)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tổng dung lượng của bộ pin tính bằng Ampere-giờ. Ví dụ: 100Ah cho pin 48V 100Ah.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="capacity" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('capacity', 'capacity')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3> Dòng điện</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max-balance-current" class="tooltip-container">
                                Dòng cân bằng tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa được sử dụng để cân bằng các cell. Dòng cao hơn sẽ cân bằng nhanh hơn nhưng tiêu thụ nhiều năng lượng hơn.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="max-balance-current" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('max_balance_current', 'max-balance-current')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-current" class="tooltip-container">
                                Dòng sạc tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa cho phép khi sạc pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng sạc.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-current" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_current', 'charge-current')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-current" class="tooltip-container">
                                Dòng xả tối đa (A)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Dòng điện tối đa cho phép khi xả pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng xả.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-current" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_current', 'discharge-current')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="current-calibration" class="tooltip-container">
                                Hiệu chuẩn dòng điện
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến dòng điện. Dùng để bù trừ sai số đo.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="current-calibration" step="0.001">
                                <button class="btn-ok" onclick="saveSingleSetting('current_calibration', 'current-calibration')">OK</button>
                        </div>
                    </div>
                </div>
                </div>

                <div class="settings-section">
                    <h3> Thời gian & Độ trễ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-ocp-delay-s" class="tooltip-container">
                                Độ trễ quá dòng sạc (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ quá dòng sạc. Cho phép dòng tăng đột ngột tạm thời.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-ocp-delay-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_ocp_delay_s', 'charge-ocp-delay-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-ocpr-time-s" class="tooltip-container">
                                Thời gian khôi phục quá dòng sạc (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép sạc lại sau khi đã ngắt do quá dòng sạc.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-ocpr-time-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_ocpr_time_s', 'charge-ocpr-time-s')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-ocp-delay-s" class="tooltip-container">
                                Độ trễ quá dòng xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ quá dòng xả. Cho phép dòng tăng đột ngột tạm thời.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-ocp-delay-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_ocp_delay_s', 'discharge-ocp-delay-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="discharge-ocpr-time-s" class="tooltip-container">
                                Thời gian khôi phục quá dòng xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép xả lại sau khi đã ngắt do quá dòng xả.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-ocpr-time-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_ocpr_time_s', 'discharge-ocpr-time-s')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scp-delay-us" class="tooltip-container">
                                Độ trễ bảo vệ ngắn mạch (μs)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi kích hoạt bảo vệ ngắn mạch. Thời gian rất ngắn để phát hiện ngắn mạch nhanh.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="scp-delay-us" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('scp_delay_us', 'scp-delay-us')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="scp-recovery-time-s" class="tooltip-container">
                                Thời gian khôi phục ngắn mạch (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian chờ trước khi cho phép hoạt động lại sau khi đã ngắt do ngắn mạch.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="scp-recovery-time-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('scp_recovery_time_s', 'scp-recovery-time-s')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="request-charge-voltage-time-h" class="tooltip-container">
                                Thời gian điện áp sạc (h)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian duy trì điện áp sạc trước khi chuyển sang điện áp duy trì.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="request-charge-voltage-time-h" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('request_charge_voltage_time_h', 'request-charge-voltage-time-h')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="request-float-voltage-time-h" class="tooltip-container">
                                Thời gian điện áp duy trì (h)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian duy trì điện áp float sau khi sạc đầy.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="request-float-voltage-time-h" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('request_float_voltage_time_h', 'request-float-voltage-time-h')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-precharge-time-s" class="tooltip-container">
                                Thời gian sạc trước xả (s)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Thời gian sạc nhẹ trước khi cho phép xả pin để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-precharge-time-s" step="1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_precharge_time_s', 'discharge-precharge-time-s')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="voltage-calibration" class="tooltip-container">
                                Hiệu chuẩn điện áp
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến điện áp. Dùng để bù trừ sai số đo.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="voltage-calibration" step="0.01">
                                <button class="btn-ok" onclick="saveSingleSetting('voltage_calibration', 'voltage-calibration')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3> Nhiệt độ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao khi sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép khi sạc pin. Vượt quá mức này sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-overtemp" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_overtemp', 'charge-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá nhiệt.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-overtemp-recovery" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_overtemp_recovery', 'charge-overtemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao khi xả (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép khi xả pin. Vượt quá mức này sẽ ngắt xả để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-overtemp" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_overtemp', 'discharge-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="discharge-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ xả (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do quá nhiệt.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="discharge-overtemp-recovery" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('discharge_overtemp_recovery', 'discharge-overtemp-recovery')">OK</button>
                        </div>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-undertemp" class="tooltip-container">
                                Nhiệt độ quá thấp khi sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối thiểu cho phép khi sạc pin. Dưới mức này sẽ ngắt sạc để bảo vệ pin.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-undertemp" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_undertemp', 'charge-undertemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="charge-undertemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ thấp sạc (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi tăng lên trên mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ thấp.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="charge-undertemp-recovery" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('charge_undertemp_recovery', 'charge-undertemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mos-overtemp" class="tooltip-container">
                                Nhiệt độ quá cao MOSFET (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ tối đa cho phép của MOSFET. Vượt quá mức này sẽ ngắt hoạt động để bảo vệ MOSFET.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="mos-overtemp" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('mos_overtemp', 'mos-overtemp')">OK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mos-overtemp-recovery" class="tooltip-container">
                                Khôi phục nhiệt độ MOSFET (°C)
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép hoạt động lại sau khi đã ngắt do quá nhiệt MOSFET.</span>
                            </label>
                            <div class="input-with-button">
                                <input type="number" id="mos-overtemp-recovery" step="0.1">
                                <button class="btn-ok" onclick="saveSingleSetting('mos_overtemp_recovery', 'mos-overtemp-recovery')">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3> Công tắc điều khiển</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                MOSFET sạc
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Bật/tắt MOSFET điều khiển sạc pin. Khi tắt, BMS sẽ không cho phép sạc pin.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="charge-mosfet-on" onchange="saveSwitch('charge_mosfet_on', 'charge-mosfet-on')"><span class="slider"></span></label>
                        </div>
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                MOSFET xả
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Bật/tắt MOSFET điều khiển xả pin. Khi tắt, BMS sẽ không cho phép xả pin.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="discharge-mosfet-on" onchange="saveSwitch('discharge_mosfet_on', 'discharge-mosfet-on')"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Bộ cân bằng
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Bật/tắt chức năng cân bằng các cell. Khi bật, BMS sẽ tự động cân bằng điện áp các cell.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="balancer-on" onchange="saveSwitch('balancer_on', 'balancer-on')"><span class="slider"></span></label>
                        </div>
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Sưởi ấm
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Bật/tắt chức năng sưởi ấm pin khi nhiệt độ thấp. Giúp pin hoạt động tốt trong môi trường lạnh.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="heating-on" onchange="saveSwitch('heating_on', 'heating-on')"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Tắt cảm biến nhiệt
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tắt chức năng giám sát nhiệt độ. Chỉ dùng khi không có cảm biến nhiệt hoặc muốn bỏ qua bảo vệ nhiệt.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="disable-temperature-sensors" onchange="saveSwitch('disable_temperature_sensors', 'disable-temperature-sensors')"><span class="slider"></span></label>
                </div>
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Màn hình luôn sáng
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Giữ màn hình BMS luôn sáng. Tắt để tiết kiệm năng lượng khi không sử dụng.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="display-always-on" onchange="saveSwitch('display_always_on', 'display-always-on')"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Ngủ thông minh
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="smart-sleep-on" onchange="saveSwitch('smart_sleep_on', 'smart-sleep-on')"><span class="slider"></span></label>
                        </div>
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Tắt module PCL
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tắt module PCL (Power Control Logic). Chỉ dùng khi cần thiết để bỏ qua một số chức năng bảo vệ.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="disable-pcl-module" onchange="saveSwitch('disable_pcl_module', 'disable-pcl-module')"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Lưu dữ liệu theo thời gian
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Bật chức năng lưu trữ dữ liệu theo thời gian để theo dõi lịch sử hoạt động của pin.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="timed-stored-data" onchange="saveSwitch('timed_stored_data', 'timed-stored-data')"><span class="slider"></span></label>
                        </div>
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Chế độ float sạc
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Kích hoạt chế độ float sạc để duy trì pin ở mức sạc đầy mà không gây quá sạc.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="charging-float-mode" onchange="saveSwitch('charging_float_mode', 'charging-float-mode')"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="margin-right:10px;" class="tooltip-container">
                                Chế độ khẩn cấp
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Kích hoạt chế độ khẩn cấp để bỏ qua một số bảo vệ khi cần thiết. Chỉ dùng trong trường hợp đặc biệt.</span>
                            </label>
                            <label class="switch"><input type="checkbox" id="emergency-mode" onchange="saveSwitch('emergency_mode', 'emergency-mode')"><span class="slider"></span></label>
                </div>
            </div>
        </div>

                <div style="text-align: center; margin-top: 30px;">
                    <span id="settings-msg" style="color:#f44336;font-weight:bold;"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Remove emoji/icons from some texts but keep them for control buttons
        function stripEmojis() {
            const strip = s => s.replace(/[\u2190-\u21FF\u2300-\u23FF\u2600-\u27BF\u1F000-\u1FAFF]/g, '').replace(/\s{2,}/g,' ').trim();
            // Only strip emojis from specific elements, not control buttons
            const nodes = document.querySelectorAll('h1,h2,h3,.unit,label,.status,.tab-btn');
            nodes.forEach(n=>{ if(n && n.textContent){ n.textContent = strip(n.textContent); } });
        }
        let autoRefresh = true;
        let refreshInterval;

        // MQTT Configuration
        const mqttConfig = {
            host: 'broker.hivemq.com',
            port: 8884, // WebSocket port
            path: '/mqtt',
            clientId: 'bms_dashboard_' + Math.random().toString(16).substr(2, 8),
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30 * 1000,
            keepalive: 60
        };

        // MQTT Global variables
        let mqttClient = null;
        let selectedDeviceId = 'esp32_001'; // Default device ID
        let devices = new Map(); // deviceId -> deviceData
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // Update device name display
        function updateDeviceNameDisplay() {
            const deviceDisplay = document.getElementById('device-name-display');
            if (deviceDisplay) {
                deviceDisplay.textContent = selectedDeviceId;
            }
        }



        // Handle Enter key in password input and initialize global password overlay
        document.addEventListener('DOMContentLoaded', function() {
            // Keep emojis for better UI - don't strip them
            // stripEmojis();
            
            // Initialize language selector
            initializeLanguageSelector();
            
            // Update device name display
            updateDeviceNameDisplay();
            
            // Initialize app immediately (no password required)
            initializeApp();
            
            // Setup settings if already unlocked
            if (settingsUnlocked()) {
                if (document.getElementById('settings-tab').classList.contains('active')) {
                    hideSettingsLock();
                    loadSettings();
                }
            }
        });

        // Initialize app after password is entered
        function initializeApp() {
            connectMQTT();
            loadSettings();
        }

        // MQTT Connection
        function connectMQTT() {
            try {
                console.log('🔌 Attempting MQTT connection...');
                const url = `wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;
                console.log('🌐 MQTT URL:', url);
                
                mqttClient = mqtt.connect(url, {
                    clientId: mqttConfig.clientId,
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 30000,
                    keepalive: 60
                });

                mqttClient.on('connect', () => {
                    console.log('✅ MQTT kết nối thành công!');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    
                    // Subscribe to BMS topics
                    console.log('📡 Subscribing to topics...');
                    mqttClient.subscribe(`bms/${selectedDeviceId}/data`);
                    mqttClient.subscribe(`bms/${selectedDeviceId}/status`);
                    mqttClient.subscribe(`bms/${selectedDeviceId}/online`);
                    mqttClient.subscribe(`bms/${selectedDeviceId}/settings`);
                    mqttClient.subscribe(`bms/${selectedDeviceId}/switches`);
                    console.log('📡 Subscribed to all topics for device:', selectedDeviceId);
                    
                    // Request data from device
                    console.log('📤 Requesting data from device...');
                    requestData();
                });

                mqttClient.on('message', (topic, message) => {
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', (error) => {
                    console.error('MQTT error:', error);
                    updateConnectionStatus(false);
                });

                mqttClient.on('close', () => {
                    console.log('MQTT kết nối đóng');
                    updateConnectionStatus(false);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(connectMQTT, 5000);
                    }
                });

            } catch (error) {
                console.error('Lỗi kết nối MQTT:', error);
                updateConnectionStatus(false);
            }
        }

        // Handle MQTT Messages
        function handleMQTTMessage(topic, message) {
            try {
                console.log(`📨 Received MQTT: ${topic} -> ${message.substring(0, 100)}...`);
                const topicParts = topic.split('/');
                const deviceId = topicParts[1];
                const messageType = topicParts[2];

                console.log(`🔍 Parsed topic - Device: ${deviceId}, Type: ${messageType}`);

                if (deviceId === selectedDeviceId) {
                    console.log(`✅ Processing message for selected device: ${selectedDeviceId}`);
                    switch (messageType) {
                        case 'data':
                            console.log('📊 Processing data message...');
                            const data = JSON.parse(message);
                            console.log('📊 Data received:', data);
                updateUI(data);
                            break;
                        case 'status':
                            const status = JSON.parse(message);
                            updateDeviceStatus(status);
                            break;
                        case 'online':
                            updateConnectionStatus(message === 'online');
                            break;
                        case 'settings':
                            const settings = JSON.parse(message);
                            updateSettingsUI(settings);
                            break;
                        case 'switches':
                            const switches = JSON.parse(message);
                            updateSwitchesUI(switches);
                            break;
                    }
                }
            } catch (error) {
                console.error('Lỗi xử lý tin nhắn MQTT:', error);
            }
        }

        // Request data from device
        function requestData() {
            if (mqttClient && mqttClient.connected) {
                const topic = `bms/${selectedDeviceId}/cmd/action`;
                console.log(`📤 Publishing get_data command to: ${topic}`);
                mqttClient.publish(topic, 'get_data', { qos: 1 });
                console.log(`✅ Đã gửi lệnh get_data tới ${topic}`);
            } else {
                console.log('❌ MQTT client not connected, cannot request data');
            }
        }


        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'Đã kết nối';
                statusElement.className = 'status online';
            } else {
                statusElement.textContent = 'Mất kết nối';
                statusElement.className = 'status offline';
            }
        }

        // Update device status
        function updateDeviceStatus(status) {
            console.log('📡 Updating device status:', status);
            // Update IP address if available
            if (status.wifi_ssid) {
                document.getElementById('ip-address').textContent = `WiFi: ${status.wifi_ssid}`;
            }
            if (status.ip_address) {
                document.getElementById('ip-address').textContent = `IP: ${status.ip_address}`;
            }
        }

        // Update settings UI
        function updateSettingsUI(settings) {
            // Voltages với giá trị mặc định
            document.getElementById('cell-overvoltage').value = settings.cell_overvoltage ?? '3.650';
            document.getElementById('cell-overvoltage-recovery').value = settings.cell_overvoltage_recovery ?? '3.500';
            document.getElementById('cell-undervoltage').value = settings.cell_undervoltage ?? '3.000';
            document.getElementById('cell-undervoltage-recovery').value = settings.cell_undervoltage_recovery ?? '3.100';
            document.getElementById('balance-trigger-voltage').value = settings.balance_trigger_voltage ?? '3.400';
            document.getElementById('balance-start-voltage').value = settings.balance_start_voltage ?? '3.350';
            document.getElementById('cell-soc100-voltage').value = settings.cell_soc100_voltage ?? '3.600';
            document.getElementById('cell-soc0-voltage').value = settings.cell_soc0_voltage ?? '3.000';
            document.getElementById('cell-request-charge-voltage').value = settings.cell_request_charge_voltage ?? '3.400';
            document.getElementById('cell-request-float-voltage').value = settings.cell_request_float_voltage ?? '3.350';
            document.getElementById('smart-sleep-voltage').value = settings.smart_sleep_voltage ?? '3.200';
            document.getElementById('power-off-voltage').value = settings.power_off_voltage ?? '2.800';
            document.getElementById('cell-count').value = settings.cell_count ?? '16';
            document.getElementById('capacity').value = settings.capacity ?? '280.0';
            
            // Currents/calibration với giá trị mặc định
            document.getElementById('max-balance-current').value = settings.max_balance_current ?? '0.080';
            document.getElementById('charge-current').value = settings.charge_current ?? '50.0';
            document.getElementById('discharge-current').value = settings.discharge_current ?? '50.0';
            document.getElementById('current-calibration').value = settings.current_calibration ?? '0.0';
            
            // Times với giá trị mặc định
            document.getElementById('charge-ocp-delay-s').value = settings.charge_ocp_delay_s ?? '10';
            document.getElementById('charge-ocpr-time-s').value = settings.charge_ocpr_time_s ?? '10';
            document.getElementById('discharge-ocp-delay-s').value = settings.discharge_ocp_delay_s ?? '10';
            document.getElementById('discharge-ocpr-time-s').value = settings.discharge_ocpr_time_s ?? '10';
            document.getElementById('scp-delay-us').value = settings.scp_delay_us ?? '1000';
            document.getElementById('scp-recovery-time-s').value = settings.scp_recovery_time_s ?? '10';
            document.getElementById('request-charge-voltage-time-h').value = settings.request_charge_voltage_time_h ?? '1';
            document.getElementById('request-float-voltage-time-h').value = settings.request_float_voltage_time_h ?? '1';
            document.getElementById('discharge-precharge-time-s').value = settings.discharge_precharge_time_s ?? '5';
            document.getElementById('voltage-calibration').value = settings.voltage_calibration ?? '0.0';
            
            // Temps với giá trị mặc định
            document.getElementById('charge-overtemp').value = settings.charge_overtemp ?? '60';
            document.getElementById('charge-overtemp-recovery').value = settings.charge_overtemp_recovery ?? '50';
            document.getElementById('discharge-overtemp').value = settings.discharge_overtemp ?? '70';
            document.getElementById('discharge-overtemp-recovery').value = settings.discharge_overtemp_recovery ?? '60';
            document.getElementById('charge-undertemp').value = settings.charge_undertemp ?? '-10';
            document.getElementById('charge-undertemp-recovery').value = settings.charge_undertemp_recovery ?? '0';
            document.getElementById('mos-overtemp').value = settings.mos_overtemp ?? '80';
            document.getElementById('mos-overtemp-recovery').value = settings.mos_overtemp_recovery ?? '70';
            
            console.log('Settings UI updated from MQTT');
        }

        // Update switches UI
        function updateSwitchesUI(switches) {
            const setc = (id, val) => { 
                const el = document.getElementById(id); 
                if (el) el.checked = !!val; 
            };
            
            setc('charge-mosfet-on', switches.charge_mosfet_on);
            setc('discharge-mosfet-on', switches.discharge_mosfet_on);
            setc('balancer-on', switches.balancer_on);
            setc('heating-on', switches.heating_on);
            setc('disable-temperature-sensors', switches.disable_temperature_sensors);
            setc('display-always-on', switches.display_always_on);
            setc('smart-sleep-on', switches.smart_sleep_on);
            setc('disable-pcl-module', switches.disable_pcl_module);
            setc('timed-stored-data', switches.timed_stored_data);
            setc('charging-float-mode', switches.charging_float_mode);
            setc('emergency-mode', switches.emergency_mode);
            
            console.log('Switches UI updated from MQTT');
        }

        // Cập nhật UI
        function updateUI(data) {
            console.log('🎨 Updating UI with data:', data);
            console.log('🔍 Data fields available:', Object.keys(data));
            console.log('📊 Key values - v:', data.v, 'i:', data.i, 'soc:', data.soc, 'p:', data.p);
            // Cập nhật trạng thái kết nối (MQTT data không có trường connected)
            updateConnectionStatus(true);

            // Cập nhật trạng thái emergency buttons
            if (data.emergency_active !== undefined) {
                setEmergencyButtons(data.emergency_active);
            }

            // Cập nhật thông tin chính
            const voltageEl = document.getElementById('battery-voltage');
            const currentEl = document.getElementById('current');
            const socEl = document.getElementById('soc');
            const powerEl = document.getElementById('power');
            
            console.log('🔍 Elements found:', {
                voltage: !!voltageEl,
                current: !!currentEl,
                soc: !!socEl,
                power: !!powerEl
            });
            
            if (voltageEl) voltageEl.textContent = data.v || '--';
            if (currentEl) currentEl.textContent = data.i || '--';
            if (socEl) socEl.textContent = data.soc || '--';
            if (powerEl) powerEl.textContent = data.p || '--';
            
            // Cập nhật dung lượng trong card thông tin chính
            const currentCapacityEl = document.getElementById('current-capacity');
            const totalCapacityEl = document.getElementById('total-capacity');
            if (currentCapacityEl) currentCapacityEl.textContent = (data.cap_cur ?? '--') === '--' ? '--' : (+data.cap_cur).toFixed(2);
            if (totalCapacityEl) totalCapacityEl.textContent = (data.cap_tot ?? '--') === '--' ? '--' : (+data.cap_tot).toFixed(2);
            
            console.log('✅ Updated main values:', {
                voltage: data.v,
                current: data.i,
                soc: data.soc,
                power: data.p,
                currentCapacity: data.cap_cur,
                totalCapacity: data.cap_tot
            });

            // Cập nhật nhiệt độ
            document.getElementById('temp1').textContent = data.t1 || '--';
            document.getElementById('temp2').textContent = data.t2 || '--';
            document.getElementById('temp-mos').textContent = data.temp_mos || '--';

            // Cập nhật thông tin cell (min_v, max_v, avg_v đã là Volt)
            console.log('🔋 Cell voltage summary:', {
                min_v: data.min_v,
                max_v: data.max_v,
                avg_v: data.avg_v,
                delta_voltage: data.delta_voltage
            });
            document.getElementById('min-voltage').textContent = data.min_v ? data.min_v.toFixed(3) : '--';
            document.getElementById('max-voltage').textContent = data.max_v ? data.max_v.toFixed(3) : '--';
            document.getElementById('avg-voltage').textContent = data.avg_v ? data.avg_v.toFixed(3) : '--';
            
            // Tính delta voltage từ max - min
            const deltaV = (typeof data.min_v === 'number' && typeof data.max_v === 'number') ? (data.max_v - data.min_v) : undefined;
            document.getElementById('delta-voltage').textContent = (typeof deltaV === 'number') ? deltaV.toFixed(3) : '--';


            // Cập nhật cell voltages
            console.log('🔋 Cell voltages data (cv):', data.cv);
            console.log('🔋 Cell voltages converted to V:', data.cv ? data.cv.map(v => (v/1000).toFixed(3)) : 'No data');
            updateCellVoltages(data.cv || []);
            // Cập nhật cell resistances
            console.log('⚡ Cell resistances data (cr):', data.cr);
            updateCellResistances(data);

            // Cập nhật trạng thái
            updateStatus(data);

            // Cập nhật cảnh báo
            updateAlerts(data.alerts || []);
        }

        // Cập nhật trạng thái kết nối
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.textContent = '🟢 Online';
                status.className = 'status online';
            } else {
                status.textContent = '🔴 Offline';
                status.className = 'status offline';
            }
            
            // IP address sẽ được cập nhật từ MQTT status message
        }

        // Cập nhật cell voltages
        function updateCellVoltages(cellVoltages) {
            console.log('🔋 Updating cell voltages:', cellVoltages);
            const grid = document.getElementById('cell-grid');
            if (!grid) {
                console.log('❌ Cell grid element not found');
                return;
            }
            grid.innerHTML = '';

            cellVoltages.forEach((voltage, index) => {
                if (voltage > 0) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    // Thêm class dựa trên voltage (chuyển đổi từ mV sang V)
                    const voltageV = voltage / 1000;
                    if (voltageV > 3.65) cell.classList.add('voltage-high');
                    else if (voltageV < 3.0) cell.classList.add('voltage-low');
                    else cell.classList.add('active');

                    cell.innerHTML = `
                        <div class="cell-number">Cell ${index + 1}</div>
                        <div class="cell-value">${(voltage / 1000).toFixed(3)}V</div>
                    `;
                    grid.appendChild(cell);
                }
            });
        }

        // Cập nhật cell resistances
        function updateCellResistances(data) {
            console.log('⚡ Updating cell resistances with data:', data);
            const grid = document.getElementById('res-grid');
            if (!grid) {
                console.log('❌ Resistance grid element not found');
                return;
            }
            grid.innerHTML = '';
            const resistances = data.cr || [];
            console.log('⚡ Cell resistances array:', resistances);
            const minR = data.min_r;
            const maxR = data.max_r;
            const avgR = data.avg_r;
            
            // Tính delta resistance từ max - min (như dashboard.html)
            const deltaR = (typeof data.delta_r === 'number') ? data.delta_r : ((minR != null && maxR != null) ? (maxR - minR) : undefined);
            
            console.log('⚡ Resistance values:', { minR, maxR, avgR, deltaR });

            // Cập nhật các giá trị tổng quan
            const minEl = document.getElementById('min-resistance');
            const maxEl = document.getElementById('max-resistance');
            const avgEl = document.getElementById('avg-resistance');
            const deltaEl = document.getElementById('delta-resistance');
            if (minEl) minEl.textContent = (minR !== undefined && minR > 0) ? minR.toFixed(3) : '--';
            if (maxEl) maxEl.textContent = (maxR !== undefined && maxR > 0) ? maxR.toFixed(3) : '--';
            if (avgEl) avgEl.textContent = (avgR !== undefined && avgR > 0) ? avgR.toFixed(3) : '--';
            if (deltaEl) deltaEl.textContent = (deltaR !== undefined && deltaR >= 0) ? deltaR.toFixed(3) : '--';

            // Hiển thị từng cell
            resistances.forEach((r, index) => {
                if (r > 0) {
                    const cell = document.createElement('div');
                    cell.className = 'cell active';
                    cell.innerHTML = `
                        <div class="cell-number">Cell ${index + 1}</div>
                        <div class="cell-value">${r.toFixed(3)} mΩ</div>
                    `;
                    grid.appendChild(cell);
                }
            });
        }

        // Cập nhật trạng thái
        function updateStatus(data) {
            console.log('📊 Updating status with data:', {
                chg: data.chg,
                dchg: data.dchg,
                bal: data.bal
            });
            const chargeStatus = document.getElementById('charge-status');
            const balanceStatus = document.getElementById('balance-status');

            // Trạng thái sạc
            const langSelector = document.getElementById('language-selector');
            const currentLang = langSelector ? langSelector.value : 'vi';
            const t = translations[currentLang] || translations['vi'];
            
            if (data.chg) {
                chargeStatus.textContent = t.charging;
                chargeStatus.className = 'status charging';
            } else if (data.dchg) {
                chargeStatus.textContent = t.discharging;
                chargeStatus.className = 'status discharging';
            } else {
                chargeStatus.textContent = t.not_charging_status;
                chargeStatus.className = 'status';
            }

            // Trạng thái cân bằng
            if (data.bal) {
                balanceStatus.textContent = t.balancing;
                balanceStatus.className = 'status balancing';
            } else {
                balanceStatus.textContent = t.not_balancing_status;
                balanceStatus.className = 'status';
            }
        }

        // Cập nhật cảnh báo
        function updateAlerts(alerts) {
            const alertsContainer = document.getElementById('alerts');
            const langSelector = document.getElementById('language-selector');
            const currentLang = langSelector ? langSelector.value : 'vi';
            const t = translations[currentLang] || translations['vi'];
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `<div class="alert">${t.no_alerts}</div>`;
            } else {
                alertsContainer.innerHTML = alerts.map(alert => 
                    `<div class="alert">⚠️ ${alert}</div>`
                ).join('');
            }
        }

        // Làm mới dữ liệu
        function refreshData() {
            loadData();
        }

        // Bật/tắt tự động làm mới
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                refreshInterval = setInterval(loadData, 500);
            } else {
                clearInterval(refreshInterval);
            }
        }

        // UI: toggle buttons based on emergency state
        function setEmergencyButtons(active){
            const be = document.getElementById('btn-emergency');
            const br = document.getElementById('btn-recover');
            if (!be || !br) return;
            if (active){ be.style.display='none'; br.style.display=''; }
            else { be.style.display=''; br.style.display='none'; }
        }

        // Open/close modals
        function openEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='flex'; } }
        function closeEmergencyConfirm(){ const m=document.getElementById('modal-emergency'); if(m){ m.style.display='none'; } }
        function openRecoverConfirm(){
            preloadRecoverToggles();
            const m=document.getElementById('modal-recover'); if(m){ m.style.display='flex'; }
        }
        function closeRecoverConfirm(){ const m=document.getElementById('modal-recover'); if(m){ m.style.display='none'; } }

        // Confirm emergency: call backend, then swap button
        async function confirmEmergency(){
            try{
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'emergency_stop', { qos: 1 });
                setEmergencyButtons(true);
                closeEmergencyConfirm();
                    alert('Đã gửi lệnh dừng khẩn cấp qua MQTT');
                } else {
                    alert('MQTT chưa kết nối');
                }
            }catch(e){ alert('Lỗi khi dừng khẩn cấp'); }
        }

        // Preload recover modal with snapshot
        async function preloadRecoverToggles(){
            try{
                // Sử dụng dữ liệu switches hiện tại từ MQTT
                    const setc=(id,v)=>{ const el=document.getElementById(id); if(el) el.checked=!!v; };
                
                // Lấy dữ liệu từ các toggle hiện tại
                const chargeEl = document.getElementById('charge-mosfet');
                const dischargeEl = document.getElementById('discharge-mosfet');
                const balancerEl = document.getElementById('balancer');
                const heatingEl = document.getElementById('heating');
                
                if (chargeEl) setc('rcv-charge', chargeEl.checked);
                if (dischargeEl) setc('rcv-discharge', dischargeEl.checked);
                if (balancerEl) setc('rcv-balancer', balancerEl.checked);
                if (heatingEl) setc('rcv-heating', heatingEl.checked);
            }catch(e){ /* ignore */ }
        }

        // Confirm recover: apply selected toggles
        async function confirmRecover(){
            const payload = {
                charge_mosfet_on: document.getElementById('rcv-charge').checked,
                discharge_mosfet_on: document.getElementById('rcv-discharge').checked,
                balancer_on: document.getElementById('rcv-balancer').checked,
                heating_on: document.getElementById('rcv-heating').checked
            };
            try{
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/switches`;
                    mqttClient.publish(topic, JSON.stringify(payload), { qos: 1 });
                    setEmergencyButtons(false);
                    closeRecoverConfirm();
                    alert('Đã gửi lệnh khôi phục BMS qua MQTT');
                } else {
                    alert('MQTT chưa kết nối');
                }
            }catch(e){ alert('Lỗi khi khôi phục BMS'); }
        }

        // Vào Setup Mode
        async function enterSetupMode() {
            if (confirm('Bạn có chắc muốn vào Setup Mode?\nESP32 sẽ khởi động lại và tạo WiFi "ESP32-BMS-Setup".')) {
                try {
                    if (mqttClient && mqttClient.connected) {
                        const topic = `bms/${selectedDeviceId}/cmd/action`;
                        mqttClient.publish(topic, 'enter_setup', { qos: 1 });
                        alert('✅ Đã gửi lệnh vào Setup Mode qua MQTT!\n\nESP32 sẽ khởi động lại trong 3 giây.\n\nSau đó:\n1. Kết nối WiFi "ESP32-BMS-Setup" (password: 12345678)\n2. Truy cập http://192.168.4.1');
                        
                        // Hiển thị hướng dẫn chi tiết
                        setTimeout(() => {
                            const instructions = `
🔧 HƯỚNG DẪN SETUP MODE:

1️⃣ Kết nối WiFi:
   - Tên: ESP32-BMS-Setup
   - Password: 12345678

2️⃣ Truy cập web:
   - Địa chỉ: http://192.168.4.1
   - Hoặc: http://192.168.4.1/setup

3️⃣ Cấu hình:
   - Chọn WiFi của bạn
   - Nhập password WiFi
   - Lưu cấu hình

4️⃣ ESP32 sẽ tự động kết nối WiFi và hoạt động bình thường!
                            `;
                            alert(instructions);
                        }, 3000);
                    } else {
                        alert('❌ MQTT chưa kết nối!\nVui lòng kiểm tra kết nối MQTT.');
                    }
                } catch (error) {
                    alert('❌ Lỗi khi vào Setup Mode!\nVui lòng thử lại.');
                }
            }
        }



        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load settings when switching to settings tab
            if (tabName === 'settings') {
                if (!settingsUnlocked()) {
                    showSettingsLock();
                } else {
                    hideSettingsLock();
                    document.getElementById('settings-form').style.display = '';
                loadSettings();
                    // Cập nhật labels khi mở settings tab
                    const currentLang = localStorage.getItem('language') || 'vi';
                    updateSettingsLabels(currentLang);
                }
            }
            // Load log when switching to log tab
            if (tabName === 'log') {
                loadLog();
            }
        }

        // Load settings from server
        async function loadSettings() {
            if (!settingsUnlocked()) { showSettingsLock(); return; }
            try {
                if (mqttClient && mqttClient.connected) {
                    // Request settings via MQTT
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'get_settings', { qos: 1 });
                    console.log('Đã gửi lệnh get_settings qua MQTT');
                } else {
                    console.log('MQTT chưa kết nối, không thể load settings');
                    // Hiển thị giá trị mặc định khi không có MQTT
                    updateSettingsUI({});
                }
            } catch(e){ 
                const lang = localStorage.getItem('language') || 'vi';
                const t = translations[lang];
                const msgEl = document.getElementById('settings-msg');
                if (msgEl){ msgEl.style.color = '#f44336'; msgEl.textContent = t.load_settings_error; }
                // Hiển thị giá trị mặc định khi có lỗi
                updateSettingsUI({});
            }
            await loadSwitches();
        }

        async function loadSwitches(){
            try{
                if (mqttClient && mqttClient.connected) {
                    // Request switches via MQTT
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'get_switches', { qos: 1 });
                    console.log('Đã gửi lệnh get_switches qua MQTT');
                } else {
                    console.log('MQTT chưa kết nối, không thể load switches');
                }
            }catch(e){ /* ignore */ }
        }

        // Lưu từng setting riêng lẻ
        async function saveSingleSetting(settingKey, elementId) {
            const value = parseFloat(document.getElementById(elementId).value);
            if (isNaN(value)) {
                showSettingsMessage('Giá trị không hợp lệ!', 'error');
                return;
            }

            const setting = {};
            setting[settingKey] = value;

            try {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/settings`;
                    mqttClient.publish(topic, JSON.stringify(setting), { qos: 1 });
                    showSettingsMessage('Đã gửi cài đặt qua MQTT!', 'success');
                } else {
                    showSettingsMessage('MQTT chưa kết nối!', 'error');
                }
            } catch (e) {
                showSettingsMessage('Lỗi kết nối MQTT!', 'error');
            }
        }

        // Hiển thị thông báo settings
        function showSettingsMessage(message, type) {
            const msgEl = document.getElementById('settings-msg');
            msgEl.textContent = message;
            msgEl.style.color = type === 'success' ? '#4CAF50' : '#f44336';
            msgEl.style.fontWeight = 'bold';
            setTimeout(() => msgEl.textContent = '', 2000);
        }

        // Hiển thị thông báo chung
        function showAlert(message, type = 'info') {
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#ff9800',
                'info': '#2196F3'
            };
            
            // Tạo thông báo tạm thời
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                max-width: 300px;
                word-wrap: break-word;
            `;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Lưu công tắc khi thay đổi
        async function saveSwitch(switchKey, elementId) {
            const value = document.getElementById(elementId).checked;
            
            const switchData = {};
            switchData[switchKey] = value;

            try {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/switches`;
                    mqttClient.publish(topic, JSON.stringify(switchData), { qos: 1 });
                    showSettingsMessage('Đã gửi công tắc qua MQTT!', 'success');
                } else {
                    showSettingsMessage('MQTT chưa kết nối!', 'error');
                }
            } catch (e) {
                showSettingsMessage('Lỗi kết nối MQTT!', 'error');
            }
        }

        // Reset settings to default
        function resetSettings() {
            if (confirm('Bạn có chắc muốn khôi phục cài đặt mặc định?')) {
                document.getElementById('capacity').value = 280.0;
                document.getElementById('balance-trigger-voltage').value = 3.40;
                document.getElementById('cell-overvoltage').value = 3.65;
                document.getElementById('cell-undervoltage').value = 3.0;
                document.getElementById('charge-current').value = 50.0;
                document.getElementById('discharge-current').value = 50.0;
                document.getElementById('charge-overtemp').value = 60;
                document.getElementById('discharge-overtemp').value = 70;
                document.getElementById('mos-overtemp').value = 80;
            }
        }

        // Log tab: load log file
        async function loadLog() {
            const logArea = document.getElementById('log-area');
            logArea.textContent = 'Đang tải log...';
            try {
                const response = await fetch('/logs_jk-bms_logs.txt');
                if (response.ok) {
                    const text = await response.text();
                    logArea.textContent = text || 'Không có log.';
                } else {
                    logArea.textContent = 'Không thể tải log.';
                }
            } catch (e) { logArea.textContent = 'Không thể tải log.'; }
        }

        function settingsUnlocked(){ return sessionStorage.getItem('settingsUnlocked') === 'true'; }
        function showSettingsLock(){
            document.getElementById('settings-lock').style.display = '';
            document.getElementById('settings-form').style.display = 'none';
            document.getElementById('lock-error').textContent = '';
            document.getElementById('settings-password').value = '';
        }
        function hideSettingsLock(){
            document.getElementById('settings-lock').style.display = 'none';
            document.getElementById('settings-form').style.display = '';
        }
        function unlockSettings(){
            const pwd = document.getElementById('settings-password').value;
            if (pwd === 'adcdongduong') {
                sessionStorage.setItem('settingsUnlocked', 'true');
                hideSettingsLock();
                loadSettings();
                // Cập nhật labels khi unlock settings
                const currentLang = localStorage.getItem('language') || 'vi';
                updateSettingsLabels(currentLang);
            } else {
                document.getElementById('lock-error').textContent = 'Mật khẩu không đúng!';
            }
        }

        // Settings unlock check is now handled in main DOMContentLoaded listener

        // Language translations
        const translations = {
            vi: {
                header_subtitle: "Hệ thống giám sát và điều khiển BMS",
                monitor_tab: "Thông số pin",
                settings_tab: "Cài đặt",
                connecting: "Đang kết nối...",
                not_charging: "Không sạc",
                not_balancing: "Không cân bằng",
                device: "Thiết bị:",
                main_info: "📊 Thông tin chính",
                voltage: "Điện áp (V)",
                current: "Dòng điện (A)",
                battery_percent: "Phần trăm pin (%)",
                power: "Công suất (W)",
                temperature: "🌡️ Nhiệt độ",
                temp_sensor1: "Nhiệt độ cảm biến 1 (°C)",
                temp_sensor2: "Nhiệt độ cảm biến 2 (°C)",
                temp_mos: "Nhiệt độ cảm biến MOS (°C)",
                cell_info: "🔋 Thông tin Cell",
                min_voltage: "Điện áp thấp nhất (V)",
                max_voltage: "Điện áp cao nhất (V)",
                avg_voltage: "Điện áp trung bình (V)",
                delta_voltage: "Điện áp chênh lệch (V)",
                capacity: "📈 Dung lượng",
                min_resistance: "Điện trở thấp nhất (mΩ)",
                max_resistance: "Điện trở cao nhất (mΩ)",
                avg_resistance: "Điện trở trung bình (mΩ)",
                delta_resistance: "Điện trở chênh lệch (mΩ)",
                current_capacity: "Dung lượng hiện tại (Ah)",
                total_capacity: "Dung lượng tối đa (Ah)",
                charge_cycles: "Số lần sạc",
                cell_voltages: "⚡ Điện áp Cell",
                cell_resistances: "⚡ Điện trở Cell",
                esp32_control: "Điều khiển BMS",
                emergency_stop: "Dừng khẩn cấp",
                setup_mode: "Chế độ thiết lập",
                power_cycle: "Khởi động lại nguồn (5s)",
                recover_bms: "Khởi động lại BMS",

                alerts: "⚠️ Cảnh báo",
                no_alerts: "Không có cảnh báo",
                online: "🟢 Online",
                offline: "🔴 Offline",
                charging: "🔌 Đang sạc",
                discharging: "⚡ Đang xả",
                not_charging_status: "⏸️ Không sạc",
                balancing: "⚖️ Đang cân bằng",
                not_balancing_status: "⏸️ Không cân bằng",
                global_password_title: "🔒 JK BMS",
                global_password_message: "Vui lòng nhập mật khẩu để truy cập",
                global_password_placeholder: "Mật khẩu",
                global_password_button: "Truy cập",
                global_password_error: "Mật khẩu không đúng!",
                settings_password: "🔒 Nhập mật khẩu để mở cài đặt",
                password: "Mật khẩu",
                unlock: "Mở khóa",
                wrong_password: "Mật khẩu không đúng!",
                voltage_settings: "⚡ Điện áp",
                current_settings: "⚡ Dòng điện",
                time_settings: "⏰ Thời gian & Độ trễ",
                temp_settings: "🌡️ Nhiệt độ",
                switch_settings: "🎛️ Công tắc điều khiển",
                save_settings: "Lưu cài đặt",
                save_switches: "Lưu công tắc",
                save_all_settings: "Lưu tất cả cài đặt",
                settings_saved: "Đã lưu cài đặt!",
                switches_saved: "Đã lưu công tắc!",
                all_settings_saved: "Đã lưu tất cả cài đặt!",
                settings_error: "Lỗi lưu cài đặt!",
                switches_error: "Lỗi lưu công tắc!",
                connection_error: "Lỗi kết nối!",
                load_settings_error: "Lỗi tải cài đặt",
                // Settings labels
                cell_overvoltage: "Ngưỡng cao áp cell (V)",
                cell_overvoltage_recovery: "Khôi phục cao áp (V)",
                cell_undervoltage: "Ngưỡng thấp áp cell (V)",
                cell_undervoltage_recovery: "Khôi phục thấp áp (V)",
                balance_trigger_voltage: "Ngưỡng cân bằng (V)",
                balance_start_voltage: "Điện áp bắt đầu cân bằng (V)",
                cell_soc100_voltage: "Điện áp khi pin 100% (V)",
                cell_soc0_voltage: "Điện áp khi pin 0% (V)",
                cell_request_charge_voltage: "Điện áp yêu cầu sạc (V)",
                cell_request_float_voltage: "Điện áp duy trì (V)",
                smart_sleep_voltage: "Điện áp ngủ thông minh (V)",
                power_off_voltage: "Điện áp tắt nguồn (V)",
                cell_count: "Số lượng cell",
                capacity: "Tổng dung lượng (Ah)",
                max_balance_current: "Dòng cân bằng tối đa (A)",
                charge_current: "Dòng sạc tối đa (A)",
                discharge_current: "Dòng xả tối đa (A)",
                current_calibration: "Hiệu chuẩn dòng điện",
                charge_ocp_delay_s: "Độ trễ quá dòng sạc (s)",
                charge_ocpr_time_s: "Thời gian khôi phục quá dòng sạc (s)",
                discharge_ocp_delay_s: "Độ trễ quá dòng xả (s)",
                discharge_ocpr_time_s: "Thời gian khôi phục quá dòng xả (s)",
                scp_delay_us: "Độ trễ ngắn mạch (μs)",
                scp_recovery_time_s: "Thời gian khôi phục ngắn mạch (s)",
                request_charge_voltage_time_h: "Thời gian yêu cầu sạc (h)",
                request_float_voltage_time_h: "Thời gian yêu cầu float (h)",
                discharge_precharge_time_s: "Thời gian precharge xả (s)",
                voltage_calibration: "Hiệu chuẩn điện áp",
                charge_overtemp: "Nhiệt độ quá cao sạc (°C)",
                charge_overtemp_recovery: "Nhiệt độ khôi phục sạc (°C)",
                discharge_overtemp: "Nhiệt độ quá cao xả (°C)",
                discharge_overtemp_recovery: "Nhiệt độ khôi phục xả (°C)",
                charge_undertemp: "Nhiệt độ quá thấp sạc (°C)",
                charge_undertemp_recovery: "Nhiệt độ khôi phục sạc (°C)",
                mos_overtemp: "Nhiệt độ quá cao MOSFET (°C)",
                mos_overtemp_recovery: "Nhiệt độ khôi phục MOSFET (°C)",
                charge_mosfet_on: "MOSFET sạc",
                discharge_mosfet_on: "MOSFET xả",
                balancer_on: "Bộ cân bằng",
                heating_on: "Sưởi ấm",
                disable_temperature_sensors: "Tắt cảm biến nhiệt",
                display_always_on: "Màn hình luôn sáng",
                smart_sleep_on: "Ngủ thông minh",
                disable_pcl_module: "Tắt module PCL",
                timed_stored_data: "Lưu dữ liệu theo thời gian",
                charging_float_mode: "Chế độ float sạc",
                emergency_mode: "Chế độ khẩn cấp",
                // Tooltips
                cell_overvoltage_tooltip: "Điện áp tối đa cho phép của mỗi cell. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin.",
                cell_overvoltage_recovery_tooltip: "Điện áp mà khi cell giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do quá điện áp.",
                cell_undervoltage_tooltip: "Điện áp tối thiểu cho phép của mỗi cell. Khi xuống dưới mức này, BMS sẽ ngắt xả để bảo vệ pin.",
                cell_undervoltage_recovery_tooltip: "Điện áp mà khi cell tăng lên trên mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do điện áp thấp.",
                balance_trigger_voltage_tooltip: "Điện áp bắt đầu cân bằng các cell. Khi cell nào vượt quá ngưỡng này, BMS sẽ bắt đầu cân bằng để giảm điện áp của cell đó.",
                balance_start_voltage_tooltip: "Điện áp chính xác để bắt đầu cân bằng. Thường thấp hơn ngưỡng cân bằng một chút để tránh cân bằng không cần thiết.",
                cell_soc100_voltage_tooltip: "Điện áp tương ứng với mức pin 100%. Dùng để tính toán chính xác mức pin còn lại.",
                cell_soc0_voltage_tooltip: "Điện áp tương ứng với mức pin 0%. Dùng để tính toán chính xác mức pin còn lại.",
                cell_request_charge_voltage_tooltip: "Điện áp mục tiêu khi sạc đầy. BMS sẽ ngừng sạc khi đạt đến điện áp này.",
                cell_request_float_voltage_tooltip: "Điện áp duy trì sau khi sạc đầy. Thấp hơn điện áp sạc để tránh quá sạc và tăng tuổi thọ pin.",
                smart_sleep_voltage_tooltip: "Điện áp kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.",
                power_off_voltage_tooltip: "Điện áp mà khi pin xuống dưới mức này, BMS sẽ tắt hoàn toàn để bảo vệ pin khỏi xả quá sâu.",
                cell_count_tooltip: "Tổng số cell lithium trong bộ pin. Ví dụ: 16 cell cho pin 48V.",
                capacity_tooltip: "Tổng dung lượng của bộ pin tính bằng Ampere-giờ. Ví dụ: 100Ah cho pin 48V 100Ah.",
                max_balance_current_tooltip: "Dòng điện tối đa được sử dụng để cân bằng các cell. Dòng cao hơn sẽ cân bằng nhanh hơn nhưng tiêu thụ nhiều năng lượng hơn.",
                charge_current_tooltip: "Dòng điện tối đa cho phép khi sạc pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng sạc.",
                discharge_current_tooltip: "Dòng điện tối đa cho phép khi xả pin. Vượt quá mức này sẽ kích hoạt bảo vệ quá dòng xả.",
                current_calibration_tooltip: "Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến dòng điện. Dùng để bù trừ sai số đo.",
                charge_ocp_delay_s_tooltip: "Thời gian chờ trước khi kích hoạt bảo vệ quá dòng sạc. Cho phép dòng tăng đột ngột tạm thời.",
                charge_ocpr_time_s_tooltip: "Thời gian chờ trước khi cho phép sạc lại sau khi đã ngắt do quá dòng sạc.",
                discharge_ocp_delay_s_tooltip: "Thời gian chờ trước khi kích hoạt bảo vệ quá dòng xả. Cho phép dòng tăng đột ngột tạm thời.",
                discharge_ocpr_time_s_tooltip: "Thời gian chờ trước khi cho phép xả lại sau khi đã ngắt do quá dòng xả.",
                scp_delay_us_tooltip: "Thời gian chờ rất ngắn trước khi kích hoạt bảo vệ ngắn mạch. Đơn vị micro giây.",
                scp_recovery_time_s_tooltip: "Thời gian chờ trước khi cho phép hoạt động lại sau khi đã ngắt do ngắn mạch.",
                request_charge_voltage_time_h_tooltip: "Thời gian tối đa cho phép sạc liên tục. Sau thời gian này, BMS sẽ ngắt sạc để bảo vệ.",
                request_float_voltage_time_h_tooltip: "Thời gian tối đa cho phép duy trì ở chế độ float. Sau thời gian này, BMS sẽ chuyển sang chế độ khác.",
                discharge_precharge_time_s_tooltip: "Thời gian precharge trước khi cho phép xả đầy đủ. Dùng để bảo vệ mạch điện.",
                voltage_calibration_tooltip: "Hệ số hiệu chuẩn để điều chỉnh độ chính xác của cảm biến điện áp. Dùng để bù trừ sai số đo.",
                charge_overtemp_tooltip: "Nhiệt độ tối đa cho phép khi sạc pin. Khi vượt quá, BMS sẽ ngắt sạc để bảo vệ pin khỏi nhiệt độ cao.",
                charge_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ cao.",
                discharge_overtemp_tooltip: "Nhiệt độ tối đa cho phép khi xả pin. Khi vượt quá, BMS sẽ ngắt xả để bảo vệ pin khỏi nhiệt độ cao.",
                discharge_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép xả lại sau khi đã ngắt do nhiệt độ cao.",
                charge_undertemp_tooltip: "Nhiệt độ tối thiểu cho phép khi sạc pin. Khi xuống dưới mức này, BMS sẽ ngắt sạc để bảo vệ pin khỏi nhiệt độ thấp.",
                charge_undertemp_recovery_tooltip: "Nhiệt độ mà khi tăng lên trên mức này, BMS sẽ cho phép sạc lại sau khi đã ngắt do nhiệt độ thấp.",
                mos_overtemp_tooltip: "Nhiệt độ tối đa cho phép của MOSFET. Khi vượt quá, BMS sẽ ngắt hoạt động để bảo vệ mạch điện.",
                mos_overtemp_recovery_tooltip: "Nhiệt độ mà khi giảm xuống dưới mức này, BMS sẽ cho phép hoạt động lại sau khi đã ngắt do nhiệt độ MOSFET cao.",
                charge_mosfet_on_tooltip: "Bật/tắt MOSFET điều khiển sạc pin. Khi tắt, BMS sẽ không cho phép sạc pin.",
                discharge_mosfet_on_tooltip: "Bật/tắt MOSFET điều khiển xả pin. Khi tắt, BMS sẽ không cho phép xả pin.",
                balancer_on_tooltip: "Bật/tắt chức năng cân bằng các cell. Khi bật, BMS sẽ tự động cân bằng điện áp các cell.",
                heating_on_tooltip: "Bật/tắt chức năng sưởi ấm pin khi nhiệt độ thấp. Giúp pin hoạt động tốt trong môi trường lạnh.",
                disable_temperature_sensors_tooltip: "Tắt chức năng giám sát nhiệt độ. Chỉ dùng khi không có cảm biến nhiệt hoặc muốn bỏ qua bảo vệ nhiệt.",
                display_always_on_tooltip: "Giữ màn hình BMS luôn sáng. Tắt để tiết kiệm năng lượng khi không sử dụng.",
                smart_sleep_on_tooltip: "Kích hoạt chế độ ngủ thông minh để tiết kiệm năng lượng khi pin đã sạc đầy.",
                disable_pcl_module_tooltip: "Tắt module PCL (Power Control Logic). Chỉ dùng khi cần thiết để bỏ qua một số chức năng bảo vệ.",
                timed_stored_data_tooltip: "Bật chức năng lưu trữ dữ liệu theo thời gian để theo dõi lịch sử hoạt động của pin.",
                charging_float_mode_tooltip: "Kích hoạt chế độ float sạc để duy trì pin ở mức sạc đầy mà không gây quá sạc.",
                emergency_mode_tooltip: "Kích hoạt chế độ khẩn cấp để bỏ qua một số bảo vệ khi cần thiết. Chỉ dùng trong trường hợp đặc biệt."
            },
            en: {
                header_subtitle: "BMS Monitoring and Control System",
                monitor_tab: "Battery Status",
                settings_tab: "Settings",
                connecting: "Connecting...",
                not_charging: "Not Charging",
                not_balancing: "Not Balancing",
                device: "Device:",
                main_info: "📊 Main Information",
                voltage: "Voltage (V)",
                current: "Current (A)",
                battery_percent: "Battery Percentage (%)",
                power: "Power (W)",
                temperature: "🌡️ Temperature",
                temp_sensor1: "Temperature Sensor 1 (°C)",
                temp_sensor2: "Temperature Sensor 2 (°C)",
                temp_mos: "MOS Temperature (°C)",
                cell_info: "🔋 Cell Information",
                min_voltage: "Minimum Voltage (V)",
                max_voltage: "Maximum Voltage (V)",
                avg_voltage: "Average Voltage (V)",
                delta_voltage: "Voltage Difference (V)",
                capacity: "📈 Capacity",
                min_resistance: "Minimum Resistance (mΩ)",
                max_resistance: "Maximum Resistance (mΩ)",
                avg_resistance: "Average Resistance (mΩ)",
                delta_resistance: "Resistance Difference (mΩ)",
                current_capacity: "Current Capacity (Ah)",
                total_capacity: "Maximum Capacity (Ah)",
                charge_cycles: "Charge Cycles",
                cell_voltages: "⚡ Cell Voltages",
                cell_resistances: "⚡ Cell Resistances",
                esp32_control: "BMS Control",
                emergency_stop: "Emergency Stop",
                setup_mode: "Setup Mode",
                power_cycle: "Power Cycle (5s)",
                recover_bms: "Restart BMS",

                alerts: "⚠️ Alerts",
                no_alerts: "No alerts",
                online: "🟢 Online",
                offline: "🔴 Offline",
                charging: "🔌 Charging",
                discharging: "⚡ Discharging",
                not_charging_status: "⏸️ Not Charging",
                balancing: "⚖️ Balancing",
                not_balancing_status: "⏸️ Not Balancing",
                global_password_title: "🔒 JK BMS",
                global_password_message: "Please enter password to access",
                global_password_placeholder: "Password",
                global_password_button: "Access",
                global_password_error: "Wrong password!",
                settings_password: "🔒 Enter password to unlock settings",
                password: "Password",
                unlock: "Unlock",
                wrong_password: "Wrong password!",
                voltage_settings: "⚡ Voltage",
                current_settings: "⚡ Current",
                time_settings: "⏰ Time & Delay",
                temp_settings: "🌡️ Temperature",
                switch_settings: "🎛️ Control Switches",
                save_settings: "Save Settings",
                save_switches: "Save Switches",
                save_all_settings: "Save All Settings",
                settings_saved: "Settings saved!",
                switches_saved: "Switches saved!",
                all_settings_saved: "All settings saved!",
                settings_error: "Settings save error!",
                switches_error: "Switches save error!",
                connection_error: "Connection error!",
                load_settings_error: "Settings load error",
                // Settings labels
                cell_overvoltage: "Cell Overvoltage Threshold (V)",
                cell_overvoltage_recovery: "Overvoltage Recovery (V)",
                cell_undervoltage: "Cell Undervoltage Threshold (V)",
                cell_undervoltage_recovery: "Undervoltage Recovery (V)",
                balance_trigger_voltage: "Balance Trigger Voltage (V)",
                balance_start_voltage: "Balance Start Voltage (V)",
                cell_soc100_voltage: "Cell Voltage at 100% SOC (V)",
                cell_soc0_voltage: "Cell Voltage at 0% SOC (V)",
                cell_request_charge_voltage: "Request Charge Voltage (V)",
                cell_request_float_voltage: "Request Float Voltage (V)",
                smart_sleep_voltage: "Smart Sleep Voltage (V)",
                power_off_voltage: "Power Off Voltage (V)",
                cell_count: "Cell Count",
                capacity: "Total Capacity (Ah)",
                max_balance_current: "Max Balance Current (A)",
                charge_current: "Max Charge Current (A)",
                discharge_current: "Max Discharge Current (A)",
                current_calibration: "Current Calibration",
                charge_ocp_delay_s: "Charge OCP Delay (s)",
                charge_ocpr_time_s: "Charge OCP Recovery Time (s)",
                discharge_ocp_delay_s: "Discharge OCP Delay (s)",
                discharge_ocpr_time_s: "Discharge OCP Recovery Time (s)",
                scp_delay_us: "SCP Delay (μs)",
                scp_recovery_time_s: "SCP Recovery Time (s)",
                request_charge_voltage_time_h: "Request Charge Voltage Time (h)",
                request_float_voltage_time_h: "Request Float Voltage Time (h)",
                discharge_precharge_time_s: "Discharge Precharge Time (s)",
                voltage_calibration: "Voltage Calibration",
                charge_overtemp: "Charge Overtemperature (°C)",
                charge_overtemp_recovery: "Charge Overtemperature Recovery (°C)",
                discharge_overtemp: "Discharge Overtemperature (°C)",
                discharge_overtemp_recovery: "Discharge Overtemperature Recovery (°C)",
                charge_undertemp: "Charge Undertemperature (°C)",
                charge_undertemp_recovery: "Charge Undertemperature Recovery (°C)",
                mos_overtemp: "MOS Overtemperature (°C)",
                mos_overtemp_recovery: "MOS Overtemperature Recovery (°C)",
                charge_mosfet_on: "Charge MOSFET",
                discharge_mosfet_on: "Discharge MOSFET",
                balancer_on: "Balancer",
                heating_on: "Heating",
                disable_temperature_sensors: "Disable Temperature Sensors",
                display_always_on: "Display Always On",
                smart_sleep_on: "Smart Sleep",
                disable_pcl_module: "Disable PCL Module",
                timed_stored_data: "Timed Stored Data",
                charging_float_mode: "Charging Float Mode",
                emergency_mode: "Emergency Mode",
                // Tooltips
                cell_overvoltage_tooltip: "Maximum allowed voltage for each cell. When exceeded, BMS will cut off charging to protect the battery.",
                cell_overvoltage_recovery_tooltip: "Voltage at which the cell drops below this level, BMS will allow charging again after being cut off due to overvoltage.",
                cell_undervoltage_tooltip: "Minimum allowed voltage for each cell. When below this level, BMS will cut off discharge to protect the battery.",
                cell_undervoltage_recovery_tooltip: "Voltage at which the cell rises above this level, BMS will allow discharge again after being cut off due to low voltage.",
                balance_trigger_voltage_tooltip: "Voltage to start balancing cells. When any cell exceeds this threshold, BMS will start balancing to reduce that cell's voltage.",
                balance_start_voltage_tooltip: "Exact voltage to start balancing. Usually slightly lower than balance threshold to avoid unnecessary balancing.",
                cell_soc100_voltage_tooltip: "Voltage corresponding to 100% battery level. Used to accurately calculate remaining battery level.",
                cell_soc0_voltage_tooltip: "Voltage corresponding to 0% battery level. Used to accurately calculate remaining battery level.",
                cell_request_charge_voltage_tooltip: "Target voltage when fully charged. BMS will stop charging when reaching this voltage.",
                cell_request_float_voltage_tooltip: "Maintenance voltage after fully charged. Lower than charge voltage to avoid overcharging and extend battery life.",
                smart_sleep_voltage_tooltip: "Voltage to activate smart sleep mode to save energy when battery is fully charged.",
                power_off_voltage_tooltip: "Voltage at which when battery drops below this level, BMS will shut down completely to protect battery from deep discharge.",
                cell_count_tooltip: "Total number of lithium cells in the battery pack. Example: 16 cells for 48V battery.",
                capacity_tooltip: "Total capacity of the battery pack in Ampere-hours. Example: 100Ah for 48V 100Ah battery.",
                max_balance_current_tooltip: "Maximum current used to balance cells. Higher current will balance faster but consume more energy.",
                charge_current_tooltip: "Maximum allowed current when charging battery. Exceeding this will trigger overcurrent protection.",
                discharge_current_tooltip: "Maximum allowed current when discharging battery. Exceeding this will trigger overcurrent protection.",
                current_calibration_tooltip: "Calibration factor to adjust current sensor accuracy. Used to compensate for measurement errors.",
                charge_ocp_delay_s_tooltip: "Delay time before triggering charge overcurrent protection. Allows temporary current spikes.",
                charge_ocpr_time_s_tooltip: "Wait time before allowing charging again after being cut off due to charge overcurrent.",
                discharge_ocp_delay_s_tooltip: "Delay time before triggering discharge overcurrent protection. Allows temporary current spikes.",
                discharge_ocpr_time_s_tooltip: "Wait time before allowing discharge again after being cut off due to discharge overcurrent.",
                scp_delay_us_tooltip: "Very short delay time before triggering short circuit protection. Unit in microseconds.",
                scp_recovery_time_s_tooltip: "Wait time before allowing operation again after being cut off due to short circuit.",
                request_charge_voltage_time_h_tooltip: "Maximum time allowed for continuous charging. After this time, BMS will cut off charging for protection.",
                request_float_voltage_time_h_tooltip: "Maximum time allowed to maintain float mode. After this time, BMS will switch to other mode.",
                discharge_precharge_time_s_tooltip: "Precharge time before allowing full discharge. Used to protect electrical circuits.",
                voltage_calibration_tooltip: "Calibration factor to adjust voltage sensor accuracy. Used to compensate for measurement errors.",
                current_calibration_tooltip: "Calibration factor to adjust current sensor accuracy. Used to compensate for measurement errors.",
                charge_overtemp_tooltip: "Maximum allowed temperature when charging battery. When exceeded, BMS will cut off charging to protect battery from high temperature.",
                charge_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow charging again after being cut off due to high temperature.",
                discharge_overtemp_tooltip: "Maximum allowed temperature when discharging battery. When exceeded, BMS will cut off discharge to protect battery from high temperature.",
                discharge_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow discharge again after being cut off due to high temperature.",
                charge_undertemp_tooltip: "Minimum allowed temperature when charging battery. When below this level, BMS will cut off charging to protect battery from low temperature.",
                charge_undertemp_recovery_tooltip: "Temperature at which when rises above this level, BMS will allow charging again after being cut off due to low temperature.",
                mos_overtemp_tooltip: "Maximum allowed temperature of MOSFET. When exceeded, BMS will cut off operation to protect electrical circuits.",
                mos_overtemp_recovery_tooltip: "Temperature at which when drops below this level, BMS will allow operation again after being cut off due to high MOSFET temperature.",
                charge_mosfet_on_tooltip: "Turn on/off MOSFET controlling battery charging. When off, BMS will not allow battery charging.",
                discharge_mosfet_on_tooltip: "Turn on/off MOSFET controlling battery discharging. When off, BMS will not allow battery discharging.",
                balancer_on_tooltip: "Turn on/off cell balancing function. When on, BMS will automatically balance cell voltages.",
                heating_on_tooltip: "Turn on/off heating function when temperature is low. Helps battery work well in cold environment.",
                disable_temperature_sensors_tooltip: "Turn off temperature monitoring function. Only use when no temperature sensor or want to ignore temperature protection.",
                display_always_on_tooltip: "Keep BMS display always on. Turn off to save energy when not in use.",
                smart_sleep_on_tooltip: "Activate smart sleep mode to save energy when battery is fully charged.",
                disable_pcl_module_tooltip: "Turn off PCL (Power Control Logic) module. Only use when necessary to bypass some protection functions.",
                timed_stored_data_tooltip: "Turn on timed data storage function to track battery operation history.",
                charging_float_mode_tooltip: "Activate float charging mode to maintain battery at full charge without causing overcharge.",
                emergency_mode_tooltip: "Activate emergency mode to bypass some protections when necessary. Only use in special cases."
            }
        };

        // Initialize language selector
        function initializeLanguageSelector() {
            const selector = document.getElementById('language-selector');
            if (!selector) {
                // If selector doesn't exist yet, try again after a short delay
                setTimeout(initializeLanguageSelector, 100);
                return;
            }
            
            const currentLang = localStorage.getItem('language') || 'vi';
            selector.value = currentLang;
            renderLanguageFlag(currentLang);
            applyLanguage(currentLang);
            
            // Also apply language to global password overlay if it exists
            const globalOverlay = document.getElementById('global-password-overlay');
            if (globalOverlay) {
                const t = translations[currentLang];
                const overlayTitle = globalOverlay.querySelector('h2');
                if (overlayTitle) overlayTitle.textContent = t.global_password_title;
                
                const overlayMessage = globalOverlay.querySelector('p');
                if (overlayMessage) overlayMessage.textContent = t.global_password_message;
                
                const passwordInput = document.getElementById('global-password-input');
                if (passwordInput) passwordInput.placeholder = t.global_password_placeholder;
                
                const accessBtn = globalOverlay.querySelector('button');
                if (accessBtn) accessBtn.textContent = t.global_password_button;
            }
            
            selector.addEventListener('change', function() {
                const lang = this.value;
                localStorage.setItem('language', lang);
                console.log('Language changed to:', lang);
                renderLanguageFlag(lang);
                applyLanguage(lang);
            });
        }

        function renderLanguageFlag(lang){
            const el = document.getElementById('lang-flag');
            if(!el) {
                // If flag element doesn't exist yet, try again after a short delay
                setTimeout(() => renderLanguageFlag(lang), 100);
                return;
            }
            if(lang === 'en'){
                // US flag SVG - fixed viewBox
                el.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 630" preserveAspectRatio="xMidYMid meet">
  <rect width="1200" height="630" fill="#b22234"/>
  <g fill="#fff">
    <rect width="1200" height="48.5" y="48.5"/>
    <rect width="1200" height="48.5" y="145.5"/>
    <rect width="1200" height="48.5" y="242.5"/>
    <rect width="1200" height="48.5" y="339.5"/>
    <rect width="1200" height="48.5" y="436.5"/>
    <rect width="1200" height="48.5" y="533.5"/>
  </g>
  <rect width="480" height="340" fill="#3c3b6e"/>
</svg>`;
            } else {
                // Vietnam flag SVG - fixed viewBox
                el.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" preserveAspectRatio="xMidYMid meet">
  <rect width="900" height="600" fill="#da251d"/>
  <polygon fill="#ff0" points="450,135 495,290 675,290 540,365 585,520 450,445 315,520 360,365 225,290 405,290"/>
</svg>`;
            }
        }

        // Apply language to UI
        function applyLanguage(lang) {
            const t = translations[lang];
            
            // Header
            const headerSubtitle = document.getElementById('header-subtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = t.header_subtitle;
            }
            
            // Tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            if (tabButtons.length >= 2) {
            tabButtons[0].textContent = t.monitor_tab;
            tabButtons[1].textContent = t.settings_tab;
            }
            
            // Status bar
            const statusElements = document.querySelectorAll('.status');
            if (statusElements.length >= 4) {
                statusElements[0].textContent = t.connecting;
                statusElements[1].textContent = t.not_charging;
                statusElements[2].textContent = t.not_balancing;
            }
            
            // Card titles
            const cardTitles = document.querySelectorAll('.card h3');
            if (cardTitles.length >= 6) {
                cardTitles[0].textContent = t.main_info;
                cardTitles[1].textContent = t.temperature;
                cardTitles[2].textContent = t.cell_info;
                cardTitles[3].textContent = t.cell_voltages;
                cardTitles[4].textContent = t.cell_resistances; // Sửa: Điện trở Cell
                cardTitles[5].textContent = t.esp32_control;    // Sửa: Điều khiển ESP32
                cardTitles[6].textContent = t.alerts;           // Sửa: Cảnh báo
            }
            
            // Main info units (corrected order)
            const units = document.querySelectorAll('.unit');
            if (units.length >= 6) {
                units[0].textContent = t.voltage;        // Điện áp (V)
                units[1].textContent = t.battery_percent; // Phần trăm pin (%)
                units[2].textContent = t.current;        // Dòng điện (A)
                units[3].textContent = t.power;         // Công suất (W)
                units[4].textContent = "Dung lượng hiện tại (Ah)"; // Dung lượng hiện tại
                units[5].textContent = "Dung lượng tối đa (Ah)";   // Dung lượng tối đa
            }
            
            // Temperature units (skip main info units)
            const tempUnits = document.querySelectorAll('.unit');
            if (tempUnits.length >= 10) {
                tempUnits[6].textContent = t.temp_sensor1;   // Nhiệt độ cảm biến 1
                tempUnits[7].textContent = t.temp_sensor2;   // Nhiệt độ cảm biến 2
                tempUnits[8].textContent = t.temp_mos;       // Nhiệt độ cảm biến MOS
            }
            
            // Cell info units (skip main info + temperature units)
            const cellUnits = document.querySelectorAll('.unit');
            if (cellUnits.length >= 15) {
                cellUnits[9].textContent = t.min_voltage;     // Điện áp thấp nhất
                cellUnits[10].textContent = t.max_voltage;   // Điện áp cao nhất
                cellUnits[11].textContent = t.avg_voltage;   // Điện áp trung bình
                cellUnits[12].textContent = t.delta_voltage; // Điện áp chênh lệch
            }
            
            // Resistance units (skip main info + temperature + cell voltage units)
            const resistanceUnits = document.querySelectorAll('.unit');
            if (resistanceUnits.length >= 17) {
                resistanceUnits[13].textContent = "Điện trở thấp nhất (mΩ)";
                resistanceUnits[14].textContent = "Điện trở cao nhất (mΩ)";
                resistanceUnits[15].textContent = "Điện trở trung bình (mΩ)";
                resistanceUnits[16].textContent = "Điện trở chênh lệch (mΩ)";
            }
            
            // Control buttons
            const controlButtons = document.querySelectorAll('.btn');
            // Update control buttons
            const emergencyText = document.getElementById('emergency-text');
            const recoverText = document.getElementById('recover-text');
            const setupText = document.getElementById('setup-text');
            const powerCycleText = document.getElementById('power-cycle-text');
            
            if (emergencyText) emergencyText.textContent = t.emergency_stop;
            if (recoverText) recoverText.textContent = t.recover_bms;
            if (setupText) setupText.textContent = t.setup_mode;
            if (powerCycleText) powerCycleText.textContent = t.power_cycle;
            
            // Update alerts title and no alerts text
            const alertsTitle = document.getElementById('alerts-title');
            const noAlertsText = document.getElementById('no-alerts-text');
            
            if (alertsTitle) alertsTitle.textContent = t.alerts;
            if (noAlertsText) noAlertsText.textContent = t.no_alerts;
            
            // Update device label
            const deviceLabel = document.getElementById('device-label');
            if (deviceLabel) deviceLabel.textContent = t.device;
            
            // Update capacity units
            const currentCapacityUnit = document.getElementById('current-capacity-unit');
            const totalCapacityUnit = document.getElementById('total-capacity-unit');
            if (currentCapacityUnit) currentCapacityUnit.textContent = t.current_capacity;
            if (totalCapacityUnit) totalCapacityUnit.textContent = t.total_capacity;
            
            // Update resistance units
            const minResistanceUnit = document.getElementById('min-resistance-unit');
            const maxResistanceUnit = document.getElementById('max-resistance-unit');
            const avgResistanceUnit = document.getElementById('avg-resistance-unit');
            const deltaResistanceUnit = document.getElementById('delta-resistance-unit');
            if (minResistanceUnit) minResistanceUnit.textContent = t.min_resistance;
            if (maxResistanceUnit) maxResistanceUnit.textContent = t.max_resistance;
            if (avgResistanceUnit) avgResistanceUnit.textContent = t.avg_resistance;
            if (deltaResistanceUnit) deltaResistanceUnit.textContent = t.delta_resistance;
            
            // Global password overlay
            const globalOverlay = document.getElementById('global-password-overlay');
            if (globalOverlay) {
                const overlayTitle = globalOverlay.querySelector('h2');
                if (overlayTitle) overlayTitle.textContent = t.global_password_title;
                
                const overlayMessage = globalOverlay.querySelector('p');
                if (overlayMessage) overlayMessage.textContent = t.global_password_message;
                
                const passwordInput = document.getElementById('global-password-input');
                if (passwordInput) passwordInput.placeholder = t.global_password_placeholder;
                
                const accessBtn = globalOverlay.querySelector('button');
                if (accessBtn) accessBtn.textContent = t.global_password_button;
            }
            
            // Settings lock
            const lockBox = document.getElementById('settings-lock');
            if (lockBox) {
                const lockTitle = lockBox.querySelector('h3');
                if (lockTitle) lockTitle.textContent = t.settings_password;
                
                const passwordInput = document.getElementById('settings-password');
                if (passwordInput) passwordInput.placeholder = t.password;
                
                const unlockBtn = lockBox.querySelector('.lock-btn');
                if (unlockBtn) unlockBtn.textContent = t.unlock;
            }
            
            // Settings sections
            const settingsSections = document.querySelectorAll('.settings-section h3');
            if (settingsSections.length >= 5) {
                settingsSections[0].textContent = t.voltage_settings;
                settingsSections[1].textContent = t.current_settings;
                settingsSections[2].textContent = t.time_settings;
                settingsSections[3].textContent = t.temp_settings;
                settingsSections[4].textContent = t.switch_settings;
            }
            
            // Save buttons
            const saveButtons = document.querySelectorAll('.btn-save');
            if (saveButtons.length >= 1) {
                saveButtons[0].textContent = t.save_all_settings;
            }
            
            // Settings labels and tooltips
            updateSettingsLabels(lang);
            
            // Update status messages
            updateStatusMessages(lang);
        }

        // Update settings labels and tooltips
        function updateSettingsLabels(lang) {
            const t = translations[lang];
            console.log('Updating settings labels for language:', lang);
            
            // Voltage settings
            updateLabelAndTooltip('cell-overvoltage', t.cell_overvoltage, t.cell_overvoltage_tooltip);
            updateLabelAndTooltip('cell-overvoltage-recovery', t.cell_overvoltage_recovery, t.cell_overvoltage_recovery_tooltip);
            updateLabelAndTooltip('cell-undervoltage', t.cell_undervoltage, t.cell_undervoltage_tooltip);
            updateLabelAndTooltip('cell-undervoltage-recovery', t.cell_undervoltage_recovery, t.cell_undervoltage_recovery_tooltip);
            updateLabelAndTooltip('balance-trigger-voltage', t.balance_trigger_voltage, t.balance_trigger_voltage_tooltip);
            updateLabelAndTooltip('balance-start-voltage', t.balance_start_voltage, t.balance_start_voltage_tooltip);
            updateLabelAndTooltip('cell-soc100-voltage', t.cell_soc100_voltage, t.cell_soc100_voltage_tooltip);
            updateLabelAndTooltip('cell-soc0-voltage', t.cell_soc0_voltage, t.cell_soc0_voltage_tooltip);
            updateLabelAndTooltip('cell-request-charge-voltage', t.cell_request_charge_voltage, t.cell_request_charge_voltage_tooltip);
            updateLabelAndTooltip('cell-request-float-voltage', t.cell_request_float_voltage, t.cell_request_float_voltage_tooltip);
            updateLabelAndTooltip('smart-sleep-voltage', t.smart_sleep_voltage, t.smart_sleep_voltage_tooltip);
            updateLabelAndTooltip('power-off-voltage', t.power_off_voltage, t.power_off_voltage_tooltip);
            updateLabelAndTooltip('cell-count', t.cell_count, t.cell_count_tooltip);
            updateLabelAndTooltip('capacity', t.capacity, t.capacity_tooltip);
            
            // Current settings
            updateLabelAndTooltip('max-balance-current', t.max_balance_current, t.max_balance_current_tooltip);
            updateLabelAndTooltip('charge-current', t.charge_current, t.charge_current_tooltip);
            updateLabelAndTooltip('discharge-current', t.discharge_current, t.discharge_current_tooltip);
            updateLabelAndTooltip('current-calibration', t.current_calibration, t.current_calibration_tooltip);
            
            // Time settings
            updateLabelAndTooltip('charge-ocp-delay-s', t.charge_ocp_delay_s, t.charge_ocp_delay_s_tooltip);
            updateLabelAndTooltip('charge-ocpr-time-s', t.charge_ocpr_time_s, t.charge_ocpr_time_s_tooltip);
            updateLabelAndTooltip('discharge-ocp-delay-s', t.discharge_ocp_delay_s, t.discharge_ocp_delay_s_tooltip);
            updateLabelAndTooltip('discharge-ocpr-time-s', t.discharge_ocpr_time_s, t.discharge_ocpr_time_s_tooltip);
            updateLabelAndTooltip('scp-delay-us', t.scp_delay_us, t.scp_delay_us_tooltip);
            updateLabelAndTooltip('scp-recovery-time-s', t.scp_recovery_time_s, t.scp_recovery_time_s_tooltip);
            updateLabelAndTooltip('request-charge-voltage-time-h', t.request_charge_voltage_time_h, t.request_charge_voltage_time_h_tooltip);
            updateLabelAndTooltip('request-float-voltage-time-h', t.request_float_voltage_time_h, t.request_float_voltage_time_h_tooltip);
            updateLabelAndTooltip('discharge-precharge-time-s', t.discharge_precharge_time_s, t.discharge_precharge_time_s_tooltip);
            updateLabelAndTooltip('voltage-calibration', t.voltage_calibration, t.voltage_calibration_tooltip);
            
            // Temperature settings
            updateLabelAndTooltip('charge-overtemp', t.charge_overtemp, t.charge_overtemp_tooltip);
            updateLabelAndTooltip('charge-overtemp-recovery', t.charge_overtemp_recovery, t.charge_overtemp_recovery_tooltip);
            updateLabelAndTooltip('discharge-overtemp', t.discharge_overtemp, t.discharge_overtemp_tooltip);
            updateLabelAndTooltip('discharge-overtemp-recovery', t.discharge_overtemp_recovery, t.discharge_overtemp_recovery_tooltip);
            updateLabelAndTooltip('charge-undertemp', t.charge_undertemp, t.charge_undertemp_tooltip);
            updateLabelAndTooltip('charge-undertemp-recovery', t.charge_undertemp_recovery, t.charge_undertemp_recovery_tooltip);
            updateLabelAndTooltip('mos-overtemp', t.mos_overtemp, t.mos_overtemp_tooltip);
            updateLabelAndTooltip('mos-overtemp-recovery', t.mos_overtemp_recovery, t.mos_overtemp_recovery_tooltip);
            
            // Switch settings
            updateSwitchLabelAndTooltip('charge-mosfet-on', t.charge_mosfet_on, t.charge_mosfet_on_tooltip);
            updateSwitchLabelAndTooltip('discharge-mosfet-on', t.discharge_mosfet_on, t.discharge_mosfet_on_tooltip);
            updateSwitchLabelAndTooltip('balancer-on', t.balancer_on, t.balancer_on_tooltip);
            updateSwitchLabelAndTooltip('heating-on', t.heating_on, t.heating_on_tooltip);
            updateSwitchLabelAndTooltip('disable-temperature-sensors', t.disable_temperature_sensors, t.disable_temperature_sensors_tooltip);
            updateSwitchLabelAndTooltip('display-always-on', t.display_always_on, t.display_always_on_tooltip);
            updateSwitchLabelAndTooltip('smart-sleep-on', t.smart_sleep_on, t.smart_sleep_on_tooltip);
            updateSwitchLabelAndTooltip('disable-pcl-module', t.disable_pcl_module, t.disable_pcl_module_tooltip);
            updateSwitchLabelAndTooltip('timed-stored-data', t.timed_stored_data, t.timed_stored_data_tooltip);
            updateSwitchLabelAndTooltip('charging-float-mode', t.charging_float_mode, t.charging_float_mode_tooltip);
            updateSwitchLabelAndTooltip('emergency-mode', t.emergency_mode, t.emergency_mode_tooltip);
            
            console.log('Settings labels update completed');
        }

        // Helper function to update label and tooltip for input fields
        function updateLabelAndTooltip(inputId, labelText, tooltipText) {
            const input = document.getElementById(inputId);
            if (input) {
                // Tìm label - có thể là previousElementSibling hoặc trong form-group
                let label = input.previousElementSibling;
                if (!label || !label.classList.contains('tooltip-container')) {
                    // Thử tìm trong form-group
                    const formGroup = input.closest('.form-group');
                    if (formGroup) {
                        label = formGroup.querySelector('label.tooltip-container');
                    }
                }
                
                if (label && label.classList.contains('tooltip-container')) {
                    // Update the label text by replacing the first text node
                    let updated = false;
                    for (let i = 0; i < label.childNodes.length; i++) {
                        const node = label.childNodes[i];
                        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                            node.textContent = labelText;
                            updated = true;
                            console.log('Updated label for', inputId, 'to:', labelText);
                            break;
                        }
                    }
                    
                    if (!updated) {
                        // Thử cách khác - tìm text node đầu tiên
                        const textNodes = [];
                        function findTextNodes(element) {
                            for (let i = 0; i < element.childNodes.length; i++) {
                                const node = element.childNodes[i];
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                    textNodes.push(node);
                                } else if (node.nodeType === Node.ELEMENT_NODE) {
                                    findTextNodes(node);
                                }
                            }
                        }
                        findTextNodes(label);
                        if (textNodes.length > 0) {
                            textNodes[0].textContent = labelText;
                            updated = true;
                            console.log('Updated label for', inputId, 'using alternative method');
                        }
                    }
                    
                    if (!updated) {
                        console.log('Could not find text node for', inputId);
                    }
                    
                    const tooltipElement = label.querySelector('.tooltip-text');
                    if (tooltipElement) {
                        tooltipElement.textContent = tooltipText;
                        console.log('Updated tooltip for', inputId);
                    } else {
                        console.log('No tooltip element found for', inputId);
                    }
                } else {
                    console.log('Label not found for', inputId);
                }
            } else {
                console.log('Input element not found:', inputId);
            }
        }

        // Helper function to update label and tooltip for switch fields
        function updateSwitchLabelAndTooltip(switchId, labelText, tooltipText) {
            const switchInput = document.getElementById(switchId);
            if (switchInput) {
                const switchContainer = switchInput.closest('.form-group');
                if (switchContainer) {
                    const label = switchContainer.querySelector('label.tooltip-container');
                    if (label) {
                        // Update the label text by replacing the first text node
                        let updated = false;
                        for (let i = 0; i < label.childNodes.length; i++) {
                            const node = label.childNodes[i];
                            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                node.textContent = labelText;
                                updated = true;
                                console.log('Updated switch label for', switchId, 'to:', labelText);
                                break;
                            }
                        }
                        
                        if (!updated) {
                            console.log('Could not find text node for switch', switchId);
                        }
                        
                        const tooltipElement = label.querySelector('.tooltip-text');
                        if (tooltipElement) {
                            tooltipElement.textContent = tooltipText;
                            console.log('Updated switch tooltip for', switchId);
                        } else {
                            console.log('No tooltip element found for switch', switchId);
                        }
                    } else {
                        console.log('Switch label not found for', switchId);
                    }
                } else {
                    console.log('Switch container not found for', switchId);
                }
            } else {
                console.log('Switch input element not found:', switchId);
            }
        }

        // Update status messages based on language
        function updateStatusMessages(lang) {
            const t = translations[lang];
            
            // Update connection status
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                if (connectionStatus.textContent.includes('Online')) {
                    connectionStatus.textContent = t.online;
                } else if (connectionStatus.textContent.includes('Offline')) {
                    connectionStatus.textContent = t.offline;
                }
            }
            
            // Update charge status
            const chargeStatus = document.getElementById('charge-status');
            if (chargeStatus) {
                if (chargeStatus.textContent.includes('Đang sạc') || chargeStatus.textContent.includes('Charging')) {
                    chargeStatus.textContent = t.charging;
                } else if (chargeStatus.textContent.includes('Đang xả') || chargeStatus.textContent.includes('Discharging')) {
                    chargeStatus.textContent = t.discharging;
                } else {
                    chargeStatus.textContent = t.not_charging_status;
                }
            }
            
            // Update balance status
            const balanceStatus = document.getElementById('balance-status');
            if (balanceStatus) {
                if (balanceStatus.textContent.includes('Đang cân bằng') || balanceStatus.textContent.includes('Balancing')) {
                    balanceStatus.textContent = t.balancing;
                } else {
                    balanceStatus.textContent = t.not_balancing_status;
                }
            }
            
            // Update alerts
            const alertsContainer = document.getElementById('alerts');
            if (alertsContainer && alertsContainer.textContent.includes('Không có cảnh báo') || alertsContainer.textContent.includes('No alerts')) {
                alertsContainer.innerHTML = `<div class="alert">${t.no_alerts}</div>`;
            }
        }

        // Khởi động lại nguồn (ngắt 5s rồi bật lại)
        function powerCycleDevice() {
            const currentLang = document.getElementById('language-selector').value;
            const t = translations[currentLang];
            const confirmMsg = currentLang === 'vi' 
                ? 'Bạn có chắc muốn khởi động lại nguồn (5s) cho ESP32?\n\nThiết bị sẽ tạm ngắt nguồn 5 giây rồi bật lại.'
                : 'Are you sure you want to power cycle (5s) the ESP32?\n\nThe device will temporarily power off for 5 seconds then restart.';
                
            if (confirm(confirmMsg)) {
                if (mqttClient && mqttClient.connected) {
                    const topic = `bms/${selectedDeviceId}/cmd/action`;
                    mqttClient.publish(topic, 'power_cycle', { qos: 1 });
                    const successMsg = currentLang === 'vi' 
                        ? 'Đã gửi lệnh khởi động lại nguồn (5s) qua MQTT'
                        : 'Power cycle command sent via MQTT';
                    showAlert(successMsg, 'success');
                    } else {
                    const errorMsg = currentLang === 'vi' 
                        ? 'MQTT chưa kết nối'
                        : 'MQTT not connected';
                    showAlert(errorMsg, 'error');
                    }
            }
        }
    </script>
</body>
</html>
